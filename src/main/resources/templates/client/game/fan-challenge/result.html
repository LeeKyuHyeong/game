<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ê²°ê³¼ - ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<link rel="stylesheet" th:href="@{/css/client/game-fan-challenge.css}">
<body class="client-page result-page">

<!-- ë°±ì—… ëª¨ë“œ: sessionStorage ë°ì´í„° ì‚¬ìš© -->
<div th:if="${useBackup}" id="backupResultContainer" class="result-container fan-challenge-result">
    <header class="result-header">
        <div class="header-top">
            <span id="backupDifficultyBadge" class="difficulty-badge">
                <span id="backupDifficultyEmoji"></span>
                <span id="backupDifficultyName"></span>
            </span>
            <span id="backupModeLabel" class="mode-label"></span>
        </div>
        <h1 id="backupTitle">ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€</h1>
    </header>

    <main class="result-main">
        <div class="result-summary">
            <div id="backupPerfectBadge" class="perfect-clear-badge" style="display: none;">
                <span id="backupPerfectEmoji" class="badge-icon"></span>
                <span class="badge-text">PERFECT CLEAR!</span>
            </div>

            <div class="score-display">
                <span id="backupCorrectCount" class="score-value">0</span>
                <span class="score-separator">/</span>
                <span id="backupTotalRounds" class="score-total">0</span>
                <span class="score-label">ê³¡ ì •ë‹µ</span>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-label">ì •ë‹µë¥ </span>
                    <span id="backupAccuracy" class="stat-value">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì†Œìš” ì‹œê°„</span>
                    <span id="backupPlayTime" class="stat-value">0ì´ˆ</span>
                </div>
            </div>
        </div>

        <div id="backupPracticeNotice" class="practice-notice" style="display: none;">
            <div class="notice-content">
                <span class="notice-icon">ğŸ’¡</span>
                <p>ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ë­í‚¹ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <p><strong>í•˜ë“œì½”ì–´ ëª¨ë“œ</strong>ë¡œ ë„ì „í•˜ì—¬ ê³µì‹ ë­í‚¹ì— ì´ë¦„ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a th:href="@{/game/fan-challenge}" class="btn btn-replay">ë‹¤ì‹œ ë„ì „</a>
        <a th:href="@{/}" class="btn btn-home">í™ˆìœ¼ë¡œ</a>
    </footer>
</div>

<script th:if="${useBackup}">
(function() {
    const data = sessionStorage.getItem('fanChallengeResult');
    if (!data) {
        window.location.href = '/game/fan-challenge';
        return;
    }

    const result = JSON.parse(data);
    sessionStorage.removeItem('fanChallengeResult');

    document.getElementById('backupDifficultyBadge').dataset.difficulty = result.difficulty;
    document.getElementById('backupDifficultyEmoji').textContent = result.difficultyEmoji;
    document.getElementById('backupDifficultyName').textContent = result.difficultyName;
    document.getElementById('backupTitle').textContent = result.artist + ' ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€';
    document.getElementById('backupCorrectCount').textContent = result.correctCount;
    document.getElementById('backupTotalRounds').textContent = result.totalRounds;

    const accuracy = ((result.correctCount / result.totalRounds) * 100).toFixed(1) + '%';
    document.getElementById('backupAccuracy').textContent = accuracy;
    document.getElementById('backupPlayTime').textContent = result.playTimeSeconds + 'ì´ˆ';

    if (result.isRanked) {
        document.getElementById('backupModeLabel').textContent = 'ê³µì‹ ë­í‚¹';
        document.getElementById('backupModeLabel').classList.add('ranked');
    } else {
        document.getElementById('backupModeLabel').textContent = 'ì—°ìŠµ ëª¨ë“œ';
        document.getElementById('backupModeLabel').classList.add('practice');
        document.getElementById('backupPracticeNotice').style.display = 'block';
    }

    if (result.isPerfectClear) {
        document.getElementById('backupPerfectBadge').style.display = 'block';
        document.getElementById('backupPerfectBadge').dataset.difficulty = result.difficulty;
        document.getElementById('backupPerfectEmoji').textContent = result.difficultyEmoji;
    }
})();
</script>

<!-- ì •ìƒ ëª¨ë“œ: ì„œë²„ ì„¸ì…˜ ë°ì´í„° ì‚¬ìš© -->
<div th:if="${!useBackup}" class="result-container fan-challenge-result">
    <header class="result-header">
        <div class="header-top">
            <span class="difficulty-badge" th:data-difficulty="${difficulty}">
                <span th:text="${difficultyEmoji}">â­</span>
                <span th:text="${difficultyName}">ì¼ë°˜</span>
            </span>
            <span th:if="${!isRanked}" class="mode-label practice">ì—°ìŠµ ëª¨ë“œ</span>
            <span th:if="${isRanked}" class="mode-label ranked">ê³µì‹ ë­í‚¹</span>
        </div>
        <h1 th:text="${artist + ' ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€'}">ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€</h1>
    </header>

    <main class="result-main">
        <!-- ê²°ê³¼ ìš”ì•½ -->
        <div class="result-summary">
            <div th:if="${isPerfectClear}" class="perfect-clear-badge" th:data-difficulty="${difficulty}">
                <span class="badge-icon" th:text="${difficultyEmoji}">ğŸŒŸ</span>
                <span class="badge-text">PERFECT CLEAR!</span>
            </div>

            <div class="score-display">
                <span class="score-value" th:text="${correctCount}">0</span>
                <span class="score-separator">/</span>
                <span class="score-total" th:text="${totalRounds}">0</span>
                <span class="score-label">ê³¡ ì •ë‹µ</span>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-label">ì •ë‹µë¥ </span>
                    <span class="stat-value"
                          th:text="${#numbers.formatDecimal(correctCount * 100.0 / totalRounds, 0, 1) + '%'}">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì†Œìš” ì‹œê°„</span>
                    <span class="stat-value" th:text="${playTimeSeconds + 'ì´ˆ'}">0ì´ˆ</span>
                </div>
            </div>
        </div>

        <!-- í¼í™íŠ¸ í´ë¦¬ì–´ ë±ƒì§€ ì»¬ë ‰ì…˜ -->
        <div th:if="${perfectBadges != null && !#lists.isEmpty(perfectBadges)}" class="badges-section">
            <h2><span th:text="${artist}">ì•„í‹°ìŠ¤íŠ¸</span> í¼í™íŠ¸ ë±ƒì§€</h2>
            <div class="badges-collection">
                <div th:each="badge : ${perfectBadges}" class="badge-item" th:data-difficulty="${badge.difficulty}">
                    <span class="badge-emoji" th:text="${badge.emoji}">â­</span>
                    <span class="badge-name" th:text="${badge.difficultyName}">ì¼ë°˜</span>
                </div>
                <!-- ë¯¸íšë“ ë±ƒì§€ í‘œì‹œ (íšŒìƒ‰) -->
                <div th:if="${!hasBadgeBeginner}" class="badge-item locked" data-difficulty="BEGINNER">
                    <span class="badge-emoji">ğŸŒ±</span>
                    <span class="badge-name">ì…ë¬¸</span>
                </div>
                <div th:if="${!hasBadgeNormal}" class="badge-item locked" data-difficulty="NORMAL">
                    <span class="badge-emoji">â­</span>
                    <span class="badge-name">ì¼ë°˜</span>
                </div>
                <div th:if="${!hasBadgeHardcore}" class="badge-item locked" data-difficulty="HARDCORE">
                    <span class="badge-emoji">ğŸ”¥</span>
                    <span class="badge-name">í•˜ë“œì½”ì–´</span>
                </div>
            </div>
        </div>

        <!-- ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹ (í•˜ë“œì½”ì–´ë§Œ í‘œì‹œ) -->
        <div th:if="${isRanked}" class="ranking-section">
            <h2>
                <span class="ranking-icon">ğŸ†</span>
                <span th:text="${artist}">ì•„í‹°ìŠ¤íŠ¸</span> ê³µì‹ ë­í‚¹
            </h2>

            <div th:if="${myRecord != null}" class="my-record">
                <div class="my-record-label">ë‚´ ìµœê³  ê¸°ë¡</div>
                <div class="my-record-value">
                    <span th:text="${myRecord.correctCount + '/' + myRecord.totalSongs + 'ê³¡'}">0/0ê³¡</span>
                    <span th:if="${myRecord.isPerfectClear}" class="perfect-badge">PERFECT</span>
                </div>
            </div>

            <div class="ranking-list">
                <div th:if="${#lists.isEmpty(ranking)}" class="no-ranking">
                    ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”!
                </div>

                <div th:each="record, iter : ${ranking}" class="ranking-item"
                     th:classappend="${myRecord != null && record.member.id == myRecord.member.id} ? 'my-rank' : ''">
                    <span class="rank" th:text="${iter.index + 1}">1</span>
                    <span class="nickname" th:text="${record.member.nickname}">ë‹‰ë„¤ì„</span>
                    <span class="record-value">
                        <span th:text="${record.correctCount + '/' + record.totalSongs}">0/0</span>
                        <span th:if="${record.isPerfectClear}" class="perfect-badge">PERFECT</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- ì—°ìŠµ ëª¨ë“œì¼ ë•Œ í•˜ë“œì½”ì–´ ë„ì „ ìœ ë„ -->
        <div th:if="${!isRanked}" class="practice-notice">
            <div class="notice-content">
                <span class="notice-icon">ğŸ’¡</span>
                <p>ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ë­í‚¹ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <p><strong>í•˜ë“œì½”ì–´ ëª¨ë“œ</strong>ë¡œ ë„ì „í•˜ì—¬ ê³µì‹ ë­í‚¹ì— ì´ë¦„ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</p>
            </div>
            <a th:href="@{/game/fan-challenge(artist=${artist}, difficulty='HARDCORE')}" class="btn btn-hardcore">
                ğŸ”¥ í•˜ë“œì½”ì–´ ë„ì „í•˜ê¸°
            </a>
        </div>

        <!-- ë¼ìš´ë“œë³„ ê¸°ë¡ -->
        <div class="rounds-section">
            <h2>ë¼ìš´ë“œë³„ ê¸°ë¡</h2>
            <div class="rounds-grid">
                <div th:each="round : ${session.rounds}" class="round-card"
                     th:classappend="${round.isCorrect()} ? 'correct' : 'wrong'">
                    <div class="round-number" th:text="'#' + ${round.roundNumber}">1</div>
                    <div class="round-song" th:text="${round.song.title}">ë…¸ë˜ ì œëª©</div>
                    <div class="round-result">
                        <span th:if="${round.isCorrect()}" class="result-correct">O</span>
                        <span th:if="${!round.isCorrect() && round.status.name() == 'TIMEOUT'}" class="result-timeout">ì‹œê°„ì´ˆê³¼</span>
                        <span th:if="${!round.isCorrect() && round.status.name() != 'TIMEOUT'}" class="result-wrong">X</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a th:href="@{/game/fan-challenge}" class="btn btn-replay">ë‹¤ì‹œ ë„ì „</a>
        <a th:href="@{/}" class="btn btn-home">í™ˆìœ¼ë¡œ</a>
    </footer>
</div>

<!-- PC ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ì§€ì› -->
<script th:src="@{/js/common/drag-scroll.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const badgesCollection = document.querySelector('.badges-collection');
        if (badgesCollection) {
            enableDragScroll(badgesCollection);
        }
    });
</script>
</body>
</html>
