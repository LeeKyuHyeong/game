<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ê²°ê³¼ - ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<link rel="stylesheet" th:href="@{/css/client/game-fan-challenge.css}">
<body class="client-page result-page">

<!-- ë°±ì—… ëª¨ë“œ: sessionStorage ë°ì´í„° ì‚¬ìš© -->
<div th:if="${useBackup}" id="backupResultContainer" class="result-container fan-challenge-result">
    <header class="result-header">
        <div class="header-top">
            <span id="backupDifficultyBadge" class="difficulty-badge">
                <span id="backupDifficultyEmoji"></span>
                <span id="backupDifficultyName"></span>
            </span>
            <span id="backupModeLabel" class="mode-label"></span>
        </div>
        <h1 id="backupTitle">ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€</h1>
    </header>

    <main class="result-main">
        <div class="result-summary">
            <div id="backupPerfectBadge" class="perfect-clear-badge" style="display: none;">
                <span id="backupPerfectEmoji" class="badge-icon"></span>
                <span class="badge-text">PERFECT CLEAR!</span>
            </div>

            <div class="score-display">
                <span id="backupCorrectCount" class="score-value">0</span>
                <span class="score-separator">/</span>
                <span id="backupTotalRounds" class="score-total">0</span>
                <span class="score-label">ê³¡ ì •ë‹µ</span>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-label">ì •ë‹µë¥ </span>
                    <span id="backupAccuracy" class="stat-value">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì†Œìš” ì‹œê°„</span>
                    <span id="backupPlayTime" class="stat-value">0ì´ˆ</span>
                </div>
            </div>
        </div>

        <div id="backupPracticeNotice" class="practice-notice" style="display: none;">
            <div class="notice-content">
                <span class="notice-icon">ğŸ’¡</span>
                <p>ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ë­í‚¹ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <p><strong>í•˜ë“œì½”ì–´ ëª¨ë“œ</strong>ë¡œ ë„ì „í•˜ì—¬ ê³µì‹ ë­í‚¹ì— ì´ë¦„ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a th:href="@{/game/fan-challenge}" class="btn btn-replay">ë‹¤ì‹œ ë„ì „</a>
        <a th:href="@{/}" class="btn btn-home">í™ˆìœ¼ë¡œ</a>
    </footer>
</div>

<script th:if="${useBackup}">
(function() {
    const data = sessionStorage.getItem('fanChallengeResult');
    if (!data) {
        window.location.href = '/game/fan-challenge';
        return;
    }

    const result = JSON.parse(data);
    sessionStorage.removeItem('fanChallengeResult');

    document.getElementById('backupDifficultyBadge').dataset.difficulty = result.difficulty;
    document.getElementById('backupDifficultyEmoji').textContent = result.difficultyEmoji;
    document.getElementById('backupDifficultyName').textContent = result.difficultyName;
    document.getElementById('backupTitle').textContent = result.artist + ' ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€';
    document.getElementById('backupCorrectCount').textContent = result.correctCount;
    document.getElementById('backupTotalRounds').textContent = result.totalRounds;

    const accuracy = ((result.correctCount / result.totalRounds) * 100).toFixed(1) + '%';
    document.getElementById('backupAccuracy').textContent = accuracy;
    document.getElementById('backupPlayTime').textContent = result.playTimeSeconds + 'ì´ˆ';

    if (result.isRanked) {
        document.getElementById('backupModeLabel').textContent = 'ê³µì‹ ë­í‚¹';
        document.getElementById('backupModeLabel').classList.add('ranked');
    } else {
        document.getElementById('backupModeLabel').textContent = 'ì—°ìŠµ ëª¨ë“œ';
        document.getElementById('backupModeLabel').classList.add('practice');
        document.getElementById('backupPracticeNotice').style.display = 'block';
    }

    if (result.isPerfectClear) {
        document.getElementById('backupPerfectBadge').style.display = 'block';
        document.getElementById('backupPerfectBadge').dataset.difficulty = result.difficulty;
        document.getElementById('backupPerfectEmoji').textContent = result.difficultyEmoji;
    }
})();
</script>

<!-- ì •ìƒ ëª¨ë“œ: ì„œë²„ ì„¸ì…˜ ë°ì´í„° ì‚¬ìš© -->
<div th:if="${!useBackup}" class="result-container fan-challenge-result">
    <header class="result-header">
        <div class="header-top">
            <span class="difficulty-badge" th:data-difficulty="${difficulty}">
                <span th:text="${difficultyEmoji}">â­</span>
                <span th:text="${difficultyName}">ì¼ë°˜</span>
            </span>
            <span th:if="${!isRanked}" class="mode-label practice">ì—°ìŠµ ëª¨ë“œ</span>
            <span th:if="${isRanked}" class="mode-label ranked">ê³µì‹ ë­í‚¹</span>
        </div>
        <h1 th:text="${artist + ' ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€'}">ì•„í‹°ìŠ¤íŠ¸ ì±Œë¦°ì§€</h1>
    </header>

    <main class="result-main">
        <!-- ê²°ê³¼ ìš”ì•½ -->
        <div class="result-summary">
            <div th:if="${isPerfectClear}" class="perfect-clear-badge" th:data-difficulty="${difficulty}">
                <span class="badge-icon" th:text="${difficultyEmoji}">ğŸŒŸ</span>
                <span class="badge-text">PERFECT CLEAR!</span>
            </div>

            <div class="score-display">
                <span class="score-value" th:text="${correctCount}">0</span>
                <span class="score-separator">/</span>
                <span class="score-total" th:text="${totalRounds}">0</span>
                <span class="score-label">ê³¡ ì •ë‹µ</span>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-label">ì •ë‹µë¥ </span>
                    <span class="stat-value"
                          th:text="${#numbers.formatDecimal(correctCount * 100.0 / totalRounds, 0, 1) + '%'}">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì†Œìš” ì‹œê°„</span>
                    <span class="stat-value" th:text="${playTimeSeconds + 'ì´ˆ'}">0ì´ˆ</span>
                </div>
            </div>
        </div>

        <!-- í¼í™íŠ¸ í´ë¦¬ì–´ ë±ƒì§€ ì»¬ë ‰ì…˜ -->
        <div th:if="${perfectBadges != null && !#lists.isEmpty(perfectBadges)}" class="badges-section">
            <h2><span th:text="${artist}">ì•„í‹°ìŠ¤íŠ¸</span> í¼í™íŠ¸ ë±ƒì§€</h2>
            <div class="badges-collection">
                <div th:each="badge : ${perfectBadges}" class="badge-item" th:data-difficulty="${badge.difficulty}">
                    <span class="badge-emoji" th:text="${badge.emoji}">â­</span>
                    <span class="badge-name" th:text="${badge.difficultyName}">ì¼ë°˜</span>
                </div>
                <!-- ë¯¸íšë“ ë±ƒì§€ í‘œì‹œ (íšŒìƒ‰) -->
                <div th:if="${!hasBadgeNormal}" class="badge-item locked" data-difficulty="NORMAL">
                    <span class="badge-emoji">â­</span>
                    <span class="badge-name">ë…¸ë§</span>
                </div>
                <div th:if="${!hasBadgeHardcore}" class="badge-item locked" data-difficulty="HARDCORE">
                    <span class="badge-emoji">ğŸ”¥</span>
                    <span class="badge-name">í•˜ë“œì½”ì–´</span>
                </div>
            </div>
        </div>

        <!-- ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹ (í•˜ë“œì½”ì–´ë§Œ í‘œì‹œ) -->
        <div th:if="${isRanked}" class="ranking-section">
            <div class="ranking-header">
                <h2>
                    <span class="ranking-icon">ğŸ†</span>
                    <span th:text="${artist}">ì•„í‹°ìŠ¤íŠ¸</span> ê³µì‹ ë­í‚¹
                </h2>
                <p class="ranking-subtitle">ì •ë‹µ ìˆ˜ê°€ ê°™ìœ¼ë©´ í´ë¦¬ì–´ ì‹œê°„ì´ ë¹ ë¥¸ ìˆœ</p>
            </div>

            <div th:if="${myRecord != null}" class="my-record">
                <div class="my-record-label">ë‚´ ìµœê³  ê¸°ë¡</div>
                <div class="my-record-value">
                    <span th:text="${myRecord.correctCount + '/' + myRecord.totalSongs + 'ê³¡'}">0/0ê³¡</span>
                    <span th:if="${myRecord.bestTimeMs != null}" class="record-time"
                          th:text="${#numbers.formatDecimal(myRecord.bestTimeMs / 1000.0, 0, 1) + 'ì´ˆ'}">0.0ì´ˆ</span>
                    <span th:if="${myRecord.isPerfectClear}" class="perfect-badge">PERFECT</span>
                </div>
            </div>

            <div class="ranking-list">
                <div th:if="${#lists.isEmpty(ranking)}" class="no-ranking">
                    ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”!
                </div>

                <div th:each="record, iter : ${ranking}" class="ranking-item"
                     th:classappend="${myRecord != null && record.member.id == myRecord.member.id} ? 'my-rank' : ''">
                    <span class="rank" th:text="${iter.index + 1}">1</span>
                    <span class="nickname" th:text="${record.member.nickname}">ë‹‰ë„¤ì„</span>
                    <span class="record-value">
                        <span th:text="${record.correctCount + '/' + record.totalSongs}">0/0</span>
                        <span th:if="${record.bestTimeMs != null}" class="record-time"
                              th:text="${#numbers.formatDecimal(record.bestTimeMs / 1000.0, 0, 1) + 'ì´ˆ'}">0.0ì´ˆ</span>
                        <span th:if="${record.isPerfectClear}" class="perfect-badge">PERFECT</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- ì—°ìŠµ ëª¨ë“œì¼ ë•Œ í•˜ë“œì½”ì–´ ë„ì „ ìœ ë„ -->
        <div th:if="${!isRanked}" class="practice-notice">
            <div class="notice-content">
                <span class="notice-icon">ğŸ’¡</span>
                <p>ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ë­í‚¹ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <p><strong>í•˜ë“œì½”ì–´ ëª¨ë“œ</strong>ë¡œ ë„ì „í•˜ì—¬ ê³µì‹ ë­í‚¹ì— ì´ë¦„ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</p>
            </div>
            <a th:href="@{/game/fan-challenge(artist=${artist}, difficulty='HARDCORE')}" class="btn btn-hardcore">
                ğŸ”¥ í•˜ë“œì½”ì–´ ë„ì „í•˜ê¸°
            </a>
        </div>

        <!-- ë¼ìš´ë“œë³„ ê¸°ë¡ (ì§„í–‰í•œ ë¼ìš´ë“œë§Œ) -->
        <div th:if="${rounds != null && !rounds.isEmpty()}" class="rounds-section">
            <h2>ë¼ìš´ë“œë³„ ê¸°ë¡</h2>
            <div class="rounds-grid">
                <th:block th:each="round : ${rounds}">
                    <!-- WAITING ìƒíƒœê°€ ì•„ë‹Œ ë¼ìš´ë“œë§Œ í‘œì‹œ -->
                    <div th:if="${round.status.name() != 'WAITING'}" class="round-card"
                         th:classappend="${round.isCorrect()} ? 'correct' : 'wrong'">
                        <!-- ê²°ê³¼ ë±ƒì§€ (ëª¨ë°”ì¼: ì¢Œì¸¡, PC: ìš°ìƒë‹¨) -->
                        <div class="round-badge">
                            <span th:if="${round.isCorrect()}" class="badge-icon correct">âœ“</span>
                            <span th:if="${!round.isCorrect() && round.status.name() == 'TIMEOUT'}" class="badge-icon timeout">â±</span>
                            <span th:if="${!round.isCorrect() && round.status.name() != 'TIMEOUT'}" class="badge-icon wrong">âœ—</span>
                            <span class="round-number" th:text="'#' + ${round.roundNumber}">#1</span>
                        </div>
                        <!-- 2ì»¬ëŸ¼ ë¹„êµ ì˜ì—­ -->
                        <div class="round-compare">
                            <div class="compare-column correct-col">
                                <span class="column-label">ì •ë‹µ</span>
                                <span class="column-value" th:text="${round.song != null ? round.song.title : 'ì•Œ ìˆ˜ ì—†ìŒ'}">ì •ë‹µ</span>
                            </div>
                            <div th:if="${!round.isCorrect() && round.userAnswer != null && !round.userAnswer.isEmpty()}" class="compare-column user-col">
                                <span class="column-label">ë‚´ ë‹µ</span>
                                <span class="column-value" th:text="${round.userAnswer}">ì…ë ¥í•œ ë‹µ</span>
                            </div>
                        </div>
                        <!-- ê³¡ ì¸ê¸°ë„ í‰ê°€ -->
                        <div th:if="${round.song != null}" class="popularity-vote-section"
                             th:data-song-id="${round.song.id}">
                            <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
                            <div th:if="${!isLoggedIn}" class="vote-login-prompt">
                                <a th:href="@{/auth/login}" class="login-link">ë¡œê·¸ì¸í•˜ì—¬ í‰ê°€í•˜ê¸°</a>
                            </div>
                            <!-- ë¡œê·¸ì¸ ìƒíƒœ - ì´ë¯¸ í‰ê°€í•œ ê²½ìš° -->
                            <div th:if="${isLoggedIn && existingVotes != null && existingVotes.containsKey(round.song.id)}"
                                 class="vote-display"
                                 th:data-rating="${existingVotes.get(round.song.id)}">
                                <span class="vote-label">ë‚´ í‰ê°€:</span>
                                <span class="vote-stars">
                                    <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                        <span th:if="${i <= existingVotes.get(round.song.id)}" class="star filled">â˜…</span>
                                        <span th:if="${i > existingVotes.get(round.song.id)}" class="star empty">â˜†</span>
                                    </th:block>
                                </span>
                                <span class="vote-rating-label"
                                      th:text="${existingVotes.get(round.song.id) == 1 ? 'ë§¤ìš° ëŒ€ì¤‘ì ' : (existingVotes.get(round.song.id) == 2 ? 'ëŒ€ì¤‘ì ' : (existingVotes.get(round.song.id) == 3 ? 'ë³´í†µ' : (existingVotes.get(round.song.id) == 4 ? 'ë§¤ë‹ˆì•…' : 'ë§¤ìš° ë§¤ë‹ˆì•…')))}">
                                    ë³´í†µ
                                </span>
                            </div>
                            <!-- ë¡œê·¸ì¸ ìƒíƒœ - ì•„ì§ í‰ê°€ ì•ˆ í•œ ê²½ìš° -->
                            <div th:if="${isLoggedIn && (existingVotes == null || !existingVotes.containsKey(round.song.id))}"
                                 class="vote-buttons">
                                <span class="vote-prompt">ì¸ê¸°ë„ í‰ê°€:</span>
                                <div class="vote-btn-group">
                                    <button type="button" class="vote-btn" data-rating="1" title="ë§¤ìš° ëŒ€ì¤‘ì ">1</button>
                                    <button type="button" class="vote-btn" data-rating="2" title="ëŒ€ì¤‘ì ">2</button>
                                    <button type="button" class="vote-btn" data-rating="3" title="ë³´í†µ">3</button>
                                    <button type="button" class="vote-btn" data-rating="4" title="ë§¤ë‹ˆì•…">4</button>
                                    <button type="button" class="vote-btn" data-rating="5" title="ë§¤ìš° ë§¤ë‹ˆì•…">5</button>
                                </div>
                                <div class="vote-scale-labels">
                                    <span>ëŒ€ì¤‘ì </span>
                                    <span>ë§¤ë‹ˆì•…</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
        <div th:if="${rounds == null || rounds.isEmpty()}" class="rounds-section">
            <h2>ë¼ìš´ë“œë³„ ê¸°ë¡</h2>
            <div class="no-rounds">
                <p>ë¼ìš´ë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a th:href="@{/game/fan-challenge}" class="btn btn-replay">ë‹¤ì‹œ ë„ì „</a>
        <a th:href="@{/}" class="btn btn-home">í™ˆìœ¼ë¡œ</a>
    </footer>
</div>

<!-- PC ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ì§€ì› -->
<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/common/drag-scroll.js}"></script>
<script th:src="@{/js/client/game-fan-challenge-result.js}"></script>
</body>
</html>
