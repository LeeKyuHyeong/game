<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ê²Œì„ ê²°ê³¼ - Song Quiz')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<body class="client-page result-page">
<div class="result-container">
    <!-- ì±Œë¦°ì§€ ì™„ë£Œ ë°°ë„ˆ (JSì—ì„œ ì œì–´) -->
    <div class="challenge-complete-banner" id="challengeCompleteBanner" style="display: none;">
        <div class="challenge-complete-content">
            <div class="challenge-icon-large">ğŸ†</div>
            <h2>30ê°œ ì±Œë¦°ì§€ ì™„ë£Œ!</h2>
            <p>ê¸°ë¡ì´ ë­í‚¹ì— ë°˜ì˜ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <header class="result-header">
        <h1>ğŸ† ê²Œì„ ê²°ê³¼</h1>
        <p th:text="${nickname}"></p>
    </header>

    <main class="result-main">
        <!-- ì ìˆ˜ ì„¹ì…˜ -->
        <div class="score-section">
            <div class="final-score">
                <span class="score-label">ìµœì¢… ì ìˆ˜</span>
                <span class="score-value" th:text="${gameSession.totalScore}">0</span>
            </div>
        </div>

        <!-- í†µê³„ ë°” - í•œ ì¤„ -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">ì •ë‹µ</span>
                <span class="stat-value correct" th:text="${gameSession.correctCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ì˜¤ë‹µ</span>
                <span class="stat-value wrong" th:text="${gameSession.completedRounds - gameSession.correctCount - gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ìŠ¤í‚µ</span>
                <span class="stat-value skip" th:text="${gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ì •ë‹µë¥ </span>
                <span class="stat-value" th:text="${#numbers.formatDecimal(gameSession.accuracyRate, 1, 1) + '%'}">0%</span>
            </div>
        </div>

        <!-- ë¼ìš´ë“œ ê¸°ë¡ - ì¹´ë“œ ê·¸ë¦¬ë“œ -->
        <div class="rounds-section">
            <h3>ë¼ìš´ë“œ ê¸°ë¡</h3>
            <div class="rounds-grid">
                <div th:each="round : ${rounds}" class="round-card"
                     th:classappend="${round.isCorrect ? 'correct' : (round.status.name() == 'SKIPPED' ? 'skipped' : 'wrong')}">
                    <div class="round-header">
                        <span class="round-num" th:text="'#' + ${round.roundNumber}"></span>
                        <span th:if="${round.isCorrect}" class="round-status correct">ì •ë‹µ</span>
                        <span th:if="${round.status.name() == 'SKIPPED'}" class="round-status skip">ìŠ¤í‚µ</span>
                        <span th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="round-status wrong">ì˜¤ë‹µ</span>
                    </div>
                    <div class="round-body">
                        <div class="song-info">
                            <div class="song-title" th:text="${round.song.title}"></div>
                            <div class="song-artist" th:text="${round.song.artist}"></div>
                        </div>
                        <div th:if="${round.isCorrect}" class="score-info">
                            <span class="score-plus" th:text="'+' + ${round.score} + 'ì '"></span>
                            <span th:if="${round.answerTimeMs != null}" class="attempt-info" th:text="'(' + ${#numbers.formatDecimal(round.answerTimeMs / 1000.0, 1, 1)} + 'ì´ˆ)'"></span>
                        </div>
                        <div th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="fail-info">
                            <span class="fail-text">3íšŒ ì‹¤íŒ¨</span>
                        </div>
                        <!-- ì‹œë„ ë‚´ì—­ í‘œì‹œ (ì˜¤ë‹µ/ì •ë‹µ ëª¨ë‘) -->
                        <div th:if="${round.attempts != null && !round.attempts.isEmpty()}" class="attempts-section">
                            <div class="attempts-label">ë‚´ ë‹µë³€:</div>
                            <div class="attempts-list">
                                <div th:each="attempt : ${round.attempts}" class="attempt-item"
                                     th:classappend="${attempt.isCorrect} ? 'correct' : 'wrong'">
                                    <span class="attempt-num" th:text="${attempt.attemptNumber} + 'ì°¨'"></span>
                                    <span class="attempt-answer" th:text="${attempt.userAnswer}"></span>
                                    <span th:if="${attempt.isCorrect}" class="attempt-result correct">O</span>
                                    <span th:if="${!attempt.isCorrect}" class="attempt-result wrong">X</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-report-small" th:data-song-id="${round.song.id}" onclick="openReportModal(this.dataset.songId)">ì‹ ê³ </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a href="/game/solo/guess" class="btn btn-replay">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</a>
        <a href="/ranking" class="btn btn-ranking" id="rankingBtn" style="display: none;">ë­í‚¹ ë³´ê¸° ğŸ†</a>
        <a href="/" class="btn btn-home">í™ˆìœ¼ë¡œ ğŸ </a>
    </footer>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script>
    // ì±Œë¦°ì§€ ëª¨ë“œ ì™„ë£Œ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function() {
        const isChallengeMode = sessionStorage.getItem('challengeMode') === 'true';

        if (isChallengeMode) {
            // ì±Œë¦°ì§€ ì™„ë£Œ ë°°ë„ˆ í‘œì‹œ
            const banner = document.getElementById('challengeCompleteBanner');
            if (banner) {
                banner.style.display = 'block';
            }

            // ë­í‚¹ ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
            const rankingBtn = document.getElementById('rankingBtn');
            if (rankingBtn) {
                rankingBtn.style.display = 'inline-flex';
            }

            // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
            sessionStorage.removeItem('challengeMode');
        }
    });
</script>

<!-- ì‹ ê³  ëª¨ë‹¬ -->
<th:block th:replace="~{common/fragments/report-modal :: reportModal}"></th:block>

<style>
/* ì±Œë¦°ì§€ ì™„ë£Œ ë°°ë„ˆ */
.challenge-complete-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    text-align: center;
    border-radius: 16px;
    margin-bottom: 20px;
    animation: celebrationPulse 2s ease-in-out infinite;
}

@keyframes celebrationPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
    50% { box-shadow: 0 4px 30px rgba(102, 126, 234, 0.7); }
}

.challenge-complete-content .challenge-icon-large {
    font-size: 3.5rem;
    margin-bottom: 8px;
}

.challenge-complete-content h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 4px 0;
}

.challenge-complete-content p {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0;
}

/* ë­í‚¹ ë²„íŠ¼ */
.btn-ranking {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    align-items: center;
    gap: 4px;
}

.btn-ranking:hover {
    filter: brightness(1.1);
}

@media (max-width: 480px) {
    .challenge-complete-banner {
        padding: 16px;
        margin-bottom: 16px;
    }
    .challenge-complete-content .challenge-icon-large {
        font-size: 2.5rem;
    }
    .challenge-complete-content h2 {
        font-size: 1.25rem;
    }
}

/* ì‹ ê³  ë²„íŠ¼ - ë‹¤í¬ëª¨ë“œ ì§€ì› */
.btn-report-small {
    display: block;
    margin-top: 8px;
    padding: 4px 10px;
    font-size: 0.75em;
    background: rgba(255, 255, 255, 0.1);
    color: #94a3b8;
    border: 1px solid #475569;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-report-small:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
    border-color: #f87171;
}

/* ì‹œë„ ë‚´ì—­ ìŠ¤íƒ€ì¼ - ë‹¤í¬ëª¨ë“œ ì§€ì› */
.attempts-section {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px dashed #475569;
}
.attempts-label {
    font-size: 0.75em;
    color: #94a3b8;
    margin-bottom: 6px;
    font-weight: 500;
}
.attempts-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.attempt-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    background: rgba(255, 255, 255, 0.05);
}
.attempt-item.correct {
    background: rgba(74, 222, 128, 0.15);
}
.attempt-item.wrong {
    background: rgba(248, 113, 113, 0.15);
}
.attempt-num {
    font-weight: 600;
    color: #94a3b8;
    min-width: 28px;
}
.attempt-answer {
    flex: 1;
    color: #e2e8f0;
    word-break: break-all;
}
.attempt-result {
    font-weight: 700;
    min-width: 20px;
    text-align: center;
}
.attempt-result.correct {
    color: #4ade80;
}
.attempt-result.wrong {
    color: #f87171;
}
</style>
</body>
</html>