<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('게임 결과 - Song Quiz')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<body class="client-page result-page">
<div class="result-container">
    <!-- 챌린지 완료 배너 (JS에서 제어) -->
    <div class="challenge-complete-banner" id="challengeCompleteBanner" style="display: none;">
        <div class="challenge-complete-content">
            <div class="challenge-icon-large">🏆</div>
            <h2>30개 챌린지 완료!</h2>
            <p>기록이 랭킹에 반영됩니다</p>
        </div>
    </div>

    <header class="result-header">
        <h1>🏆 게임 결과</h1>
        <p th:text="${nickname}"></p>
    </header>

    <main class="result-main">
        <!-- 점수 섹션 -->
        <div class="score-section">
            <div class="final-score">
                <span class="score-label">최종 점수</span>
                <span class="score-value" th:text="${gameSession.totalScore}">0</span>
            </div>
        </div>

        <!-- 통계 바 - 한 줄 -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">정답</span>
                <span class="stat-value correct" th:text="${gameSession.correctCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">오답</span>
                <span class="stat-value wrong" th:text="${gameSession.completedRounds - gameSession.correctCount - gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">스킵</span>
                <span class="stat-value skip" th:text="${gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">정답률</span>
                <span class="stat-value" th:text="${#numbers.formatDecimal(gameSession.accuracyRate, 1, 1) + '%'}">0%</span>
            </div>
        </div>

        <!-- 라운드 기록 - 카드 그리드 -->
        <div class="rounds-section">
            <h3>라운드 기록</h3>
            <div class="rounds-grid">
                <div th:each="round : ${rounds}" class="round-card"
                     th:classappend="${round.isCorrect ? 'correct' : (round.status.name() == 'SKIPPED' ? 'skipped' : 'wrong')}">
                    <div class="round-header">
                        <span class="round-num" th:text="'#' + ${round.roundNumber}"></span>
                        <span th:if="${round.isCorrect}" class="round-status correct">정답</span>
                        <span th:if="${round.status.name() == 'SKIPPED'}" class="round-status skip">스킵</span>
                        <span th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="round-status wrong">오답</span>
                    </div>
                    <div class="round-body">
                        <div class="song-info">
                            <div class="song-title" th:text="${round.song.title}"></div>
                            <div class="song-artist" th:text="${round.song.artist}"></div>
                        </div>
                        <div th:if="${round.isCorrect}" class="score-info">
                            <span class="score-plus" th:text="'+' + ${round.score} + '점'"></span>
                            <span th:if="${round.answerTimeMs != null}" class="attempt-info" th:text="'(' + ${#numbers.formatDecimal(round.answerTimeMs / 1000.0, 1, 1)} + '초)'"></span>
                        </div>
                        <div th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="fail-info">
                            <span class="fail-text">3회 실패</span>
                        </div>
                        <!-- 시도 내역 표시 (오답/정답 모두) -->
                        <div th:if="${round.attempts != null && !round.attempts.isEmpty()}" class="attempts-section">
                            <div class="attempts-label">내 답변:</div>
                            <div class="attempts-list">
                                <div th:each="attempt : ${round.attempts}" class="attempt-item"
                                     th:classappend="${attempt.isCorrect} ? 'correct' : 'wrong'">
                                    <span class="attempt-num" th:text="${attempt.attemptNumber} + '차'"></span>
                                    <span class="attempt-answer" th:text="${attempt.userAnswer}"></span>
                                    <span th:if="${attempt.isCorrect}" class="attempt-result correct">O</span>
                                    <span th:if="${!attempt.isCorrect}" class="attempt-result wrong">X</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-report-small" th:data-song-id="${round.song.id}" onclick="openReportModal(this.dataset.songId)">신고</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <a href="/game/solo/guess" class="btn btn-replay">다시 하기 🔄</a>
        <a href="/ranking" class="btn btn-ranking" id="rankingBtn" style="display: none;">랭킹 보기 🏆</a>
        <a href="/" class="btn btn-home">홈으로 🏠</a>
    </footer>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/client/game-guess-result.js}"></script>

<!-- 신고 모달 -->
<th:block th:replace="~{common/fragments/report-modal :: reportModal}"></th:block>
</body>
</html>