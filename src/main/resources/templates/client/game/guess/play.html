<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ê²Œì„ ì§„í–‰ - Song Quiz')}"></head>
<link rel="stylesheet" href="/css/client/game-guess-mobile.css">
<body class="client-page game-page">
<div class="game-container guess-mode guess-mobile-compact">
    <!-- ì±Œë¦°ì§€ ëª¨ë“œ í‘œì‹œ (JSì—ì„œ ì œì–´) -->
    <div class="challenge-mode-banner" id="challengeBanner" style="display: none;">
        <span class="challenge-badge">ğŸ¯ 30ê°œ ì±Œë¦°ì§€</span>
        <span class="challenge-progress" id="challengeProgress">0/30</span>
    </div>

    <header class="game-header">
        <div class="game-info">
            <span class="round-info">
                ë¼ìš´ë“œ <span id="currentRound">1</span> / <span th:text="${gameSession.totalRounds}"></span>
            </span>
            <span class="score-info">
                ì ìˆ˜: <span id="currentScore">0</span>ì 
            </span>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <a href="/" class="btn btn-home" style="text-decoration: none; background: #4a5568; color: white; padding: 8px 16px; border-radius: 6px; font-size: 0.9em;">ğŸ  í™ˆ</a>
            <button class="btn btn-quit" onclick="quitGame()">ê²Œì„ ì¢…ë£Œ</button>
        </div>
    </header>

    <main class="game-main">
        <!-- ì¤€ë¹„ ì™„ë£Œ í”„ë¡¬í”„íŠ¸ -->
        <div id="readyPrompt" class="ready-prompt" style="display: none;">
            <div class="ready-content">
                <p class="ready-message">ê´‘ê³ ê°€ ìˆë‹¤ë©´ ë¨¼ì € ì‹œì²­í•´ì£¼ì„¸ìš”</p>
                <p class="ready-hint">ì¤€ë¹„ê°€ ë˜ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                <button class="btn btn-ready" onclick="confirmReady()">ì¤€ë¹„ ì™„ë£Œ</button>
            </div>
        </div>

        <div class="music-player">
            <div class="player-display">
                <div class="music-icon" id="musicIcon">ğŸµ</div>
                <div class="player-status" id="playerStatus">ì¬ìƒ ëŒ€ê¸°ì¤‘</div>
            </div>

            <div class="player-controls">
                <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">
                    <span class="play-icon">â–¶</span>
                </button>
            </div>

            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
            </div>
        </div>

        <div class="answer-section guess-answer-section">
            <h3>ğŸ¯ ì •ë‹µ ì…ë ¥</h3>
            <div class="answer-input-wrapper">
                <input type="text" id="answerInput" class="answer-input" placeholder="ë…¸ë˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
                <button class="btn btn-submit" onclick="submitAnswer()">ì œì¶œ</button>
            </div>
            <!-- ì‹¤ì‹œê°„ ì ìˆ˜ í‘œì‹œ -->
            <div class="live-score-indicator waiting">
                <div class="score-display">
                    <span class="score-label">í˜„ì¬ íšë“ ê°€ëŠ¥</span>
                    <span class="score-value" id="possibleScore">100</span>
                    <span class="score-unit">ì </span>
                </div>
                <div class="score-countdown">
                    <span class="countdown-text">ë‹¤ìŒ ê°ì†Œê¹Œì§€</span>
                    <span class="countdown-time" id="nextDropTime">5.0</span>
                    <span class="countdown-unit">ì´ˆ</span>
                </div>
                <div class="score-progress">
                    <div class="score-segment active" data-score="100">100</div>
                    <div class="score-segment" data-score="90">90</div>
                    <div class="score-segment" data-score="80">80</div>
                    <div class="score-segment" data-score="70">70</div>
                    <div class="score-segment" data-score="60">60</div>
                </div>
            </div>
            <button class="btn btn-skip" onclick="skipRound()">ìŠ¤í‚µ â­</button>
        </div>
    </main>

    <aside class="stats-sidebar">
        <h3>ğŸ“Š í˜„ì¬ ê¸°ë¡</h3>
        <div class="stat-item">
            <span class="stat-label">ì •ë‹µ</span>
            <span class="stat-value" id="correctCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ì˜¤ë‹µ</span>
            <span class="stat-value" id="wrongCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ìŠ¤í‚µ</span>
            <span class="stat-value" id="skipCount">0</span>
        </div>
    </aside>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div class="modal" id="answerModal">
    <div class="modal-content answer-modal">
        <div class="answer-header" id="answerHeader">ì •ë‹µ!</div>
        <div class="answer-info">
            <div class="song-title" id="answerTitle"></div>
            <div class="song-artist" id="answerArtist"></div>
            <div class="song-meta" id="answerMeta"></div>
        </div>
        <div class="user-answer-info" id="userAnswerInfo"></div>
        <button class="btn btn-next-round" id="nextRoundBtn" onclick="nextRound()">ë‹¤ìŒ ë¼ìš´ë“œ â†’</button>
        <button class="btn-report-inline" onclick="openReportModal(currentSong.id)">ë¬¸ì œ ì‹ ê³ </button>
    </div>
</div>

<!-- ì¥ë¥´ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="genreSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">ğŸµ ì¥ë¥´ ì„ íƒ</div>
        <div class="genre-modal-subtitle">ë‹¤ìŒ ë¼ìš´ë“œì˜ ì¥ë¥´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="genre-list" id="genreList">
            <div th:each="genre : ${genres}"
                 class="genre-item"
                 th:data-genre-id="${genre.id}"
                 th:data-genre-name="${genre.name}">
                <span class="genre-name" th:text="${genre.name}"></span>
                <span class="genre-count" th:data-genre-id="${genre.id}"></span>
            </div>
        </div>
    </div>
</div>

<!-- ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="artistSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">ğŸ¤ ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ</div>
        <div class="genre-modal-subtitle">ë‹¤ìŒ ë¼ìš´ë“œì˜ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        <input type="text" id="artistSearchInput" class="modal-search-input" placeholder="ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." autocomplete="off">
        <div class="genre-list scrollable" id="artistList"></div>
    </div>
</div>

<!-- ì—°ë„ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="yearSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">ğŸ“… ì—°ë„ ì„ íƒ</div>
        <div class="genre-modal-subtitle">ë‹¤ìŒ ë¼ìš´ë“œì˜ ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="genre-list" id="yearList"></div>
    </div>
</div>

<!-- ì˜¤ë””ì˜¤ ìš”ì†Œ (MP3 fallback) -->
<audio id="audioPlayer" preload="auto"></audio>
<!-- YouTube Player ì»¨í…Œì´ë„ˆ (ìˆ¨ê¹€) -->
<div id="youtubePlayerContainer" style="position: absolute; width: 0; height: 0; overflow: hidden;"></div>

<script th:inline="javascript">
    const sessionId = [[${gameSession.id}]];
    const totalRounds = [[${gameSession.totalRounds}]];
    const nickname = [[${nickname}]];
    const gameMode = [[${gameMode}]];
    const hideEmptyOptions = [[${settings.hideEmptyOptions}]] || false;
</script>
<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/common/youtube-player.js}"></script>
<script th:src="@{/js/client/game-guess-play.js}"></script>

<!-- ì‹ ê³  ëª¨ë‹¬ -->
<th:block th:replace="~{common/fragments/report-modal :: reportModal}"></th:block>

<style>
/* ì±Œë¦°ì§€ ëª¨ë“œ ë°°ë„ˆ */
.challenge-mode-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 8px;
    margin-bottom: 12px;
}

.challenge-badge {
    font-weight: 700;
    font-size: 0.95rem;
}

.challenge-progress {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
}

@media (max-width: 480px) {
    .challenge-mode-banner {
        padding: 8px 12px;
        margin-bottom: 8px;
    }
    .challenge-badge {
        font-size: 0.85rem;
    }
    .challenge-progress {
        padding: 3px 10px;
        font-size: 0.75rem;
    }
}

.ready-prompt {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    text-align: center;
    border: 2px solid #ffd700;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
}
.ready-content {
    max-width: 300px;
    margin: 0 auto;
}
.ready-message {
    font-size: 1.1em;
    color: #ffd700;
    margin-bottom: 8px;
    font-weight: 500;
}
.ready-hint {
    font-size: 0.9em;
    color: #aaa;
    margin-bottom: 16px;
}
.btn-ready {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 14px 40px;
    font-size: 1.1em;
    font-weight: 600;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.btn-ready:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}
.play-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.btn-report-inline {
    display: block;
    margin-top: 12px;
    padding: 8px 16px;
    background: transparent;
    color: #888;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-report-inline:hover {
    background: #f8f9fa;
    color: #666;
    border-color: #ccc;
}

/* ì‹¤ì‹œê°„ ì ìˆ˜ ì¸ë””ì¼€ì´í„° */
.live-score-indicator {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    border: 2px solid #ffd700;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15);
}

.score-display {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 6px;
    margin-bottom: 8px;
}

.score-label {
    font-size: 0.85rem;
    color: #aaa;
}

.score-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    transition: all 0.3s ease;
    min-width: 70px;
    text-align: center;
}

.score-value.dropping {
    animation: scoreDrop 0.4s ease;
    color: #ff6b6b;
}

@keyframes scoreDrop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); color: #ff6b6b; }
    100% { transform: scale(1); }
}

.score-unit {
    font-size: 1rem;
    color: #ffd700;
}

.score-countdown {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.countdown-text {
    color: #888;
}

.countdown-time {
    font-weight: 600;
    color: #4ecdc4;
    min-width: 35px;
    text-align: center;
}

.countdown-time.urgent {
    color: #ff6b6b;
    animation: pulse 0.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.countdown-unit {
    color: #888;
}

.score-progress {
    display: flex;
    gap: 4px;
    border-radius: 6px;
    overflow: hidden;
}

.score-segment {
    flex: 1;
    text-align: center;
    padding: 6px 0;
    font-size: 0.75rem;
    font-weight: 600;
    background: #2a2a4a;
    color: #666;
    transition: all 0.3s ease;
}

.score-segment.active {
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    color: #1a1a2e;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
}

.score-segment.passed {
    background: #3a3a5a;
    color: #888;
}

/* ì¬ìƒ ì „ ìƒíƒœ */
.live-score-indicator.waiting .score-value {
    color: #4ecdc4;
}

.live-score-indicator.waiting .score-countdown {
    color: #4ecdc4;
}

.live-score-indicator.waiting .score-countdown::after {
    content: 'â–¶ ì¬ìƒí•˜ë©´ ì¹´ìš´íŠ¸ ì‹œì‘';
    font-size: 0.9rem;
}

.live-score-indicator.waiting .countdown-text,
.live-score-indicator.waiting .countdown-time,
.live-score-indicator.waiting .countdown-unit {
    display: none;
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 480px) {
    .live-score-indicator {
        padding: 12px;
        margin: 12px 0;
    }
    .score-value {
        font-size: 2rem;
    }
    .score-segment {
        font-size: 0.65rem;
        padding: 5px 0;
    }
}
</style>
</body>
</html>