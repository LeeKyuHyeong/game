<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('게임 진행 - Song Quiz')}"></head>
<link rel="stylesheet" th:href="@{/css/client/game-guess.css}">
<body class="client-page game-page">
<div class="game-container guess-mode guess-mobile-compact pc-compact">
    <!-- 통합 헤더 (챌린지 모드용) -->
    <header class="unified-header" id="challengeBanner" style="display: none;">
        <span class="challenge-badge">🎯 30개 챌린지</span>
        <span class="round-info">라운드 <span id="currentRound">1</span>/<span th:text="${gameSession.totalRounds}"></span></span>
        <span class="score-info">점수:<span id="currentScore">0</span>점</span>
        <div class="header-status">
            <span class="music-icon" id="musicIcon">🎵</span>
            <span class="player-status" id="playerStatus">재생 대기중</span>
        </div>
        <div class="header-actions">
            <a href="/" class="btn-header">홈</a>
            <button class="btn-header btn-end" onclick="quitGame()">종료</button>
        </div>
    </header>

    <!-- 일반 모드용 헤더 (챌린지 아닐 때) -->
    <header class="unified-header unified-header-normal" id="normalHeader">
        <span class="round-info">라운드 <span id="currentRoundNormal">1</span>/<span th:text="${gameSession.totalRounds}"></span></span>
        <span class="score-info">점수:<span id="currentScoreNormal">0</span>점</span>
        <div class="header-status">
            <span class="music-icon" id="musicIconNormal">🎵</span>
            <span class="player-status" id="playerStatusNormal">재생 대기중</span>
        </div>
        <div class="header-actions">
            <a href="/" class="btn-header">홈</a>
            <button class="btn-header btn-end" onclick="quitGame()">종료</button>
        </div>
    </header>

    <main class="game-main">
        <!-- 준비 완료 프롬프트 -->
        <div id="readyPrompt" class="ready-prompt" style="display: none;">
            <div class="ready-content">
                <p class="ready-message">광고가 있다면 먼저 시청해주세요</p>
                <p class="ready-hint">준비가 되면 아래 버튼을 눌러주세요</p>
                <button class="btn btn-ready" onclick="confirmReady()">준비 완료</button>
            </div>
        </div>

        <!-- 음악 컨트롤 바 -->
        <div class="music-controls-bar">
            <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">
                <span class="play-icon">▶</span>
            </button>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
            </div>
        </div>

        <aside class="stats-sidebar" id="statsSidebar">
            <h3 onclick="toggleStats()">📊 현재 기록<span class="stats-inline" id="statsInline"></span></h3>
            <div class="stat-item-wrap">
                <div class="stat-item">
                    <span class="stat-label">정답</span>
                    <span class="stat-value" id="correctCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">오답</span>
                    <span class="stat-value" id="wrongCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">스킵</span>
                    <span class="stat-value" id="skipCount">0</span>
                </div>
            </div>
        </aside>

        <div class="answer-section guess-answer-section">
            <div class="answer-header-row">
                <h3>🎯 정답 입력</h3>
                <button class="btn btn-skip btn-skip-inline" onclick="skipRound()">스킵 ⏭</button>
            </div>
            <div class="answer-input-wrapper">
                <input type="text" id="answerInput" class="answer-input" placeholder="노래 제목을 입력하세요" autocomplete="off">
                <button class="btn btn-submit" onclick="submitAnswer()">제출</button>
            </div>
            <!-- 실시간 점수 표시 -->
            <div class="live-score-indicator waiting">
                <div class="score-display">
                    <span class="score-label">현재 획득 가능</span>
                    <span class="score-value" id="possibleScore">100</span>
                    <span class="score-unit">점</span>
                </div>
                <div class="score-countdown">
                    <span class="countdown-text">다음 감소까지</span>
                    <span class="countdown-time" id="nextDropTime">5.0</span>
                    <span class="countdown-unit">초</span>
                </div>
                <div class="score-progress">
                    <div class="score-segment active" data-score="100">100</div>
                    <div class="score-segment" data-score="90">90</div>
                    <div class="score-segment" data-score="80">80</div>
                    <div class="score-segment" data-score="70">70</div>
                    <div class="score-segment" data-score="60">60</div>
                </div>
            </div>
            <button class="btn btn-skip btn-skip-bottom" onclick="skipRound()">스킵 ⏭</button>
        </div>
    </main>


</div>

<!-- 결과 모달 -->
<div class="modal" id="answerModal">
    <div class="modal-content answer-modal">
        <div class="answer-header" id="answerHeader">정답!</div>
        <div class="answer-info">
            <div class="song-title" id="answerTitle"></div>
            <div class="song-artist" id="answerArtist"></div>
            <div class="song-meta" id="answerMeta"></div>
        </div>
        <div class="user-answer-info" id="userAnswerInfo"></div>
        <button class="btn btn-next-round" id="nextRoundBtn" onclick="nextRound()">다음 라운드 →</button>
        <button class="btn-report-inline" onclick="openReportModal(currentSong.id)">문제 신고</button>
    </div>
</div>

<!-- 장르 선택 모달 -->
<div class="modal" id="genreSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">🎵 장르 선택</div>
        <div class="genre-modal-subtitle">다음 라운드의 장르를 선택하세요</div>
        <div class="genre-list" id="genreList">
            <div th:each="genre : ${genres}"
                 class="genre-item"
                 th:data-genre-id="${genre.id}"
                 th:data-genre-name="${genre.name}">
                <span class="genre-name" th:text="${genre.name}"></span>
                <span class="genre-count" th:data-genre-id="${genre.id}"></span>
            </div>
        </div>
    </div>
</div>

<!-- 아티스트 선택 모달 -->
<div class="modal" id="artistSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">🎤 아티스트 선택</div>
        <div class="genre-modal-subtitle">다음 라운드의 아티스트를 선택하세요</div>
        <input type="text" id="artistSearchInput" class="modal-search-input" placeholder="아티스트 검색..." autocomplete="off">
        <div class="genre-list scrollable" id="artistList"></div>
    </div>
</div>

<!-- 연도 선택 모달 -->
<div class="modal" id="yearSelectModal">
    <div class="modal-content genre-select-modal">
        <div class="genre-modal-header">📅 연도 선택</div>
        <div class="genre-modal-subtitle">다음 라운드의 연도를 선택하세요</div>
        <div class="genre-list" id="yearList"></div>
    </div>
</div>

<!-- 오디오 요소 (MP3 fallback) -->
<audio id="audioPlayer" preload="auto"></audio>
<!-- YouTube Player 컨테이너 (숨김) -->
<div id="youtubePlayerContainer" style="position: absolute; width: 0; height: 0; overflow: hidden;"></div>

<script th:inline="javascript">
    const sessionId = [[${gameSession.id}]];
    const totalRounds = [[${gameSession.totalRounds}]];
    const nickname = [[${nickname}]];
    const gameMode = [[${gameMode}]];
    const hideEmptyOptions = [[${settings.hideEmptyOptions}]] || false;
</script>
<script th:src="@{/js/common/youtube-player.js}"></script>
<script th:src="@{/js/client/game-guess-play.js}"></script>

<!-- 신고 모달 -->
<th:block th:replace="~{common/fragments/report-modal :: reportModal}"></th:block>
</body>
</html>