<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('게임 결과 - Song Quiz')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<body class="client-page result-page">

<div class="client-container">
    <header class="result-header">
        <div style="display: flex; justify-content: flex-end; padding: 8px;">
            <a href="/" class="btn-home">🏠 홈</a>
        </div>
        <h1>🏆 게임 종료!</h1>
        <p class="room-name" th:text="${room.roomName}">방 이름</p>
    </header>

    <main class="result-main">
        <!-- 전원 동점일 때: 포디움 대신 공동 1등 메시지 -->
        <div class="all-tied-section" th:if="${results[0].allTied}">
            <div class="tied-trophy">🏆</div>
            <div class="tied-message">모두 공동 1등!</div>
            <div class="tied-sub">점수가 동일하여 순위를 가릴 수 없습니다</div>
        </div>

        <!-- 전원 동점이 아닐 때만 포디움 표시 -->
        <div class="podium-section" th:unless="${results[0].allTied}">
            <!-- 2등 -->
            <div class="podium-item second" th:if="${#lists.size(results) > 1}">
                <div class="podium-rank">🥈</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[1].multiTier}"
                          th:text="${results[1].multiTierDisplayName}">브론즈</span>
                </div>
                <div class="podium-player second-name" th:text="${results[1].nickname}">2등</div>
                <div class="podium-score" th:text="${results[1].score} + '점'">0점</div>
                <div class="podium-lp">
                    <span class="lp-change"
                          th:classappend="${results[1].lpChange > 0} ? 'positive' : (${results[1].lpChange < 0} ? 'negative' : 'neutral')">
                        <span th:if="${results[1].lpChange > 0}">+</span><span th:text="${results[1].lpChange}">0</span> LP
                    </span>
                </div>
                <div class="podium-stand second-stand">2</div>
            </div>

            <!-- 1등 -->
            <div class="podium-item first" th:if="${#lists.size(results) > 0}">
                <div class="podium-crown">👑</div>
                <div class="podium-rank">🥇</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[0].multiTier}"
                          th:text="${results[0].multiTierDisplayName}">브론즈</span>
                </div>
                <div class="podium-player first-name" th:text="${results[0].nickname}">1등</div>
                <div class="podium-score" th:text="${results[0].score} + '점'">0점</div>
                <div class="podium-lp">
                    <span class="lp-change positive">
                        +<span th:text="${results[0].lpChange}">100</span> LP
                    </span>
                </div>
                <div class="podium-stand first-stand">1</div>
            </div>

            <!-- 3등 -->
            <div class="podium-item third" th:if="${#lists.size(results) > 2}">
                <div class="podium-rank">🥉</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[2].multiTier}"
                          th:text="${results[2].multiTierDisplayName}">브론즈</span>
                </div>
                <div class="podium-player third-name" th:text="${results[2].nickname}">3등</div>
                <div class="podium-score" th:text="${results[2].score} + '점'">0점</div>
                <div class="podium-lp">
                    <span class="lp-change"
                          th:classappend="${results[2].lpChange > 0} ? 'positive' : (${results[2].lpChange < 0} ? 'negative' : 'neutral')">
                        <span th:if="${results[2].lpChange > 0}">+</span><span th:text="${results[2].lpChange}">0</span> LP
                    </span>
                </div>
                <div class="podium-stand third-stand">3</div>
            </div>
        </div>

        <!-- 전체 순위 -->
        <div class="full-ranking">
            <h2>📊 전체 순위</h2>
            <div class="ranking-list">
                <div th:each="r : ${results}" class="ranking-item"
                     th:classappend="${r.memberId == member.id} ? 'me' : ''">
                    <span class="rank" th:text="${r.rank}">1</span>
                    <div class="player-info">
                        <span class="tier-badge" th:classappend="${r.multiTier}"
                              th:text="${r.multiTierDisplayName}">브론즈</span>
                        <span class="player-name">
                            <span th:if="${r.isHost}">👑 </span>
                            <span th:text="${r.nickname}">닉네임</span>
                            <span th:if="${r.memberId == member.id}" class="me-badge">(나)</span>
                        </span>
                    </div>
                    <div class="stats-info">
                        <span class="lp-change"
                              th:classappend="${r.lpChange > 0} ? 'positive' : (${r.lpChange < 0} ? 'negative' : 'neutral')">
                            <span th:if="${r.lpChange > 0}">+</span><span th:text="${r.lpChange}">0</span> LP
                        </span>
                        <span class="correct-count" th:text="'정답 ' + ${r.correctCount} + '개'">정답 0개</span>
                        <span class="total-score" th:text="${r.score} + '점'">0점</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 재시작 알림 (비방장용) -->
        <div id="restartNotice" class="restart-notice" style="display: none;">
            <div class="notice-content">
                <span class="notice-icon">🔄</span>
                <span class="notice-text">방장이 게임을 재시작합니다! 대기실로 이동 중...</span>
            </div>
        </div>

        <div class="result-actions">
            <button th:if="${isHost}" type="button" class="btn btn-restart" onclick="restartGame()">🔄 한번 더 하기</button>
            <button th:unless="${isHost}" type="button" class="btn btn-wait" disabled>⏳ 방장의 결정 대기중</button>
            <button type="button" class="btn btn-lobby" onclick="goToLobby()">로비로 돌아가기</button>
        </div>
    </main>
</div>

<script th:inline="javascript">
    const roomCode = [[${room.roomCode}]];
    const isHost = [[${isHost}]];
</script>
<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/client/multi-result.js}"></script>
</body>
</html>
