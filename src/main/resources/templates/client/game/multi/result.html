<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ê²Œì„ ê²°ê³¼ - Song Quiz')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<body class="client-page result-page">

<div class="client-container">
    <header class="result-header">
        <div style="display: flex; justify-content: flex-end; padding: 8px;">
            <a href="/" class="btn-home">ğŸ  í™ˆ</a>
        </div>
        <h1>ğŸ† ê²Œì„ ì¢…ë£Œ!</h1>
        <p class="room-name" th:text="${room.roomName}">ë°© ì´ë¦„</p>
    </header>

    <main class="result-main">
        <div class="podium-section">
            <!-- 2ë“± -->
            <div class="podium-item second" th:if="${#lists.size(results) > 1}">
                <div class="podium-rank">ğŸ¥ˆ</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[1].multiTier}"
                          th:text="${results[1].multiTierDisplayName}">ë¸Œë¡ ì¦ˆ</span>
                </div>
                <div class="podium-player second-name" th:text="${results[1].nickname}">2ë“±</div>
                <div class="podium-score" th:text="${results[1].score} + 'ì '">0ì </div>
                <div class="podium-lp">
                    <span class="lp-change"
                          th:classappend="${results[1].lpChange > 0} ? 'positive' : (${results[1].lpChange < 0} ? 'negative' : 'neutral')">
                        <span th:if="${results[1].lpChange > 0}">+</span><span th:text="${results[1].lpChange}">0</span> LP
                    </span>
                </div>
                <div class="podium-stand second-stand">2</div>
            </div>

            <!-- 1ë“± -->
            <div class="podium-item first" th:if="${#lists.size(results) > 0}">
                <div class="podium-crown">ğŸ‘‘</div>
                <div class="podium-rank">ğŸ¥‡</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[0].multiTier}"
                          th:text="${results[0].multiTierDisplayName}">ë¸Œë¡ ì¦ˆ</span>
                </div>
                <div class="podium-player first-name" th:text="${results[0].nickname}">1ë“±</div>
                <div class="podium-score" th:text="${results[0].score} + 'ì '">0ì </div>
                <div class="podium-lp">
                    <span class="lp-change positive">
                        +<span th:text="${results[0].lpChange}">100</span> LP
                    </span>
                </div>
                <div class="podium-stand first-stand">1</div>
            </div>

            <!-- 3ë“± -->
            <div class="podium-item third" th:if="${#lists.size(results) > 2}">
                <div class="podium-rank">ğŸ¥‰</div>
                <div class="podium-tier">
                    <span class="tier-badge" th:classappend="${results[2].multiTier}"
                          th:text="${results[2].multiTierDisplayName}">ë¸Œë¡ ì¦ˆ</span>
                </div>
                <div class="podium-player third-name" th:text="${results[2].nickname}">3ë“±</div>
                <div class="podium-score" th:text="${results[2].score} + 'ì '">0ì </div>
                <div class="podium-lp">
                    <span class="lp-change"
                          th:classappend="${results[2].lpChange > 0} ? 'positive' : (${results[2].lpChange < 0} ? 'negative' : 'neutral')">
                        <span th:if="${results[2].lpChange > 0}">+</span><span th:text="${results[2].lpChange}">0</span> LP
                    </span>
                </div>
                <div class="podium-stand third-stand">3</div>
            </div>
        </div>

        <!-- ì „ì²´ ìˆœìœ„ -->
        <div class="full-ranking">
            <h2>ğŸ“Š ì „ì²´ ìˆœìœ„</h2>
            <div class="ranking-list">
                <div th:each="r : ${results}" class="ranking-item"
                     th:classappend="${r.memberId == member.id} ? 'me' : ''">
                    <span class="rank" th:text="${r.rank}">1</span>
                    <div class="player-info">
                        <span class="tier-badge" th:classappend="${r.multiTier}"
                              th:text="${r.multiTierDisplayName}">ë¸Œë¡ ì¦ˆ</span>
                        <span class="player-name">
                            <span th:if="${r.isHost}">ğŸ‘‘ </span>
                            <span th:text="${r.nickname}">ë‹‰ë„¤ì„</span>
                            <span th:if="${r.memberId == member.id}" class="me-badge">(ë‚˜)</span>
                        </span>
                    </div>
                    <div class="stats-info">
                        <span class="lp-change"
                              th:classappend="${r.lpChange > 0} ? 'positive' : (${r.lpChange < 0} ? 'negative' : 'neutral')">
                            <span th:if="${r.lpChange > 0}">+</span><span th:text="${r.lpChange}">0</span> LP
                        </span>
                        <span class="correct-count" th:text="'ì •ë‹µ ' + ${r.correctCount} + 'ê°œ'">ì •ë‹µ 0ê°œ</span>
                        <span class="total-score" th:text="${r.score} + 'ì '">0ì </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¬ì‹œì‘ ì•Œë¦¼ (ë¹„ë°©ì¥ìš©) -->
        <div id="restartNotice" class="restart-notice" style="display: none;">
            <div class="notice-content">
                <span class="notice-icon">ğŸ”„</span>
                <span class="notice-text">ë°©ì¥ì´ ê²Œì„ì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤! ëŒ€ê¸°ì‹¤ë¡œ ì´ë™ ì¤‘...</span>
            </div>
        </div>

        <div class="result-actions">
            <button th:if="${isHost}" type="button" class="btn btn-restart" onclick="restartGame()">ğŸ”„ í•œë²ˆ ë” í•˜ê¸°</button>
            <button th:unless="${isHost}" type="button" class="btn btn-wait" disabled>â³ ë°©ì¥ì˜ ê²°ì • ëŒ€ê¸°ì¤‘</button>
            <button type="button" class="btn btn-lobby" onclick="goToLobby()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </main>
</div>

<script th:inline="javascript">
    const roomCode = [[${room.roomCode}]];
    const isHost = [[${isHost}]];
</script>
<script th:src="@{/js/common/common.js}"></script>
<script>
let pollingInterval = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë§ ì‹œì‘ (ë¹„ë°©ì¥ë§Œ)
document.addEventListener('DOMContentLoaded', function() {
    if (!isHost) {
        startRestartPolling();
    }
});

// ì¬ì‹œì‘ ê°ì§€ í´ë§ ì‹œì‘
function startRestartPolling() {
    pollingInterval = setInterval(checkRoomStatus, 2000);
}

// í´ë§ ì¤‘ì§€
function stopRestartPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// ë°© ìƒíƒœ í™•ì¸
async function checkRoomStatus() {
    try {
        const response = await fetch(`/game/multi/room/${roomCode}/status`);
        const result = await response.json();

        // ë°©ì´ WAITING ìƒíƒœë©´ ì¬ì‹œì‘ë¨ â†’ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
        if (result.status === 'WAITING') {
            stopRestartPolling();
            showRestartNotice();
            setTimeout(() => {
                window.location.href = `/game/multi/room/${roomCode}`;
            }, 1500);
        }

        // ë°©ì´ ì—†ê±°ë‚˜ ê°•í‡´ë¨ â†’ ë¡œë¹„ë¡œ ì´ë™
        if (!result.success || result.kicked) {
            stopRestartPolling();
            window.location.href = '/game/multi';
        }
    } catch (error) {
        console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    }
}

// ì¬ì‹œì‘ ì•Œë¦¼ í‘œì‹œ
function showRestartNotice() {
    const notice = document.getElementById('restartNotice');
    if (notice) {
        notice.style.display = 'block';
    }
}

async function restartGame() {
    if (!isHost) {
        alert('ë°©ì¥ë§Œ ê²Œì„ì„ ì¬ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    if (!confirm('ê°™ì€ ì„¤ì •ìœ¼ë¡œ í•œë²ˆ ë” ê²Œì„ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`/game/multi/room/${roomCode}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            // ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
            window.location.href = `/game/multi/room/${roomCode}`;
        } else {
            alert(result.message || 'ê²Œì„ ì¬ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ì¬ì‹œì‘ ì˜¤ë¥˜:', error);
        alert('ê²Œì„ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function goToLobby() {
    stopRestartPolling();
    // ëª…ì‹œì  ë¡œë¹„ ì´ë™ - ì¬ì‹œì‘ ëŒ€ìƒì—ì„œ ì œì™¸í•˜ê¸° ìœ„í•´ ë³„ë„ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
    try {
        await fetch(`/game/multi/room/${roomCode}/leave-to-lobby`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
    } catch (error) {
        // ë‚˜ê°€ê¸° ì‹¤íŒ¨í•´ë„ ë¡œë¹„ë¡œ ì´ë™
        console.log('ë‚˜ê°€ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', error);
    }
    window.location.href = '/game/multi';
}
</script>
</body>
</html>
