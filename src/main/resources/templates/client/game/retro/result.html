<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ë ˆíŠ¸ë¡œ ê²Œì„ - ê²°ê³¼')}"></head>
<link rel="stylesheet" th:href="@{/css/client/result.css}">
<body class="client-page result-page">
<div class="result-container">
    <header class="result-header">
        <h1>ğŸ® ê²Œì„ ê²°ê³¼</h1>
        <p th:text="${nickname}"></p>
    </header>

    <main class="result-main">
        <!-- ì ìˆ˜ ì„¹ì…˜ -->
        <div class="score-section">
            <div class="final-score">
                <span class="score-label">ìµœì¢… ì ìˆ˜</span>
                <span class="score-value" th:text="${gameSession.totalScore}">0</span>
            </div>
        </div>

        <!-- í†µê³„ ë°” - í•œ ì¤„ -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">ì •ë‹µ</span>
                <span class="stat-value correct" th:text="${gameSession.correctCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ì˜¤ë‹µ</span>
                <span class="stat-value wrong" th:text="${gameSession.completedRounds - gameSession.correctCount - gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ìŠ¤í‚µ</span>
                <span class="stat-value skip" th:text="${gameSession.skipCount}">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">ì •ë‹µë¥ </span>
                <span class="stat-value" th:text="${#numbers.formatDecimal(gameSession.accuracyRate, 1, 1) + '%'}">0%</span>
            </div>
        </div>

        <!-- ë¼ìš´ë“œ ê¸°ë¡ - ì¹´ë“œ ê·¸ë¦¬ë“œ -->
        <div class="rounds-section">
            <h3>ë¼ìš´ë“œ ê¸°ë¡</h3>
            <div class="rounds-grid">
                <div th:each="round : ${rounds}" class="round-card"
                     th:classappend="${round.isCorrect ? 'correct' : (round.status.name() == 'SKIPPED' ? 'skipped' : 'wrong')}">
                    <div class="round-header">
                        <span class="round-num" th:text="'#' + ${round.roundNumber}"></span>
                        <span th:if="${round.isCorrect}" class="round-status correct">ì •ë‹µ</span>
                        <span th:if="${round.status.name() == 'SKIPPED'}" class="round-status skip">ìŠ¤í‚µ</span>
                        <span th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="round-status wrong">ì˜¤ë‹µ</span>
                    </div>
                    <div class="round-body">
                        <div class="song-info">
                            <div class="song-title" th:text="${round.song.title}"></div>
                            <div class="song-artist" th:text="${round.song.artist}"></div>
                        </div>
                        <div th:if="${round.isCorrect}" class="score-info">
                            <span class="score-plus" th:text="'+' + ${round.score} + 'ì '"></span>
                            <span th:if="${round.answerTimeMs != null}" class="attempt-info" th:text="'(' + ${#numbers.formatDecimal(round.answerTimeMs / 1000.0, 1, 1)} + 'ì´ˆ)'"></span>
                        </div>
                        <div th:if="${!round.isCorrect && round.status.name() != 'SKIPPED'}" class="fail-info">
                            <span class="fail-text">3íšŒ ì‹¤íŒ¨</span>
                        </div>
                        <!-- ì‹œë„ ë‚´ì—­ í‘œì‹œ (ì˜¤ë‹µ/ì •ë‹µ ëª¨ë‘) -->
                        <div th:if="${round.attempts != null && !round.attempts.isEmpty()}" class="attempts-section">
                            <div class="attempts-label">ë‚´ ë‹µë³€:</div>
                            <div class="attempts-list">
                                <div th:each="attempt : ${round.attempts}" class="attempt-item"
                                     th:classappend="${attempt.isCorrect} ? 'correct' : 'wrong'">
                                    <span class="attempt-num" th:text="${attempt.attemptNumber} + 'ì°¨'"></span>
                                    <span class="attempt-answer" th:text="${attempt.userAnswer}"></span>
                                    <span th:if="${attempt.isCorrect}" class="attempt-result correct">O</span>
                                    <span th:if="${!attempt.isCorrect}" class="attempt-result wrong">X</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-report-small" th:data-song-id="${round.song.id}" onclick="openReportModal(this.dataset.songId)">ì‹ ê³ </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="result-footer">
        <!-- ì¬ì‹œì‘ìš© ë°ì´í„° -->
        <span id="restartData"
              th:data-session-id="${gameSession.id}"
              style="display:none;"></span>

        <button type="button" class="btn btn-restart" onclick="restartWithSameSettings()">
            ê°™ì€ ì„¤ì •ìœ¼ë¡œ ë‹¤ì‹œí•˜ê¸° ğŸ”„
        </button>
        <a href="/game/retro" class="btn btn-replay">ì„¤ì • ë³€ê²½ âš™ï¸</a>
        <a href="/" class="btn btn-home">í™ˆìœ¼ë¡œ ğŸ </a>
    </footer>
</div>

<script>
async function restartWithSameSettings() {
    const sessionId = document.getElementById('restartData').dataset.sessionId;

    try {
        const response = await fetch('/game/retro/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ previousSessionId: sessionId })
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/game/retro/play';
        } else {
            alert(result.message || 'ì¬ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            if (result.redirectUrl) {
                window.location.href = result.redirectUrl;
            }
        }
    } catch (error) {
        console.error('Restart error:', error);
        alert('ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}
</script>

<!-- ì‹ ê³  ëª¨ë‹¬ -->
<th:block th:replace="~{common/fragments/report-modal :: reportModal}"></th:block>
</body>
</html>
