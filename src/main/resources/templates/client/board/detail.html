<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead(${board.title} + ' - Song Quiz')}"></head>
<body class="client-page board-page">
<div class="client-container">
    <header class="client-header compact">
        <nav class="header-nav">
            <a href="/board" class="btn-home">ğŸ“‹ ëª©ë¡</a>
            <a href="/" class="btn-home">ğŸ  í™ˆ</a>
        </nav>
        <h1>ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</h1>
    </header>

    <main class="client-main">
        <div class="board-content">
            <!-- Board Detail -->
            <div class="board-detail">
                <div class="board-detail-header">
                    <span class="board-category-badge" th:classappend="${board.category.name()}"
                          th:text="${board.category.description}"></span>
                    <h2 class="board-detail-title" th:text="${board.title}"></h2>
                    <div class="board-detail-meta">
                        <span class="board-author">
                            <span th:if="${board.member.selectedBadgeEmoji}" class="member-badge" th:text="${board.member.selectedBadgeEmoji}" th:title="${board.member.selectedBadgeName}"></span>
                            <span th:text="${board.member.nickname}"></span>
                        </span>
                        <span th:text="${#temporals.format(board.createdAt, 'yyyy.MM.dd HH:mm')}"></span>
                        <span>ì¡°íšŒ <span th:text="${board.viewCount}">0</span></span>
                    </div>
                </div>

                <div class="board-detail-content" th:text="${board.content}"></div>

                <div class="board-detail-actions">
                    <button class="like-btn" th:classappend="${isLiked} ? 'liked'" id="likeBtn"
                            th:data-board-id="${board.id}">
                        <span th:text="${isLiked} ? 'â¤ï¸' : 'ğŸ¤'"></span>
                        <span th:text="${board.likeCount}">0</span>
                    </button>

                    <div class="action-btns" th:if="${member != null and (member.id == board.member.id or member.role.name() == 'ADMIN')}">
                        <a th:href="@{/board/{id}/edit(id=${board.id})}" class="btn-edit"
                           th:if="${member.id == board.member.id}">ìˆ˜ì •</a>
                        <button class="btn-delete" id="deleteBtn" th:data-board-id="${board.id}">ì‚­ì œ</button>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
                <h3 class="comments-title">ğŸ’¬ ëŒ“ê¸€ <span th:text="${#lists.size(comments)}">0</span></h3>

                <!-- Comment Form -->
                <div class="comment-form" th:if="${member != null}">
                    <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 500ì)"></textarea>
                    <button id="commentBtn" th:data-board-id="${board.id}">ë“±ë¡</button>
                </div>
                <div class="comment-form" th:if="${member == null}">
                    <textarea disabled placeholder="ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                    <a href="/auth/login" class="btn-write" style="padding: 12px 20px;">ë¡œê·¸ì¸</a>
                </div>

                <!-- Comment List -->
                <div class="comment-list" id="commentList">
                    <th:block th:each="comment : ${comments}">
                        <div class="comment-item" th:data-comment-id="${comment.id}">
                            <div class="comment-header">
                                <span class="comment-author">
                                    <span th:if="${comment.member.selectedBadgeEmoji}" class="member-badge" th:text="${comment.member.selectedBadgeEmoji}" th:title="${comment.member.selectedBadgeName}"></span>
                                    <span th:text="${comment.member.nickname}"></span>
                                </span>
                                <span>
                                    <span class="comment-time" th:text="${#temporals.format(comment.createdAt, 'MM.dd HH:mm')}"></span>
                                    <button class="comment-delete" th:if="${member != null and (member.id == comment.member.id or member.role.name() == 'ADMIN')}"
                                            th:data-comment-id="${comment.id}">ì‚­ì œ</button>
                                </span>
                            </div>
                            <div class="comment-content" th:text="${comment.content}"></div>
                        </div>
                    </th:block>

                    <div class="comment-empty" th:if="${#lists.isEmpty(comments)}">
                        ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </main>

</div>
<script th:inline="javascript">
    const currentMemberId = [[${member?.id}]];

    document.addEventListener('DOMContentLoaded', function() {
        // Like button
        const likeBtn = document.getElementById('likeBtn');
        if (likeBtn) {
            likeBtn.addEventListener('click', async function() {
                if (!currentMemberId) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    location.href = '/auth/login?redirect=' + location.pathname;
                    return;
                }

                const boardId = this.dataset.boardId;
                try {
                    const response = await fetch(`/api/board/${boardId}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        this.querySelector('span:first-child').textContent = result.liked ? 'â¤ï¸' : 'ğŸ¤';
                        this.querySelector('span:last-child').textContent = result.likeCount;
                        this.classList.toggle('liked', result.liked);
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    showToast('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        }

        // Delete board
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async function() {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const boardId = this.dataset.boardId;
                try {
                    const response = await fetch(`/api/board/${boardId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        location.href = '/board';
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        }

        // Add comment
        const commentBtn = document.getElementById('commentBtn');
        if (commentBtn) {
            commentBtn.addEventListener('click', async function() {
                const content = document.getElementById('commentContent').value.trim();
                if (!content) {
                    showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                    return;
                }

                const boardId = this.dataset.boardId;
                try {
                    const response = await fetch(`/api/board/${boardId}/comment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const result = await response.json();
                    if (result.success) {
                        location.reload();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    showToast('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        }

        // Delete comment
        document.querySelectorAll('.comment-delete').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const commentId = this.dataset.commentId;
                try {
                    const response = await fetch(`/api/board/comment/${commentId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        this.closest('.comment-item').remove();
                        showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    showToast('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        });
    });
</script>
</body>
</html>
