<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead((${board != null} ? 'ê¸€ ìˆ˜ì •' : 'ê¸€ì“°ê¸°') + ' - Song Quiz')}"></head>
<body class="client-page board-page">
<div class="client-container">
    <header class="client-header compact">
        <nav class="header-nav">
            <a href="/board" class="btn-home">ğŸ“‹ ëª©ë¡</a>
            <a href="/" class="btn-home">ğŸ  í™ˆ</a>
        </nav>
        <h1 th:text="${board != null} ? 'âœï¸ ê¸€ ìˆ˜ì •' : 'âœï¸ ê¸€ì“°ê¸°'"></h1>
    </header>

    <main class="client-main">
        <div class="board-content">
            <div class="write-form">
                <div class="form-group">
                    <label for="category">ì¹´í…Œê³ ë¦¬</label>
                    <select id="category" th:disabled="${board != null}">
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <th:block th:each="cat : ${categories}">
                            <option th:value="${cat.name()}" th:text="${cat.description}"
                                    th:selected="${board != null and board.category == cat}"></option>
                        </th:block>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">ì œëª©</label>
                    <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (2~100ì)"
                           th:value="${board?.title}" maxlength="100">
                </div>

                <div class="form-group">
                    <label for="content">ë‚´ìš©</label>
                    <textarea id="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 10ì)" th:text="${board?.content}"></textarea>
                </div>

                <div class="form-actions">
                    <a href="/board" class="btn-cancel">ì·¨ì†Œ</a>
                    <button type="button" id="submitBtn" class="btn-submit"
                            th:data-board-id="${board?.id}"
                            th:text="${board != null} ? 'ìˆ˜ì •' : 'ë“±ë¡'">ë“±ë¡</button>
                </div>
            </div>
        </div>
    </main>

</div>
<script th:inline="javascript">
    const isEditMode = [[${board != null}]];
    const boardId = [[${board?.id}]];

    document.addEventListener('DOMContentLoaded', function() {
        const submitBtn = document.getElementById('submitBtn');

        submitBtn.addEventListener('click', async function() {
            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            if (!isEditMode && !category) {
                showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'warning');
                return;
            }

            if (title.length < 2 || title.length > 100) {
                showToast('ì œëª©ì€ 2~100ìë¡œ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            if (content.length < 10) {
                showToast('ë‚´ìš©ì€ 10ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            try {
                let response;
                if (isEditMode) {
                    response = await fetch(`/api/board/${boardId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content })
                    });
                } else {
                    response = await fetch('/api/board', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category, title, content })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    if (isEditMode) {
                        location.href = `/board/${boardId}`;
                    } else {
                        location.href = `/board/${result.boardId}`;
                    }
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });
    });
</script>
</body>
</html>
