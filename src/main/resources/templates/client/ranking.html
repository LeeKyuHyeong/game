<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ì „ì²´ ë­í‚¹ - Song Quiz')}"></head>
<body class="client-page ranking-page">
<div class="client-container">
    <header class="client-header compact">
        <a href="/" class="back-home">â† í™ˆìœ¼ë¡œ</a>
        <h1>ğŸ† ì „ì²´ ë­í‚¹</h1>
        <p>Song Quiz ìµœê³ ì˜ í”Œë ˆì´ì–´ë“¤</p>
    </header>

    <main class="client-main">
        <div class="ranking-content">
            <!-- ê²Œì„ ëª¨ë“œ íƒ­ -->
            <div class="game-mode-tabs">
                <button class="mode-tab active" data-mode="guess">
                    <span class="tab-icon">ğŸ§</span>
                    <span class="tab-label">ë‚´ê°€ë§ì¶”ê¸°</span>
                </button>
                <button class="mode-tab" data-mode="multi">
                    <span class="tab-icon">ğŸ‘¥</span>
                    <span class="tab-label">ë©€í‹°ê²Œì„</span>
                </button>
                <!-- TODO: 30ê³¡ ì±Œë¦°ì§€ íƒ­ (ì¶”í›„ í™œì„±í™” ì˜ˆì •)
                <button class="mode-tab" data-mode="best30">
                    <span class="tab-icon">ğŸ…</span>
                    <span class="tab-label">30ê³¡ ì±Œë¦°ì§€</span>
                </button>
                -->
            </div>

            <!-- ê¸°ê°„ íƒ­ (ë‚´ê°€ë§ì¶”ê¸°ìš©) -->
            <div class="period-tabs" id="guessPeriodTabs">
                <button class="period-tab active" data-period="all">
                    <span class="tab-label">ì „ì²´</span>
                </button>
                <button class="period-tab" data-period="weekly">
                    <span class="tab-label">ì´ë²ˆ ì£¼</span>
                </button>
                <button class="period-tab" data-period="best">
                    <span class="tab-label">ìµœê³ ê¸°ë¡</span>
                </button>
            </div>

            <!-- 30ê³¡ ì±Œë¦°ì§€ ê¸°ê°„ íƒ­ -->
            <div class="period-tabs" id="best30PeriodTabs" style="display: none;">
                <button class="period-tab active" data-period="weekly">
                    <span class="tab-label">ğŸ—“ï¸ ì´ë²ˆ ì£¼</span>
                </button>
                <button class="period-tab" data-period="monthly">
                    <span class="tab-label">ğŸ“… ì´ë²ˆ ë‹¬</span>
                </button>
                <button class="period-tab" data-period="alltime">
                    <span class="tab-label">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span>
                </button>
            </div>

            <!-- ìµœê³ ê¸°ë¡ ì•ˆë‚´ (best íƒ­ì—ì„œë§Œ í‘œì‹œ) -->
            <div class="best-score-notice" id="bestScoreNotice" style="display: none;">
                <span class="notice-icon">ğŸ’¡</span>
                <span class="notice-text">ì „ì²´ëœë¤ + í•„í„°ì—†ìŒ + 10ë¼ìš´ë“œ ì´ìƒ ê²Œì„ë§Œ ì§‘ê³„ë©ë‹ˆë‹¤</span>
            </div>

            <!-- 30ê³¡ ì±Œë¦°ì§€ ì•ˆë‚´ -->
            <div class="best-score-notice" id="best30Notice" style="display: none;">
                <span class="notice-icon">ğŸ¯</span>
                <span class="notice-text">30ê³¡ ê²Œì„ ìµœê³ ì  ê¸°ì¤€ Â· ìµœëŒ€ 300ì (30ê³¡ Ã— 10ì ) Â· ë™ì  ì‹œ ë¨¼ì € ë‹¬ì„±í•œ ì‚¬ëŒ ìš°ì„ </span>
            </div>


            <!-- ë‚´ê°€ë§ì¶”ê¸° ë­í‚¹ ê¸°ì¤€ íƒ­ (6ê°€ì§€) -->
            <div class="ranking-type-tabs guess-type-tabs" id="guessTypeTabsContainer">
                <button class="type-tab active" data-type="score">
                    <span class="tab-icon">ğŸ¯</span>
                    <span class="tab-label">ì´ì </span>
                </button>
                <button class="type-tab" data-type="accuracy">
                    <span class="tab-icon">âœ…</span>
                    <span class="tab-label">ì •ë‹µë¥ </span>
                </button>
                <button class="type-tab" data-type="avgScore">
                    <span class="tab-icon">ğŸ“Š</span>
                    <span class="tab-label">í‰ê· ì ìˆ˜</span>
                </button>
                <button class="type-tab" data-type="correct">
                    <span class="tab-icon">ğŸ…</span>
                    <span class="tab-label">ìµœë‹¤ì •ë‹µ</span>
                </button>
                <button class="type-tab" data-type="games">
                    <span class="tab-icon">ğŸ®</span>
                    <span class="tab-label">í”Œë ˆì´ì™•</span>
                </button>
                <button class="type-tab" data-type="rounds">
                    <span class="tab-icon">ğŸ”¥</span>
                    <span class="tab-label">ë„ì „ì™•</span>
                </button>
            </div>

            <!-- ë©€í‹°ê²Œì„ LP ë­í‚¹ ì•ˆë‚´ -->
            <div class="best-score-notice" id="multiLpNotice" style="display: none;">
                <span class="notice-icon">ğŸ†</span>
                <span class="notice-text">ë©€í‹°ê²Œì„ ìˆœìœ„ì— ë”°ë¼ LPë¥¼ íšë“í•˜ì—¬ í‹°ì–´ê°€ ê²°ì •ë©ë‹ˆë‹¤</span>
            </div>

            <!-- TOP 3 í¬ë””ì›€ -->
            <div class="top-three-podium" id="topThreePodium">
                <div class="podium-place second" id="place2">
                    <div class="podium-avatar">ğŸ¥ˆ</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">2</div>
                </div>
                <div class="podium-place first" id="place1">
                    <div class="podium-avatar">ğŸ¥‡</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">1</div>
                </div>
                <div class="podium-place third" id="place3">
                    <div class="podium-avatar">ğŸ¥‰</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">3</div>
                </div>
            </div>

            <!-- ì „ì²´ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
            <div class="ranking-table-section">
                <div class="ranking-table" id="rankingTable">
                    <!-- JSì—ì„œ ë¡œë”© -->
                </div>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <span class="empty-icon">ğŸ“Š</span>
                    <p>ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="empty-sub">ê²Œì„ì„ í”Œë ˆì´í•˜ê³  ë­í‚¹ì— ë„ì „í•˜ì„¸ìš”!</p>
                </div>
            </div>
        </div>
    </main>

</div>

<script th:src="@{/js/common/common.js}"></script>
<script>
    let currentMode = 'guess';
    let currentType = 'score';
    let currentPeriod = 'all';
    let best30Period = 'weekly';  // 30ê³¡ ì±Œë¦°ì§€ ê¸°ê°„
    let showAllBest30 = false;    // 30ê³¡ ë­í‚¹ ì „ì²´ í‘œì‹œ ì—¬ë¶€

    document.addEventListener('DOMContentLoaded', function() {
        loadRanking();
        setupTabs();
    });

    function setupTabs() {
        // ê²Œì„ ëª¨ë“œ íƒ­
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;

                // íƒ€ì… ë¦¬ì…‹ (ëª¨ë“œ ë³€ê²½ ì‹œ)
                currentType = 'score';
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.type-tab[data-type="score"]').forEach(t => t.classList.add('active'));

                // ëª¨ë“œë³„ ê¸°ë³¸ ê¸°ê°„ ì„¤ì •
                if (currentMode === 'multi') {
                    currentPeriod = 'tier';
                } else if (currentMode === 'best30') {
                    best30Period = 'weekly';
                    // 30ê³¡ ê¸°ê°„ íƒ­ ì´ˆê¸°í™”
                    document.querySelectorAll('#best30PeriodTabs .period-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('#best30PeriodTabs .period-tab[data-period="weekly"]').classList.add('active');
                    showAllBest30 = false;
                } else {
                    currentPeriod = 'all';
                    document.querySelectorAll('#guessPeriodTabs .period-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('#guessPeriodTabs .period-tab[data-period="all"]').classList.add('active');
                }

                updateTypeTabsVisibility();
                loadRanking();
            });
        });

        // ë‚´ê°€ë§ì¶”ê¸° ê¸°ê°„ íƒ­
        document.querySelectorAll('#guessPeriodTabs .period-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (currentMode !== 'guess') return;

                document.querySelectorAll('#guessPeriodTabs .period-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.dataset.period;

                updateTypeTabsVisibility();
                loadRanking();
            });
        });

        // 30ê³¡ ì±Œë¦°ì§€ ê¸°ê°„ íƒ­
        document.querySelectorAll('#best30PeriodTabs .period-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (currentMode !== 'best30') return;

                document.querySelectorAll('#best30PeriodTabs .period-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                best30Period = this.dataset.period;
                showAllBest30 = false;

                loadRanking();
            });
        });

        // ë­í‚¹ ê¸°ì¤€ íƒ­ (ë‚´ê°€ë§ì¶”ê¸°)
        document.querySelectorAll('#guessTypeTabsContainer .type-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('#guessTypeTabsContainer .type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentType = this.dataset.type;
                loadRanking();
            });
        });
    }

    function updateTypeTabsVisibility() {
        const guessTypeTabsContainer = document.getElementById('guessTypeTabsContainer');
        const bestScoreNotice = document.getElementById('bestScoreNotice');
        const multiLpNotice = document.getElementById('multiLpNotice');
        const best30Notice = document.getElementById('best30Notice');
        const guessPeriodTabs = document.getElementById('guessPeriodTabs');
        const best30PeriodTabs = document.getElementById('best30PeriodTabs');

        // ëª¨ë‘ ìˆ¨ê¸°ê¸°
        bestScoreNotice.style.display = 'none';
        multiLpNotice.style.display = 'none';
        best30Notice.style.display = 'none';
        guessPeriodTabs.style.display = 'none';
        best30PeriodTabs.style.display = 'none';
        guessTypeTabsContainer.style.display = 'none';

        if (currentMode === 'multi') {
            multiLpNotice.style.display = 'flex';
        } else if (currentMode === 'best30') {
            best30PeriodTabs.style.display = 'flex';
            best30Notice.style.display = 'flex';
        } else {
            // ë‚´ê°€ë§ì¶”ê¸°
            guessPeriodTabs.style.display = 'flex';

            if (currentPeriod === 'all') {
                guessTypeTabsContainer.style.display = 'flex';
            } else if (currentPeriod === 'best') {
                bestScoreNotice.style.display = 'flex';
            }
        }
    }

    async function loadRanking() {
        try {
            let rankings;

            if (currentMode === 'best30') {
                // 30ê³¡ ì±Œë¦°ì§€ ë­í‚¹
                const response = await fetch(`/api/ranking/best30?period=${best30Period}&limit=50`);
                rankings = await response.json();
                updateBest30UI(rankings);
            } else {
                // ê¸°ì¡´ ë­í‚¹
                const response = await fetch(`/api/ranking?mode=${currentMode}&type=${currentType}&period=${currentPeriod}&limit=20`);
                rankings = await response.json();
                updateNormalUI(rankings);
            }
        } catch (error) {
            console.error('ë­í‚¹ ë¡œë”© ì˜¤ë¥˜:', error);
        }
    }

    function updateNormalUI(rankings) {
        if (rankings.length === 0) {
            document.getElementById('topThreePodium').style.display = 'none';
            document.getElementById('rankingTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            return;
        }

        document.getElementById('topThreePodium').style.display = 'flex';
        document.getElementById('rankingTable').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';

        updatePodium(rankings);
        updateTable(rankings);
    }

    function updateBest30UI(rankings) {
        if (rankings.length === 0) {
            document.getElementById('topThreePodium').style.display = 'none';
            document.getElementById('rankingTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            return;
        }

        document.getElementById('topThreePodium').style.display = 'flex';
        document.getElementById('rankingTable').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';

        updateBest30Podium(rankings);
        updateBest30Table(rankings);
    }

    function updatePodium(rankings) {
        const places = [
            { id: 'place1', index: 0 },
            { id: 'place2', index: 1 },
            { id: 'place3', index: 2 }
        ];

        places.forEach(place => {
            const el = document.getElementById(place.id);
            const member = rankings[place.index];

            if (member) {
                el.style.display = 'flex';
                const badgeEmoji = member.badgeEmoji ? member.badgeEmoji + ' ' : '';
                el.querySelector('.podium-name').textContent = badgeEmoji + member.nickname;
                el.querySelector('.podium-value').textContent = formatValue(member);

                const tierEl = el.querySelector('.podium-tier');
                if (currentMode === 'multi') {
                    tierEl.textContent = member.multiTierDisplayName || '';
                    tierEl.style.color = member.multiTierColor || '#cd7f32';
                    tierEl.className = 'podium-tier tier-badge tier-' + (member.multiTier || 'BRONZE').toLowerCase();
                    tierEl.style.display = 'block';
                } else {
                    tierEl.textContent = '';
                    tierEl.style.display = 'none';
                }
            } else {
                el.style.display = 'none';
            }
        });
    }

    function updateBest30Podium(rankings) {
        const places = [
            { id: 'place1', index: 0 },
            { id: 'place2', index: 1 },
            { id: 'place3', index: 2 }
        ];

        places.forEach(place => {
            const el = document.getElementById(place.id);
            const member = rankings[place.index];

            if (member) {
                el.style.display = 'flex';
                const badgeEmoji = member.badgeEmoji ? member.badgeEmoji + ' ' : '';
                el.querySelector('.podium-name').textContent = badgeEmoji + member.nickname;
                el.querySelector('.podium-value').textContent = (member.score || 0) + 'ì ';
                el.querySelector('.podium-stand').textContent = member.rank;  // ë™ì ì ì²˜ë¦¬ëœ ìˆœìœ„

                const tierEl = el.querySelector('.podium-tier');
                tierEl.textContent = '';
                tierEl.style.display = 'none';
            } else {
                el.style.display = 'none';
            }
        });
    }

    function updateTable(rankings) {
        const table = document.getElementById('rankingTable');

        table.innerHTML = rankings.map((member, index) => {
            const showTier = currentMode === 'multi';
            const tierName = member.multiTier || 'BRONZE';
            const tierColor = member.multiTierColor || '#cd7f32';
            const tierDisplayName = member.multiTierDisplayName || '';
            const badgeEmoji = member.badgeEmoji ? `<span class="member-badge" title="${member.badgeName || ''}">${member.badgeEmoji}</span>` : '';

            return `
                <div class="ranking-row ${index < 3 ? 'top-' + (index + 1) : ''}">
                    <div class="rank-cell">
                        ${index < 3 ? getMedal(index) : (index + 1)}
                    </div>
                    <div class="name-cell">
                        ${showTier ? `<span class="tier-badge tier-${tierName.toLowerCase()}" style="color: ${tierColor}">${tierDisplayName}</span>` : ''}
                        ${badgeEmoji}
                        <span class="member-name">${member.nickname}</span>
                    </div>
                    <div class="stats-cell">
                        <span class="main-stat">${formatValue(member)}</span>
                        <span class="sub-stat">${formatSubStat(member)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateBest30Table(rankings) {
        const table = document.getElementById('rankingTable');
        const top10 = rankings.slice(0, 10);
        const rest = rankings.slice(10);

        let html = top10.map((member, index) => {
            const badgeEmoji = member.badgeEmoji ? `<span class="member-badge" title="${member.badgeName || ''}">${member.badgeEmoji}</span>` : '';
            const achievedDate = member.achievedAt ? new Date(member.achievedAt).toLocaleDateString('ko-KR') : '';

            return `
                <div class="ranking-row ${index < 3 ? 'top-' + (index + 1) : ''}">
                    <div class="rank-cell">
                        ${member.rank <= 3 ? getMedal(member.rank - 1) : member.rank + 'ìœ„'}
                    </div>
                    <div class="name-cell">
                        ${badgeEmoji}
                        <span class="member-name">${member.nickname}</span>
                    </div>
                    <div class="stats-cell">
                        <span class="main-stat">${(member.score || 0).toLocaleString()}ì </span>
                        <span class="sub-stat">${achievedDate}</span>
                    </div>
                </div>
            `;
        }).join('');

        // 10ìœ„ ì´í›„ ì ‘ê¸°/í¼ì¹˜ê¸°
        if (rest.length > 0) {
            const restHtml = rest.map((member) => {
                const badgeEmoji = member.badgeEmoji ? `<span class="member-badge" title="${member.badgeName || ''}">${member.badgeEmoji}</span>` : '';
                const achievedDate = member.achievedAt ? new Date(member.achievedAt).toLocaleDateString('ko-KR') : '';

                return `
                    <div class="ranking-row">
                        <div class="rank-cell">${member.rank}ìœ„</div>
                        <div class="name-cell">
                            ${badgeEmoji}
                            <span class="member-name">${member.nickname}</span>
                        </div>
                        <div class="stats-cell">
                            <span class="main-stat">${(member.score || 0).toLocaleString()}ì </span>
                            <span class="sub-stat">${achievedDate}</span>
                        </div>
                    </div>
                `;
            }).join('');

            html += `
                <div class="ranking-expand-section">
                    <button class="expand-toggle" onclick="toggleBest30Expand()">
                        <span id="expandIcon">â–¼</span> ${rest.length}ëª… ë”ë³´ê¸°
                    </button>
                    <div class="ranking-rest" id="best30Rest" style="display: ${showAllBest30 ? 'block' : 'none'};">
                        ${restHtml}
                    </div>
                </div>
            `;
        }

        table.innerHTML = html;
    }

    function toggleBest30Expand() {
        showAllBest30 = !showAllBest30;
        const restEl = document.getElementById('best30Rest');
        const iconEl = document.getElementById('expandIcon');

        if (showAllBest30) {
            restEl.style.display = 'block';
            iconEl.textContent = 'â–²';
        } else {
            restEl.style.display = 'none';
            iconEl.textContent = 'â–¼';
        }
    }

    function getMedal(index) {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        return medals[index] || (index + 1);
    }

    function formatValue(member) {
        if (currentMode === 'multi') {
            return (member.multiLp || 0) + ' LP';
        }

        if (currentPeriod === 'best' || currentPeriod === 'weekly') {
            return member.totalScore.toLocaleString() + 'ì ';
        }

        switch(currentType) {
            case 'score':
                return member.totalScore.toLocaleString() + 'ì ';
            case 'accuracy':
                return member.accuracyRate.toFixed(1) + '%';
            case 'avgScore':
                return (member.averageScore || 0).toFixed(1) + 'ì ';
            case 'correct':
                return member.totalCorrect + 'ê°œ';
            case 'games':
                return member.totalGames + 'ê²Œì„';
            case 'rounds':
                return member.totalRounds + 'ë¼ìš´ë“œ';
            default:
                return member.totalScore.toLocaleString() + 'ì ';
        }
    }

    function formatSubStat(member) {
        if (currentMode === 'multi') {
            return '1ë“± ' + (member.multiWins || 0) + 'íšŒ Â· Top3 ' + (member.multiTop3 || 0) + 'íšŒ';
        }

        if (currentPeriod === 'best') {
            return 'ìµœê³  ì •ë‹µë¥  ' + member.accuracyRate.toFixed(1) + '%';
        }
        if (currentPeriod === 'weekly') {
            return member.totalGames + 'ê²Œì„ Â· ' + member.accuracyRate.toFixed(1) + '%';
        }

        switch(currentType) {
            case 'score':
                return member.totalGames + 'ê²Œì„ Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'accuracy':
                return member.totalCorrect + '/' + member.totalRounds + 'ë¬¸ì œ';
            case 'avgScore':
                return member.totalGames + 'ê²Œì„ Â· ì´ ' + member.totalScore.toLocaleString() + 'ì ';
            case 'correct':
                return member.totalRounds + 'ë¼ìš´ë“œ Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'games':
                return member.totalScore.toLocaleString() + 'ì  Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'rounds':
                return member.totalGames + 'ê²Œì„ Â· ' + member.totalCorrect + 'ì •ë‹µ';
            default:
                return member.totalGames + 'ê²Œì„';
        }
    }
</script>
</body>
</html>
