<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: clientHead('ì „ì²´ ë­í‚¹ - Song Quiz')}"></head>
<body class="client-page ranking-page">
<div class="client-container">
    <header class="client-header compact">
        <a href="/" class="back-home">â† í™ˆìœ¼ë¡œ</a>
        <h1>ğŸ† ì „ì²´ ë­í‚¹</h1>
        <p>Song Quiz ìµœê³ ì˜ í”Œë ˆì´ì–´ë“¤</p>
    </header>

    <main class="client-main">
        <div class="ranking-content">
            <!-- ê²Œì„ ëª¨ë“œ íƒ­ -->
            <div class="game-mode-tabs">
                <button class="mode-tab active" data-mode="guess">
                    <span class="tab-icon">ğŸ§</span>
                    <span class="tab-label">ë‚´ê°€ë§ì¶”ê¸°</span>
                </button>
                <button class="mode-tab" data-mode="multi">
                    <span class="tab-icon">ğŸ‘¥</span>
                    <span class="tab-label">ë©€í‹°ê²Œì„</span>
                </button>
            </div>

            <!-- ê¸°ê°„ íƒ­ -->
            <div class="period-tabs">
                <button class="period-tab active" data-period="all">
                    <span class="tab-label">ì „ì²´</span>
                </button>
                <button class="period-tab" data-period="weekly">
                    <span class="tab-label">ì´ë²ˆ ì£¼</span>
                </button>
                <button class="period-tab" data-period="best">
                    <span class="tab-label">ìµœê³ ê¸°ë¡</span>
                </button>
            </div>

            <!-- ìµœê³ ê¸°ë¡ ì•ˆë‚´ (best íƒ­ì—ì„œë§Œ í‘œì‹œ) -->
            <div class="best-score-notice" id="bestScoreNotice" style="display: none;">
                <span class="notice-icon">ğŸ’¡</span>
                <span class="notice-text">ì „ì²´ëœë¤ + í•„í„°ì—†ìŒ + 10ë¼ìš´ë“œ ì´ìƒ ê²Œì„ë§Œ ì§‘ê³„ë©ë‹ˆë‹¤</span>
            </div>


            <!-- ë‚´ê°€ë§ì¶”ê¸° ë­í‚¹ ê¸°ì¤€ íƒ­ (6ê°€ì§€) -->
            <div class="ranking-type-tabs guess-type-tabs" id="guessTypeTabsContainer">
                <button class="type-tab active" data-type="score">
                    <span class="tab-icon">ğŸ¯</span>
                    <span class="tab-label">ì´ì </span>
                </button>
                <button class="type-tab" data-type="accuracy">
                    <span class="tab-icon">âœ…</span>
                    <span class="tab-label">ì •ë‹µë¥ </span>
                </button>
                <button class="type-tab" data-type="avgScore">
                    <span class="tab-icon">ğŸ“Š</span>
                    <span class="tab-label">í‰ê· ì ìˆ˜</span>
                </button>
                <button class="type-tab" data-type="correct">
                    <span class="tab-icon">ğŸ…</span>
                    <span class="tab-label">ìµœë‹¤ì •ë‹µ</span>
                </button>
                <button class="type-tab" data-type="games">
                    <span class="tab-icon">ğŸ®</span>
                    <span class="tab-label">í”Œë ˆì´ì™•</span>
                </button>
                <button class="type-tab" data-type="rounds">
                    <span class="tab-icon">ğŸ”¥</span>
                    <span class="tab-label">ë„ì „ì™•</span>
                </button>
            </div>

            <!-- ë©€í‹°ê²Œì„ LP ë­í‚¹ ì•ˆë‚´ -->
            <div class="best-score-notice" id="multiLpNotice" style="display: none;">
                <span class="notice-icon">ğŸ†</span>
                <span class="notice-text">ë©€í‹°ê²Œì„ ìˆœìœ„ì— ë”°ë¼ LPë¥¼ íšë“í•˜ì—¬ í‹°ì–´ê°€ ê²°ì •ë©ë‹ˆë‹¤</span>
            </div>

            <!-- TOP 3 í¬ë””ì›€ -->
            <div class="top-three-podium" id="topThreePodium">
                <div class="podium-place second" id="place2">
                    <div class="podium-avatar">ğŸ¥ˆ</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">2</div>
                </div>
                <div class="podium-place first" id="place1">
                    <div class="podium-avatar">ğŸ¥‡</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">1</div>
                </div>
                <div class="podium-place third" id="place3">
                    <div class="podium-avatar">ğŸ¥‰</div>
                    <div class="podium-tier"></div>
                    <div class="podium-name">-</div>
                    <div class="podium-value">-</div>
                    <div class="podium-stand">3</div>
                </div>
            </div>

            <!-- ì „ì²´ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
            <div class="ranking-table-section">
                <div class="ranking-table" id="rankingTable">
                    <!-- JSì—ì„œ ë¡œë”© -->
                </div>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <span class="empty-icon">ğŸ“Š</span>
                    <p>ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="empty-sub">ê²Œì„ì„ í”Œë ˆì´í•˜ê³  ë­í‚¹ì— ë„ì „í•˜ì„¸ìš”!</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="client-footer">
        <a href="/admin/song" class="admin-link">ê´€ë¦¬ì</a>
    </footer>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script>
    let currentMode = 'guess';
    let currentType = 'score';
    let currentPeriod = 'all';

    document.addEventListener('DOMContentLoaded', function() {
        loadRanking();
        setupTabs();
    });

    function setupTabs() {
        // ê²Œì„ ëª¨ë“œ íƒ­
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;

                // ëª¨ë“œì— ë”°ë¥¸ UI ì „í™˜
                updateTypeTabsVisibility();

                // íƒ€ì… ë¦¬ì…‹ (ëª¨ë“œ ë³€ê²½ ì‹œ)
                currentType = 'score';
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.type-tab[data-type="score"]').forEach(t => t.classList.add('active'));

                // ë©€í‹°ê²Œì„ì€ period ë¬´ì‹œ (í•­ìƒ tier ë­í‚¹)
                if (currentMode === 'multi') {
                    currentPeriod = 'tier';
                } else {
                    currentPeriod = 'all';
                    document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.period-tab[data-period="all"]').classList.add('active');
                }

                loadRanking();
            });
        });

        // ê¸°ê°„ íƒ­ (ë‚´ê°€ë§ì¶”ê¸° ëª¨ë“œì—ì„œë§Œ ë™ì‘)
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (currentMode === 'multi') return; // ë©€í‹°ê²Œì„ì—ì„œëŠ” ê¸°ê°„ íƒ­ ë¬´ì‹œ

                document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.dataset.period;

                // ì „ì²´ ê¸°ê°„ì¼ ë•Œë§Œ íƒ€ì… íƒ­ í‘œì‹œ
                updateTypeTabsVisibility();

                loadRanking();
            });
        });

        // ë­í‚¹ ê¸°ì¤€ íƒ­ (ë‚´ê°€ë§ì¶”ê¸°)
        document.querySelectorAll('#guessTypeTabsContainer .type-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('#guessTypeTabsContainer .type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentType = this.dataset.type;
                loadRanking();
            });
        });
    }

    function updateTypeTabsVisibility() {
        const guessTypeTabsContainer = document.getElementById('guessTypeTabsContainer');
        const bestScoreNotice = document.getElementById('bestScoreNotice');
        const multiLpNotice = document.getElementById('multiLpNotice');
        const periodTabs = document.querySelector('.period-tabs');

        // ê³µì§€ ì´ˆê¸°í™”
        bestScoreNotice.style.display = 'none';
        multiLpNotice.style.display = 'none';

        if (currentMode === 'multi') {
            // ë©€í‹°ê²Œì„: ê¸°ê°„ íƒ­/íƒ€ì… íƒ­ ìˆ¨ê¸°ê³  LP ì•ˆë‚´ í‘œì‹œ
            periodTabs.style.display = 'none';
            guessTypeTabsContainer.style.display = 'none';
            multiLpNotice.style.display = 'flex';
        } else {
            // ë‚´ê°€ë§ì¶”ê¸°: ê¸°ê°„ íƒ­ í‘œì‹œ
            periodTabs.style.display = 'flex';

            if (currentPeriod === 'all') {
                guessTypeTabsContainer.style.display = 'flex';
            } else if (currentPeriod === 'best') {
                guessTypeTabsContainer.style.display = 'none';
                bestScoreNotice.style.display = 'flex';
            } else {
                // weekly
                guessTypeTabsContainer.style.display = 'none';
            }
        }
    }

    async function loadRanking() {
        try {
            const response = await fetch(`/api/ranking?mode=${currentMode}&type=${currentType}&period=${currentPeriod}&limit=20`);
            const rankings = await response.json();

            if (rankings.length === 0) {
                document.getElementById('topThreePodium').style.display = 'none';
                document.getElementById('rankingTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
                return;
            }

            document.getElementById('topThreePodium').style.display = 'flex';
            document.getElementById('rankingTable').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            // TOP 3 í¬ë””ì›€
            updatePodium(rankings);

            // ì „ì²´ ë­í‚¹ í…Œì´ë¸”
            updateTable(rankings);
        } catch (error) {
            console.error('ë­í‚¹ ë¡œë”© ì˜¤ë¥˜:', error);
        }
    }

    function updatePodium(rankings) {
        const places = [
            { id: 'place1', index: 0 },
            { id: 'place2', index: 1 },
            { id: 'place3', index: 2 }
        ];

        places.forEach(place => {
            const el = document.getElementById(place.id);
            const member = rankings[place.index];

            if (member) {
                el.style.display = 'flex';
                el.querySelector('.podium-name').textContent = member.nickname;
                el.querySelector('.podium-value').textContent = formatValue(member);

                // í‹°ì–´ ë°°ì§€ ì¶”ê°€ (ë©€í‹°ê²Œì„ë§Œ í‘œì‹œ)
                const tierEl = el.querySelector('.podium-tier');
                if (currentMode === 'multi') {
                    tierEl.textContent = member.multiTierDisplayName || '';
                    tierEl.style.color = member.multiTierColor || '#cd7f32';
                    tierEl.className = 'podium-tier tier-badge tier-' + (member.multiTier || 'BRONZE').toLowerCase();
                    tierEl.style.display = 'block';
                } else {
                    // ë‚´ê°€ë§ì¶”ê¸°ì—ì„œëŠ” í‹°ì–´ ìˆ¨ê¹€
                    tierEl.textContent = '';
                    tierEl.style.display = 'none';
                }
            } else {
                el.style.display = 'none';
            }
        });
    }

    function updateTable(rankings) {
        const table = document.getElementById('rankingTable');

        table.innerHTML = rankings.map((member, index) => {
            // ë©€í‹°ê²Œì„ë§Œ í‹°ì–´ í‘œì‹œ
            const showTier = currentMode === 'multi';
            const tierName = member.multiTier || 'BRONZE';
            const tierColor = member.multiTierColor || '#cd7f32';
            const tierDisplayName = member.multiTierDisplayName || '';

            return `
                <div class="ranking-row ${index < 3 ? 'top-' + (index + 1) : ''}">
                    <div class="rank-cell">
                        ${index < 3 ? getMedal(index) : (index + 1)}
                    </div>
                    <div class="name-cell">
                        ${showTier ? `<span class="tier-badge tier-${tierName.toLowerCase()}" style="color: ${tierColor}">${tierDisplayName}</span>` : ''}
                        <span class="member-name">${member.nickname}</span>
                    </div>
                    <div class="stats-cell">
                        <span class="main-stat">${formatValue(member)}</span>
                        <span class="sub-stat">${formatSubStat(member)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getMedal(index) {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        return medals[index] || (index + 1);
    }

    function formatValue(member) {
        // ë©€í‹°ê²Œì„: LPë§Œ í‘œì‹œ
        if (currentMode === 'multi') {
            return (member.multiLp || 0) + ' LP';
        }

        // ë‚´ê°€ë§ì¶”ê¸°
        if (currentPeriod === 'best') {
            return member.totalScore.toLocaleString() + 'ì ';
        }
        if (currentPeriod === 'weekly') {
            return member.totalScore.toLocaleString() + 'ì ';
        }

        // ë‚´ê°€ë§ì¶”ê¸° 6ê°€ì§€ íƒ€ì…
        switch(currentType) {
            case 'score':
                return member.totalScore.toLocaleString() + 'ì ';
            case 'accuracy':
                return member.accuracyRate.toFixed(1) + '%';
            case 'avgScore':
                return (member.averageScore || 0).toFixed(1) + 'ì ';
            case 'correct':
                return member.totalCorrect + 'ê°œ';
            case 'games':
                return member.totalGames + 'ê²Œì„';
            case 'rounds':
                return member.totalRounds + 'ë¼ìš´ë“œ';
            default:
                return member.totalScore.toLocaleString() + 'ì ';
        }
    }

    function formatSubStat(member) {
        // ë©€í‹°ê²Œì„: 1ë“±/Top3 íšŸìˆ˜ í‘œì‹œ
        if (currentMode === 'multi') {
            return '1ë“± ' + (member.multiWins || 0) + 'íšŒ Â· Top3 ' + (member.multiTop3 || 0) + 'íšŒ';
        }

        // ë‚´ê°€ë§ì¶”ê¸°
        if (currentPeriod === 'best') {
            return 'ìµœê³  ì •ë‹µë¥  ' + member.accuracyRate.toFixed(1) + '%';
        }
        if (currentPeriod === 'weekly') {
            return member.totalGames + 'ê²Œì„ Â· ' + member.accuracyRate.toFixed(1) + '%';
        }

        // ë‚´ê°€ë§ì¶”ê¸° 6ê°€ì§€ íƒ€ì…
        switch(currentType) {
            case 'score':
                return member.totalGames + 'ê²Œì„ Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'accuracy':
                return member.totalCorrect + '/' + member.totalRounds + 'ë¬¸ì œ';
            case 'avgScore':
                return member.totalGames + 'ê²Œì„ Â· ì´ ' + member.totalScore.toLocaleString() + 'ì ';
            case 'correct':
                return member.totalRounds + 'ë¼ìš´ë“œ Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'games':
                return member.totalScore.toLocaleString() + 'ì  Â· ' + member.accuracyRate.toFixed(1) + '%';
            case 'rounds':
                return member.totalGames + 'ê²Œì„ Â· ' + member.totalCorrect + 'ì •ë‹µ';
            default:
                return member.totalGames + 'ê²Œì„';
        }
    }
</script>
</body>
</html>
