<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('채팅 내역')}"></head>
<link rel="stylesheet" href="/css/admin/table-mobile-collapse.css">
<body class="admin-page">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="admin-main">
        <header class="admin-header">
            <h1>채팅 내역</h1>
            <p>게임 방 채팅 내역을 조회하고 관리합니다.</p>
        </header>

        <div class="admin-content">
            <!-- 필터 섹션 -->
            <div class="filter-section">
                <form action="/admin/chat" method="get" class="filter-form-grid">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>메시지 검색</label>
                            <input type="text" name="keyword" th:value="${keyword}" placeholder="메시지 내용">
                        </div>
                        <div class="filter-group">
                            <label>방 코드</label>
                            <input type="text" name="roomCode" th:value="${roomCode}" placeholder="방 코드">
                        </div>
                        <div class="filter-group">
                            <label>닉네임</label>
                            <input type="text" name="nickname" th:value="${nickname}" placeholder="닉네임">
                        </div>
                        <div class="filter-group">
                            <label>타입</label>
                            <select name="messageType">
                                <option value="">전체</option>
                                <option value="CHAT" th:selected="${messageType == 'CHAT'}">일반 채팅</option>
                                <option value="CORRECT_ANSWER" th:selected="${messageType == 'CORRECT_ANSWER'}">정답</option>
                                <option value="SYSTEM" th:selected="${messageType == 'SYSTEM'}">시스템</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>기간</label>
                            <div class="date-range">
                                <input type="date" name="startDate" th:value="${startDate}">
                                <span>~</span>
                                <input type="date" name="endDate" th:value="${endDate}">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button type="submit" class="btn btn-search">검색</button>
                            <a href="/admin/chat" class="btn btn-reset">초기화</a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 선택 삭제 버튼 -->
            <div class="table-actions">
                <button class="btn btn-danger" id="deleteSelectedBtn" disabled>선택 삭제</button>
                <span class="selected-count">선택: <span id="selectedCount">0</span>개</span>
            </div>

            <!-- 테이블 -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>ID</th>
                        <th>방 코드</th>
                        <th>닉네임</th>
                        <th>메시지</th>
                        <th>타입</th>
                        <th>일시</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="chat : ${chats}" th:classappend="${chat.messageType.name() == 'CORRECT_ANSWER'} ? 'correct-row'" onclick="toggleRowExpand(this)">
                        <td data-label="" onclick="event.stopPropagation()"><input type="checkbox" class="chat-checkbox" th:value="${chat.id}"></td>
                        <td data-label="ID" th:text="${chat.id}"></td>
                        <td data-label="방 코드"><code th:text="${chat.gameRoom?.roomCode ?: '-'}"></code></td>
                        <td data-label="닉네임" th:text="${chat.member?.nickname ?: '-'}"></td>
                        <td data-label="메시지" class="message-cell">
                            <span th:text="${chat.message}"></span>
                        </td>
                        <td data-label="타입">
                            <span class="message-type"
                                  th:classappend="${chat.messageType.name()}"
                                  th:text="${chat.messageType.name() == 'CHAT'} ? '채팅' : (${chat.messageType.name() == 'CORRECT_ANSWER'} ? '정답' : '시스템')"></span>
                        </td>
                        <td data-label="일시" th:text="${#temporals.format(chat.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td class="action-buttons" data-label="" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-delete" th:onclick="'deleteChat(' + ${chat.id} + ')'">삭제</button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(chats)}">
                        <td colspan="8" class="empty-row">채팅 내역이 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" th:if="${totalPages > 0}">
                <a th:href="@{/admin/chat(page=0, keyword=${keyword}, roomCode=${roomCode}, nickname=${nickname}, messageType=${messageType}, startDate=${startDate}, endDate=${endDate})}"
                   th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">«</a>
                <a th:href="@{/admin/chat(page=${currentPage - 1}, keyword=${keyword}, roomCode=${roomCode}, nickname=${nickname}, messageType=${messageType}, startDate=${startDate}, endDate=${endDate})}"
                   th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">‹</a>

                <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:if="${i >= currentPage - 2 and i <= currentPage + 2}"
                       th:href="@{/admin/chat(page=${i}, keyword=${keyword}, roomCode=${roomCode}, nickname=${nickname}, messageType=${messageType}, startDate=${startDate}, endDate=${endDate})}"
                       th:text="${i + 1}"
                       th:classappend="${i == currentPage} ? 'active'" class="page-link"></a>
                </th:block>

                <a th:href="@{/admin/chat(page=${currentPage + 1}, keyword=${keyword}, roomCode=${roomCode}, nickname=${nickname}, messageType=${messageType}, startDate=${startDate}, endDate=${endDate})}"
                   th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">›</a>
                <a th:href="@{/admin/chat(page=${totalPages - 1}, keyword=${keyword}, roomCode=${roomCode}, nickname=${nickname}, messageType=${messageType}, startDate=${startDate}, endDate=${endDate})}"
                   th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">»</a>
            </div>

            <div class="page-info">
                총 <strong th:text="${totalItems}">0</strong>개의 채팅
            </div>
        </div>
    </main>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/admin/admin-chat.js}"></script>
<script>
function toggleRowExpand(row) {
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}
</script>
</body>
</html>