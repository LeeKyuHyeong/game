<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('ê²Œì„ ê´€ë¦¬')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<link rel="stylesheet" th:href="@{/css/admin/mobile-stats.css}">
<link rel="stylesheet" th:href="@{/css/admin/ranking-tier.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>ê²Œì„ ê´€ë¦¬</h1>
        </header>

        <!-- í†µí•© í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">ğŸ®</div>
                <div class="stat-info">
                    <span class="stat-value" th:text="${todayCount} ?: 0">0</span>
                    <span class="stat-label">ì˜¤ëŠ˜ ê²Œì„</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-info">
                    <span class="stat-value" th:text="${#numbers.formatDecimal(avgScore ?: 0, 0, 1)}">0</span>
                    <span class="stat-label">í‰ê·  ì ìˆ˜</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-info">
                    <span class="stat-value" th:text="${totalGames} ?: 0">0</span>
                    <span class="stat-label">ì „ì²´ ê²Œì„</span>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation">
            <button class="tab-btn" th:classappend="${activeTab == 'history'} ? 'active'"
                    onclick="switchTab('history')">
                <span class="tab-icon">ğŸ“Š</span>
                <span class="tab-text">ê²Œì„ ì´ë ¥</span>
            </button>
            <button class="tab-btn" th:classappend="${activeTab == 'ranking'} ? 'active'"
                    onclick="switchTab('ranking')">
                <span class="tab-icon">ğŸ†</span>
                <span class="tab-text">ë­í‚¹</span>
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tabContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>ë¡œë”© ì¤‘...</span>
            </div>
        </div>
    </main>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/common/toggle-row-expand.js}"></script>
<script th:src="@{/js/admin/admin-history.js}"></script>
<script th:inline="javascript">
const activeTab = [[${activeTab}]];
let currentTab = activeTab;

document.addEventListener('DOMContentLoaded', () => {
    loadTabContent(currentTab);
});

function switchTab(tab) {
    if (currentTab === tab) return;
    currentTab = tab;

    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);

    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn:nth-child(${tab === 'history' ? 1 : 2})`).classList.add('active');

    loadTabContent(tab);
}

async function loadTabContent(tab, params = '') {
    const tabContent = document.getElementById('tabContent');
    tabContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>ë¡œë”© ì¤‘...</span></div>';

    try {
        const url = tab === 'history'
            ? `/admin/history/content${params ? '?' + params : ''}`
            : `/admin/history/ranking/content${params ? '?' + params : ''}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load content');

        tabContent.innerHTML = await response.text();
        initTabScripts();
    } catch (error) {
        tabContent.innerHTML = `<div class="error-message"><p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button class="btn btn-primary" onclick="loadTabContent('${tab}')">ë‹¤ì‹œ ì‹œë„</button></div>`;
    }
}

function initTabScripts() {
    const filterForm = document.querySelector('.tab-content .filter-form');
    if (filterForm) {
        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(filterForm)).toString();
            loadTabContent(currentTab, params);
        });
    }

    const resetBtn = document.querySelector('.tab-content .btn-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadTabContent(currentTab);
        });
    }
}

function toggleRowExpand(row) {
    if (window.innerWidth <= 768) row.classList.toggle('expanded');
}

function goToPage(page) {
    const form = document.querySelector('.tab-content .filter-form');
    const params = new URLSearchParams();
    if (form) new FormData(form).forEach((v, k) => { if (v) params.set(k, v); });
    params.set('page', page);
    loadTabContent(currentTab, params.toString());
}

function changeRankType(rankType, artist = '') {
    const params = new URLSearchParams();
    params.set('rankType', rankType);
    if (artist) params.set('artist', artist);
    loadTabContent('ranking', params.toString());
}
</script>

<style>
.tab-navigation { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); }
.tab-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; cursor: pointer; font-size: 0.95rem; color: var(--text-secondary); transition: all 0.2s; }
.tab-btn:hover { color: var(--text-primary); background: var(--bg-elevated); }
.tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
.tab-content { min-height: 400px; }
.loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; gap: 1rem; color: var(--text-secondary); }
.spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@media (max-width: 768px) { .tab-btn { flex: 1; justify-content: center; } .tab-text { display: none; } }
</style>
</body>
</html>
