<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('통계 분석')}"></head>
<link rel="stylesheet" th:href="@{/css/admin/stats.css}">
<link rel="stylesheet" th:href="@{/css/admin/mobile-stats.css}">
<body class="admin-page">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>
    <main class="main-content">
        <header class="content-header">
            <h1>통계 분석</h1>
            <p>오답 통계와 대중성 분석을 확인합니다.</p>
        </header>

        <!-- 1차 탭: 오답 통계 / 대중성 통계 -->
        <div class="primary-tabs">
            <button class="primary-tab" th:classappend="${activeTab == 'wrong-answers'} ? 'active'"
                    data-tab="wrong-answers" onclick="switchPrimaryTab('wrong-answers')">
                <span class="tab-icon">❌</span>
                <span class="tab-text">오답 통계</span>
            </button>
            <button class="primary-tab" th:classappend="${activeTab == 'popularity'} ? 'active'"
                    data-tab="popularity" onclick="switchPrimaryTab('popularity')">
                <span class="tab-icon">📊</span>
                <span class="tab-text">대중성 통계</span>
            </button>
        </div>

        <!-- 오답 통계 콘텐츠 -->
        <div class="primary-content" id="wrong-answers-content" th:style="${activeTab != 'wrong-answers'} ? 'display:none'">
            <!-- 요약 카드 -->
            <div class="stats-cards">
                <div class="stat-card gradient">
                    <div class="stat-icon">📝</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${summary.totalWrongCount}">0</span>
                        <span class="stat-label">총 오답 수</span>
                    </div>
                </div>
                <div class="stat-card gradient">
                    <div class="stat-icon">🔤</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${summary.uniqueWrongAnswers}">0</span>
                        <span class="stat-label">고유 오답 종류</span>
                    </div>
                </div>
            </div>

            <!-- 2차 탭 네비게이션 -->
            <div class="stats-tabs">
                <button class="stats-tab active" data-tab="common">자주 틀리는 답변</button>
                <button class="stats-tab" data-tab="hardest">어려운 곡 TOP</button>
                <button class="stats-tab" data-tab="recent">최근 오답</button>
            </div>

            <!-- 자주 틀리는 답변 -->
            <div class="stats-panel" id="commonPanel">
                <div class="panel-header">
                    <h3>🔥 자주 틀리는 답변 TOP 20</h3>
                    <span class="panel-desc">오답과 정답 곡 쌍으로 그룹핑</span>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">순위</th>
                            <th style="width:200px;">오답</th>
                            <th>정답 곡</th>
                            <th style="width:80px;">횟수</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, idx : ${commonWrongAnswers}">
                            <td data-label="순위">
                                <span class="rank-badge" th:classappend="${idx.index < 3} ? 'top-' + (idx.index + 1) : ''">
                                    <span th:text="${idx.index + 1}">1</span>
                                </span>
                            </td>
                            <td data-label="오답">
                                <span class="wrong-text" th:text="${item.answer}">오답</span>
                            </td>
                            <td data-label="정답 곡">
                                <div class="song-info">
                                    <span class="song-title" th:text="${item.songTitle}">제목</span>
                                    <span class="song-artist" th:text="${item.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="횟수" th:text="${item.count} + '회'">0회</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(commonWrongAnswers)}" class="empty-row">
                            <td colspan="4" class="empty-state">
                                아직 오답 데이터가 없습니다.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 어려운 곡 TOP -->
            <div class="stats-panel" id="hardestPanel" style="display:none;">
                <div class="panel-header">
                    <h3>💀 가장 어려운 곡 TOP 20</h3>
                    <span class="panel-desc">최소 5회 이상 플레이된 곡 기준</span>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">순위</th>
                            <th>곡 정보</th>
                            <th style="width:100px;">정답률</th>
                            <th style="width:100px;">플레이</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="song, idx : ${hardestSongs}">
                            <td data-label="순위">
                                <span class="rank-badge" th:classappend="${idx.index < 3} ? 'top-' + (idx.index + 1) : ''">
                                    <span th:text="${idx.index + 1}">1</span>
                                </span>
                            </td>
                            <td data-label="곡 정보">
                                <div class="song-info">
                                    <span class="song-title" th:text="${song.title}">제목</span>
                                    <span class="song-artist" th:text="${song.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="정답률">
                                <div class="rate-bar">
                                    <div class="rate-fill" th:style="'width:' + ${song.correctRate} + '%'"></div>
                                    <span class="rate-text" th:text="${song.correctRate} + '%'">0%</span>
                                </div>
                            </td>
                            <td data-label="플레이" th:text="${song.totalPlays} + '회'">0회</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(hardestSongs)}" class="empty-row">
                            <td colspan="4" class="empty-state">
                                아직 충분한 플레이 데이터가 없습니다.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 최근 오답 -->
            <div class="stats-panel" id="recentPanel" style="display:none;">
                <div class="panel-header">
                    <h3>🕐 최근 오답 내역</h3>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th style="width:200px;">오답</th>
                            <th>정답 곡</th>
                            <th style="width:150px;">시간</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${recentWrongAnswers}">
                            <td data-label="오답">
                                <span class="wrong-text" th:text="${item.userAnswer}">오답</span>
                            </td>
                            <td data-label="정답 곡">
                                <div class="song-info">
                                    <span class="song-title" th:text="${item.songTitle}">제목</span>
                                    <span class="song-artist" th:text="${item.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="시간" th:text="${#temporals.format(item.createdAt, 'MM.dd HH:mm')}">01.01 00:00</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(recentWrongAnswers)}" class="empty-row">
                            <td colspan="3" class="empty-state">
                                아직 오답 데이터가 없습니다.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 대중성 통계 콘텐츠 -->
        <div class="primary-content" id="popularity-content" th:style="${activeTab != 'popularity'} ? 'display:none'">
            <!-- 필터 옵션 -->
            <form class="filter-form" method="get" th:action="@{/admin/stats}">
                <input type="hidden" name="tab" value="popularity">
                <div class="filter-group">
                    <label for="minPlays">최소 플레이 횟수:</label>
                    <select id="minPlays" name="minPlays">
                        <option value="5" th:selected="${minPlays == 5}">5회 이상</option>
                        <option value="10" th:selected="${minPlays == 10}">10회 이상</option>
                        <option value="20" th:selected="${minPlays == 20}">20회 이상</option>
                        <option value="50" th:selected="${minPlays == 50}">50회 이상</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" name="filterJunk" th:checked="${filterJunk}">
                        정크 데이터 제외
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">적용</button>
            </form>

            <!-- 정크 데이터 요약 카드 -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${junkSummary.totalWrongCount}">0</span>
                        <span class="stat-label">총 오답 수</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${junkSummary.validCount}">0</span>
                        <span class="stat-label">유효 데이터</span>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">🗑️</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${junkSummary.junkCount}">0</span>
                        <span class="stat-label">정크 데이터</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${junkSummary.junkRate} + '%'">0%</span>
                        <span class="stat-label">정크 비율</span>
                    </div>
                </div>
            </div>

            <!-- 2차 탭 네비게이션 -->
            <div class="stats-tabs popularity-tabs">
                <button class="stats-tab active" data-tab="mismatch">검토 필요</button>
                <button class="stats-tab" data-tab="all">전체 통계</button>
                <button class="stats-tab" data-tab="filtered">필터링된 오답</button>
            </div>

            <!-- 검토 필요 곡 목록 -->
            <div class="stats-panel" id="mismatchPanel">
                <div class="panel-header">
                    <h3>⚠️ 대중성 설정 검토 필요</h3>
                    <span class="panel-desc">정답률과 현재 설정이 불일치하는 곡</span>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>곡 정보</th>
                            <th style="width:100px;">현재 설정</th>
                            <th style="width:100px;">정답률</th>
                            <th style="width:80px;">플레이</th>
                            <th style="width:120px;">추천</th>
                            <th style="width:100px;">액션</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${mismatches}">
                            <td data-label="곡 정보">
                                <div class="song-info">
                                    <span class="song-title" th:text="${item.title}">제목</span>
                                    <span class="song-artist" th:text="${item.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="현재 설정">
                                <span class="badge" th:classappend="${item.currentIsPopular} ? 'badge-popular' : 'badge-maniac'"
                                      th:text="${item.currentIsPopular} ? '대중적' : '매니악'">대중적</span>
                            </td>
                            <td data-label="정답률">
                                <div class="rate-bar">
                                    <div class="rate-fill" th:style="'width:' + ${item.correctRate} + '%'"
                                         th:classappend="${item.correctRate >= 70} ? 'high' : (${item.correctRate <= 30} ? 'low' : '')"></div>
                                    <span class="rate-text" th:text="${item.correctRate} + '%'">0%</span>
                                </div>
                            </td>
                            <td data-label="플레이" th:text="${item.totalPlays} + '회'">0회</td>
                            <td data-label="추천">
                                <span class="recommend-badge"
                                      th:classappend="${item.recommend == 'CHANGE_TO_POPULAR'} ? 'to-popular' : 'to-maniac'"
                                      th:text="${item.recommend == 'CHANGE_TO_POPULAR'} ? '→ 대중적' : '→ 매니악'">→ 대중적</span>
                            </td>
                            <td data-label="액션">
                                <button class="btn btn-sm btn-primary"
                                        th:onclick="'updatePopularity(' + ${item.songId} + ', ' + (${item.recommend == 'CHANGE_TO_POPULAR'}) + ')'"
                                        th:text="${item.recommend == 'CHANGE_TO_POPULAR'} ? '대중적으로' : '매니악으로'">변경</button>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(mismatches)}" class="empty-row">
                            <td colspan="6" class="empty-state">
                                모든 곡의 대중성 설정이 정답률과 일치합니다!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 전체 대중성 통계 -->
            <div class="stats-panel" id="allPanel" style="display:none;">
                <div class="panel-header">
                    <h3>📊 곡별 정답률 통계</h3>
                    <span class="panel-desc">정답률 순 정렬 (높은 순)</span>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">순위</th>
                            <th>곡 정보</th>
                            <th style="width:100px;">현재 설정</th>
                            <th style="width:120px;">정답률</th>
                            <th style="width:80px;">플레이</th>
                            <th style="width:100px;">추천</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, idx : ${popularityStats}">
                            <td data-label="순위">
                                <span class="rank-badge" th:classappend="${idx.index < 3} ? 'top-' + (idx.index + 1) : ''">
                                    <span th:text="${idx.index + 1}">1</span>
                                </span>
                            </td>
                            <td data-label="곡 정보">
                                <div class="song-info">
                                    <span class="song-title" th:text="${item.title}">제목</span>
                                    <span class="song-artist" th:text="${item.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="현재 설정">
                                <span class="badge" th:if="${item.containsKey('isPopular')}"
                                      th:classappend="${item.isPopular != false} ? 'badge-popular' : 'badge-maniac'"
                                      th:text="${item.isPopular != false} ? '대중적' : '매니악'">대중적</span>
                                <span class="badge badge-popular" th:unless="${item.containsKey('isPopular')}">-</span>
                            </td>
                            <td data-label="정답률">
                                <div class="rate-bar">
                                    <div class="rate-fill" th:style="'width:' + ${item.correctRate} + '%'"
                                         th:classappend="${item.correctRate >= 70} ? 'high' : (${item.correctRate <= 30} ? 'low' : '')"></div>
                                    <span class="rate-text" th:text="${item.correctRate} + '%'">0%</span>
                                </div>
                            </td>
                            <td data-label="플레이" th:text="${item.totalPlays} + '회'">0회</td>
                            <td data-label="추천">
                                <span class="recommend-badge"
                                      th:classappend="${item.popularityRecommend == 'POPULAR'} ? 'to-popular' : (${item.popularityRecommend == 'MANIAC'} ? 'to-maniac' : 'neutral')"
                                      th:text="${item.popularityRecommend == 'POPULAR'} ? '대중적' : (${item.popularityRecommend == 'MANIAC'} ? '매니악' : '중립')">중립</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(popularityStats)}" class="empty-row">
                            <td colspan="6" class="empty-state">
                                아직 충분한 플레이 데이터가 없습니다.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 필터링된 오답 -->
            <div class="stats-panel" id="filteredPanel" style="display:none;">
                <div class="panel-header">
                    <h3>🔍 필터링된 오답 목록</h3>
                    <span class="panel-desc" th:text="${filterJunk} ? '정크 데이터 제외됨' : '전체 데이터'">전체 데이터</span>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">순위</th>
                            <th style="width:200px;">오답</th>
                            <th>정답 곡</th>
                            <th style="width:80px;">횟수</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, idx : ${filteredWrongAnswers}">
                            <td data-label="순위">
                                <span class="rank-badge" th:classappend="${idx.index < 3} ? 'top-' + (idx.index + 1) : ''">
                                    <span th:text="${idx.index + 1}">1</span>
                                </span>
                            </td>
                            <td data-label="오답">
                                <span class="wrong-text" th:text="${item.answer}">오답</span>
                            </td>
                            <td data-label="정답 곡">
                                <div class="song-info">
                                    <span class="song-title" th:text="${item.songTitle}">제목</span>
                                    <span class="song-artist" th:text="${item.artist}">아티스트</span>
                                </div>
                            </td>
                            <td data-label="횟수" th:text="${item.count} + '회'">0회</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(filteredWrongAnswers)}" class="empty-row">
                            <td colspan="4" class="empty-state">
                                오답 데이터가 없습니다.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>
<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/admin/admin-stats.js}"></script>
<script th:inline="javascript">
    const activeTab = [[${activeTab}]];

    function updatePopularity(songId, isPopular) {
        if (!confirm(isPopular ? '대중적으로 변경하시겠습니까?' : '매니악으로 변경하시겠습니까?')) {
            return;
        }

        fetch('/admin/stats/popularity/update/' + songId + '?isPopular=' + isPopular, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('변경되었습니다.');
                location.reload();
            } else {
                alert('변경 실패: ' + data.message);
            }
        })
        .catch(error => {
            alert('오류가 발생했습니다.');
            console.error(error);
        });
    }
</script>
</body>
</html>
