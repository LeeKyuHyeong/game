<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('곡 신고 관리')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>곡 신고 관리</h1>
            <span th:if="${pendingCount > 0}" class="pending-badge">
                대기 <span th:text="${pendingCount}"></span>건
            </span>
        </header>

        <div class="search-bar">
            <div class="filter-section">
                <select id="statusFilter" onchange="filterByStatus(this.value)">
                    <option value="">전체 상태</option>
                    <option value="PENDING" th:selected="${selectedStatus == 'PENDING'}">대기</option>
                    <option value="CONFIRMED" th:selected="${selectedStatus == 'CONFIRMED'}">확인됨</option>
                    <option value="REJECTED" th:selected="${selectedStatus == 'REJECTED'}">반려</option>
                    <option value="RESOLVED" th:selected="${selectedStatus == 'RESOLVED'}">해결됨</option>
                </select>
                <a th:if="${selectedStatus}" href="/admin/report" class="btn btn-reset">필터 초기화</a>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>곡 정보</th>
                    <th>신고 유형</th>
                    <th>신고자</th>
                    <th>상태</th>
                    <th>신고일</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="report : ${reports}" onclick="toggleRowExpand(this)">
                    <td data-label="ID" th:text="${report.id}"></td>
                    <td data-label="곡 정보">
                        <div class="song-info-cell">
                            <span class="song-title" th:text="${report.song.title}"></span>
                            <span class="song-artist" th:text="${report.song.artist}"></span>
                        </div>
                    </td>
                    <td data-label="신고 유형">
                        <span class="report-type-badge"
                              th:classappend="${report.reportType.name()}"
                              th:text="${report.reportType.description}"></span>
                    </td>
                    <td data-label="신고자" th:text="${report.member != null} ? ${report.member.nickname} : '게스트'"></td>
                    <td data-label="상태">
                        <span class="status-badge"
                              th:classappend="${report.status.name()}"
                              th:text="${report.status.description}"></span>
                    </td>
                    <td data-label="신고일" th:text="${#temporals.format(report.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                    <td class="action-buttons" data-label="" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-edit"
                                th:data-id="${report.id}"
                                th:data-song-title="${report.song.title}"
                                th:data-song-artist="${report.song.artist}"
                                th:data-report-type="${report.reportType.description}"
                                th:data-description="${report.description}"
                                th:data-status="${report.status.name()}"
                                onclick="openProcessModal(this)">처리</button>
                        <button th:if="${report.status.name() == 'CONFIRMED'}"
                                class="btn btn-sm btn-delete"
                                th:data-id="${report.id}"
                                onclick="disableSong(this.dataset.id)">곡 비활성화</button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(reports)}">
                    <td colspan="7" class="empty-row">신고 내역이 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" th:if="${totalPages > 0}">
            <a th:href="@{/admin/report(page=0, status=${selectedStatus})}"
               th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">«</a>
            <a th:href="@{/admin/report(page=${currentPage - 1}, status=${selectedStatus})}"
               th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">‹</a>

            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${i >= currentPage - 2 and i <= currentPage + 2}"
                   th:href="@{/admin/report(page=${i}, status=${selectedStatus})}"
                   th:text="${i + 1}"
                   th:classappend="${i == currentPage} ? 'active'" class="page-link"></a>
            </th:block>

            <a th:href="@{/admin/report(page=${currentPage + 1}, status=${selectedStatus})}"
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">›</a>
            <a th:href="@{/admin/report(page=${totalPages - 1}, status=${selectedStatus})}"
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">»</a>
        </div>
    </main>
</div>

<!-- 처리 모달 -->
<div id="processModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>신고 처리</h2>
            <button class="close-btn" onclick="closeProcessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="report-detail">
                <p><strong>곡:</strong> <span id="modalSongTitle"></span> - <span id="modalSongArtist"></span></p>
                <p><strong>신고 유형:</strong> <span id="modalReportType"></span></p>
                <p><strong>상세 내용:</strong> <span id="modalDescription"></span></p>
            </div>
            <input type="hidden" id="processReportId">
            <div class="form-group">
                <label>처리 상태</label>
                <select id="processStatus">
                    <option value="PENDING">대기</option>
                    <option value="CONFIRMED">확인됨 (문제 있음)</option>
                    <option value="REJECTED">반려 (문제 없음)</option>
                    <option value="RESOLVED">해결됨</option>
                </select>
            </div>
            <div class="form-group">
                <label>관리자 메모</label>
                <textarea id="adminNote" rows="3" placeholder="처리 내용을 입력하세요"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProcessModal()">취소</button>
            <button class="btn btn-primary" onclick="processReport()">처리</button>
        </div>
    </div>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/admin/admin-report.js}"></script>
</body>
</html>
