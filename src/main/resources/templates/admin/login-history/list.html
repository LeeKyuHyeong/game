<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('로그인 이력 관리')}"></head>
<link rel="stylesheet" href="/css/admin/table-mobile-collapse.css">
<body class="admin-page">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>로그인 이력 관리</h1>
        </header>

        <!-- 검색/필터 -->
        <div class="filter-section">
            <form class="filter-form" method="get">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>이메일</label>
                        <input type="text" name="email" th:value="${email}" placeholder="이메일 검색">
                    </div>
                    <div class="filter-group">
                        <label>결과</label>
                        <select name="result">
                            <option value="">전체</option>
                            <option value="SUCCESS" th:selected="${result == 'SUCCESS'}">성공</option>
                            <option value="FAIL" th:selected="${result == 'FAIL'}">실패 전체</option>
                            <option value="FAIL_PASSWORD" th:selected="${result == 'FAIL_PASSWORD'}">비밀번호 오류</option>
                            <option value="FAIL_NOT_FOUND" th:selected="${result == 'FAIL_NOT_FOUND'}">계정 없음</option>
                            <option value="FAIL_BANNED" th:selected="${result == 'FAIL_BANNED'}">정지 계정</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>기간</label>
                        <div class="date-range">
                            <input type="date" name="startDate" th:value="${startDate}">
                            <span>~</span>
                            <input type="date" name="endDate" th:value="${endDate}">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-search">검색</button>
                        <a href="/admin/login-history" class="btn btn-reset">초기화</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- 이력 테이블 -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>이메일</th>
                    <th>결과</th>
                    <th>IP 주소</th>
                    <th>사유</th>
                    <th>일시</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="history : ${histories}" onclick="toggleRowExpand(this)">
                    <td data-label="ID" th:text="${history.id}"></td>
                    <td data-label="이메일" th:text="${history.email}"></td>
                    <td data-label="결과">
                            <span class="status-badge"
                                  th:classappend="${history.result.name() == 'SUCCESS' ? 'success' : 'danger'}"
                                  th:text="${history.result.name() == 'SUCCESS' ? '성공' :
                                            (history.result.name() == 'FAIL_PASSWORD' ? '비밀번호 오류' :
                                            (history.result.name() == 'FAIL_NOT_FOUND' ? '계정 없음' :
                                            (history.result.name() == 'FAIL_BANNED' ? '정지 계정' :
                                            (history.result.name() == 'FAIL_INACTIVE' ? '비활성 계정' : history.result.name()))))}">
                            </span>
                    </td>
                    <td data-label="IP 주소" th:text="${history.ipAddress}"></td>
                    <td data-label="사유" th:text="${history.failReason ?: '-'}"></td>
                    <td data-label="일시" th:text="${#temporals.format(history.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr th:if="${histories.isEmpty()}">
                    <td colspan="6" class="empty-row">조회된 이력이 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" th:if="${histories.totalPages > 1}">
            <a th:if="${currentPage > 0}"
               th:href="@{/admin/login-history(page=${currentPage - 1}, email=${email}, result=${result}, startDate=${startDate}, endDate=${endDate})}"
               class="page-link">이전</a>

            <span th:each="i : ${#numbers.sequence(0, histories.totalPages - 1)}">
                <a th:if="${i == currentPage}" class="page-link active" th:text="${i + 1}"></a>
                <a th:unless="${i == currentPage}"
                   th:href="@{/admin/login-history(page=${i}, email=${email}, result=${result}, startDate=${startDate}, endDate=${endDate})}"
                   class="page-link" th:text="${i + 1}"></a>
            </span>

            <a th:if="${currentPage < histories.totalPages - 1}"
               th:href="@{/admin/login-history(page=${currentPage + 1}, email=${email}, result=${result}, startDate=${startDate}, endDate=${endDate})}"
               class="page-link">다음</a>
        </div>

        <!-- 통계 요약 -->
        <div class="stats-summary">
            <div class="stat-card">
                <span class="stat-label">전체 이력</span>
                <span class="stat-value" th:text="${histories.totalElements}">0</span>
            </div>
        </div>
    </main>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/admin/admin.js}"></script>
<script>
function toggleRowExpand(row) {
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}
</script>
</body>
</html>