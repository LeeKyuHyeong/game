<!-- íŒ¬ ì±Œë¦°ì§€ ë‹¨ê³„ ì„¤ì • íƒ­ ì½˜í…ì¸  (í”„ë˜ê·¸ë¨¼íŠ¸) -->
<div class="challenge-tab-content" xmlns:th="http://www.thymeleaf.org">
    <!-- í—¤ë” -->
    <div class="stage-header">
        <h3>ğŸ† ë‹¨ê³„ ì„¤ì •</h3>
        <p class="stage-description">HARDCORE ëª¨ë“œì—ì„œë§Œ ë‹¨ê³„ ì‹œìŠ¤í…œì´ ì ìš©ë©ë‹ˆë‹¤. ê´€ë¦¬ìê°€ ìˆœì°¨ì ìœ¼ë¡œ ë‹¨ê³„ë¥¼ ê°œë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ë‹¨ê³„ ì¹´ë“œ ëª©ë¡ -->
    <div class="stage-cards">
        <div th:each="stage : ${stages}" class="stage-card" th:classappend="${stage.isActive} ? 'active' : 'inactive'"
             th:data-level="${stage.stageLevel}">
            <div class="stage-card-header">
                <span class="stage-emoji" th:text="${stage.stageEmoji}">ğŸ¥‰</span>
                <span class="stage-name" th:text="${stage.stageName}">1ë‹¨ê³„</span>
                <span class="stage-status" th:if="${stage.isActive}">âœ… í™œì„±</span>
                <span class="stage-status locked" th:unless="${stage.isActive}">ğŸ”’ ë¹„í™œì„±</span>
            </div>
            <div class="stage-card-body">
                <div class="stage-info">
                    <span class="info-label">í•„ìš” ê³¡ ìˆ˜</span>
                    <span class="info-value" th:text="${stage.requiredSongs} + 'ê³¡'">20ê³¡</span>
                </div>
                <div class="stage-info" th:if="${stage.activatedAt}">
                    <span class="info-label">í™œì„±í™” ì¼ì‹œ</span>
                    <span class="info-value" th:text="${#temporals.format(stage.activatedAt, 'yyyy-MM-dd HH:mm')}">-</span>
                </div>
            </div>
            <div class="stage-card-actions">
                <button class="btn btn-sm btn-edit" th:data-level="${stage.stageLevel}"
                        onclick="openEditModal(this.dataset.level)">ìˆ˜ì •</button>
                <button class="btn btn-sm" th:classappend="${stage.isActive} ? 'btn-warning' : 'btn-success'"
                        th:data-level="${stage.stageLevel}"
                        th:disabled="${stage.stageLevel == 1 and stage.isActive}"
                        th:title="${stage.stageLevel == 1 and stage.isActive} ? '1ë‹¨ê³„ëŠ” ë¹„í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' : ''"
                        onclick="toggleStageActive(this.dataset.level)">
                    <span th:if="${stage.isActive}">ë¹„í™œì„±í™”</span>
                    <span th:unless="${stage.isActive}">í™œì„±í™”</span>
                </button>
            </div>
        </div>

        <!-- ìƒˆ ë‹¨ê³„ ì¶”ê°€ ì¹´ë“œ -->
        <div class="stage-card add-card" onclick="openAddModal()">
            <div class="add-icon">â•</div>
            <span class="add-text">ìƒˆ ë‹¨ê³„ ì¶”ê°€</span>
        </div>
    </div>

    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="stage-notes">
        <h4>ğŸ“Œ ë‹¨ê³„ ì‹œìŠ¤í…œ ì•ˆë‚´</h4>
        <ul>
            <li><strong>NORMAL ëª¨ë“œ:</strong> í•­ìƒ 20ê³¡ ê³ ì • (ì—°ìŠµìš©, ë­í‚¹ ë¯¸ë°˜ì˜)</li>
            <li><strong>HARDCORE ëª¨ë“œ:</strong> ë‹¨ê³„ë³„ ê³¡ ìˆ˜ ì ìš© (ê³µì‹ ë­í‚¹)</li>
            <li><strong>ìˆœì°¨ ê°œë°©:</strong> ì´ì „ ë‹¨ê³„ê°€ í™œì„±í™”ë˜ì–´ì•¼ ë‹¤ìŒ ë‹¨ê³„ í™œì„±í™” ê°€ëŠ¥</li>
            <li><strong>ë±ƒì§€ ì§€ê¸‰:</strong> HARDCORE í¼í™íŠ¸ í´ë¦¬ì–´ ì‹œ "ì•„í‹°ìŠ¤íŠ¸ Në‹¨ê³„" ë±ƒì§€ ì§€ê¸‰</li>
        </ul>
    </div>
</div>

<!-- ë‹¨ê³„ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="stageEditModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>ë‹¨ê³„ ì„¤ì • ìˆ˜ì •</h2>
            <button class="close-btn" onclick="closeModal('stageEditModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="stageEditForm">
                <input type="hidden" id="editStageLevel" name="stageLevel">
                <div class="form-group">
                    <label for="editStageName">ë‹¨ê³„ ì´ë¦„</label>
                    <input type="text" id="editStageName" name="stageName" class="form-input" placeholder="ì˜ˆ: 1ë‹¨ê³„">
                </div>
                <div class="form-group">
                    <label for="editRequiredSongs">í•„ìš” ê³¡ ìˆ˜</label>
                    <input type="number" id="editRequiredSongs" name="requiredSongs" class="form-input" min="1" placeholder="20">
                </div>
                <div class="form-group">
                    <label for="editEmoji">ì´ëª¨ì§€</label>
                    <input type="text" id="editEmoji" name="emoji" class="form-input" placeholder="ğŸ¥‰">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('stageEditModal')">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveStageEdit()">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ìƒˆ ë‹¨ê³„ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="stageAddModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>ìƒˆ ë‹¨ê³„ ì¶”ê°€</h2>
            <button class="close-btn" onclick="closeModal('stageAddModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="stageAddForm">
                <div class="form-group">
                    <label for="addStageName">ë‹¨ê³„ ì´ë¦„</label>
                    <input type="text" id="addStageName" name="stageName" class="form-input" placeholder="ì˜ˆ: 4ë‹¨ê³„" required>
                </div>
                <div class="form-group">
                    <label for="addRequiredSongs">í•„ìš” ê³¡ ìˆ˜</label>
                    <input type="number" id="addRequiredSongs" name="requiredSongs" class="form-input" min="1" placeholder="35" required>
                </div>
                <div class="form-group">
                    <label for="addEmoji">ì´ëª¨ì§€</label>
                    <input type="text" id="addEmoji" name="emoji" class="form-input" placeholder="ğŸ‘‘">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('stageAddModal')">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="addNewStage()">ì¶”ê°€</button>
        </div>
    </div>
</div>

<style>
/* í—¤ë” */
.stage-header {
    margin-bottom: 1.5rem;
}

.stage-header h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
}

.stage-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* ë‹¨ê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
.stage-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stage-card {
    background: var(--bg-surface);
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem;
    transition: all 0.2s ease;
}

.stage-card.active {
    border-color: var(--success-color, #10b981);
    background: var(--bg-elevated);
}

.stage-card.inactive {
    opacity: 0.7;
}

.stage-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* ì¹´ë“œ í—¤ë” */
.stage-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.stage-emoji {
    font-size: 1.5rem;
}

.stage-name {
    font-weight: 600;
    font-size: 1.1rem;
    flex: 1;
}

.stage-status {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background: var(--success-bg, #d1fae5);
    color: var(--success-color, #065f46);
}

.stage-status.locked {
    background: var(--warning-bg, #fef3c7);
    color: var(--warning-color, #92400e);
}

/* ì¹´ë“œ ë°”ë”” */
.stage-card-body {
    margin-bottom: 1rem;
}

.stage-info {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px dashed var(--border-color);
}

.stage-info:last-child {
    border-bottom: none;
}

.info-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.info-value {
    font-weight: 500;
}

/* ì¹´ë“œ ì•¡ì…˜ */
.stage-card-actions {
    display: flex;
    gap: 0.5rem;
}

.stage-card-actions .btn {
    flex: 1;
}

/* ìƒˆ ë‹¨ê³„ ì¶”ê°€ ì¹´ë“œ */
.stage-card.add-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 180px;
    border-style: dashed;
    cursor: pointer;
    background: transparent;
}

.stage-card.add-card:hover {
    border-color: var(--primary-color);
    background: var(--bg-elevated);
}

.add-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.add-text {
    color: var(--text-secondary);
}

/* ì•ˆë‚´ ë©”ì‹œì§€ */
.stage-notes {
    background: var(--bg-elevated);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    margin-top: 1rem;
}

.stage-notes h4 {
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.stage-notes ul {
    margin: 0;
    padding-left: 1.25rem;
}

.stage-notes li {
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.stage-notes li strong {
    color: var(--text-primary);
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .stage-cards {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// ë‹¨ê³„ í™œì„±í™” í† ê¸€
async function toggleStageActive(level) {
    if (level == 1) {
        showToast('1ë‹¨ê³„ëŠ” ë¹„í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    try {
        const response = await fetch(`/admin/fan-challenge/stages/${level}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadStagesTab(); // íƒ­ ìƒˆë¡œê³ ì¹¨
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function openEditModal(level) {
    const card = document.querySelector(`.stage-card[data-level="${level}"]`);
    if (!card) return;

    document.getElementById('editStageLevel').value = level;
    document.getElementById('editStageName').value = card.querySelector('.stage-name').textContent;
    document.getElementById('editRequiredSongs').value = card.querySelector('.info-value').textContent.replace('ê³¡', '');
    document.getElementById('editEmoji').value = card.querySelector('.stage-emoji').textContent;

    openModal('stageEditModal');
}

// ë‹¨ê³„ ìˆ˜ì • ì €ì¥
async function saveStageEdit() {
    const level = document.getElementById('editStageLevel').value;
    const data = {
        stageName: document.getElementById('editStageName').value,
        requiredSongs: parseInt(document.getElementById('editRequiredSongs').value),
        emoji: document.getElementById('editEmoji').value
    };

    try {
        const response = await fetch(`/admin/fan-challenge/stages/${level}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            closeModal('stageEditModal');
            loadStagesTab();
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ìƒˆ ë‹¨ê³„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
function openAddModal() {
    document.getElementById('stageAddForm').reset();
    openModal('stageAddModal');
}

// ìƒˆ ë‹¨ê³„ ì¶”ê°€
async function addNewStage() {
    const data = {
        stageName: document.getElementById('addStageName').value,
        requiredSongs: parseInt(document.getElementById('addRequiredSongs').value),
        emoji: document.getElementById('addEmoji').value
    };

    if (!data.stageName || !data.requiredSongs) {
        showToast('ë‹¨ê³„ ì´ë¦„ê³¼ í•„ìš” ê³¡ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    try {
        const response = await fetch('/admin/fan-challenge/stages/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            closeModal('stageAddModal');
            loadStagesTab();
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ë‹¨ê³„ íƒ­ ë¡œë“œ í•¨ìˆ˜ (admin-challenge-index.jsì—ì„œ í˜¸ì¶œ)
function loadStagesTab() {
    const tabContent = document.getElementById('tabContent');
    if (!tabContent) return;

    tabContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>ë¡œë”© ì¤‘...</span></div>';

    fetch('/admin/fan-challenge/stages/content')
        .then(response => response.text())
        .then(html => {
            tabContent.innerHTML = html;
        })
        .catch(error => {
            tabContent.innerHTML = '<div class="error-message">ë¡œë”© ì‹¤íŒ¨</div>';
        });
}
</script>
