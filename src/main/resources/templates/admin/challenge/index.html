<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('ì±Œë¦°ì§€ ê´€ë¦¬')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>ì±Œë¦°ì§€ ê´€ë¦¬</h1>
        </header>

        <!-- í†µí•© í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" th:text="${fanTotalCount + genreTotalCount}">0</div>
                <div class="stat-label">ì „ì²´ ê¸°ë¡</div>
            </div>
            <div class="stat-card fan">
                <div class="stat-value" th:text="${fanTotalCount}">0</div>
                <div class="stat-label">íŒ¬ ì±Œë¦°ì§€</div>
            </div>
            <div class="stat-card genre">
                <div class="stat-value" th:text="${genreTotalCount}">0</div>
                <div class="stat-label">ì¥ë¥´ ì±Œë¦°ì§€</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${fanTodayCount + genreTodayCount}">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ë„ì „</div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation">
            <button class="tab-btn" th:classappend="${activeTab == 'fan'} ? 'active'"
                    onclick="switchTab('fan')">
                <span class="tab-icon">ğŸ¤</span>
                <span class="tab-text">íŒ¬ ì±Œë¦°ì§€</span>
                <span class="tab-badge" th:text="${fanTotalCount}">0</span>
            </button>
            <button class="tab-btn" th:classappend="${activeTab == 'genre'} ? 'active'"
                    onclick="switchTab('genre')">
                <span class="tab-icon">ğŸ¸</span>
                <span class="tab-text">ì¥ë¥´ ì±Œë¦°ì§€</span>
                <span class="tab-badge" th:text="${genreTotalCount}">0</span>
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tabContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>ë¡œë”© ì¤‘...</span>
            </div>
        </div>
    </main>
</div>

<!-- ê¸°ë¡ ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="modal">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h2 id="detailModalTitle">ê¸°ë¡ ìƒì„¸</h2>
            <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailContent">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:inline="javascript">
const activeTab = [[${activeTab}]];
const genres = [[${genres}]];
let currentTab = activeTab;

// ì´ˆê¸° ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    loadTabContent(currentTab);
});

function switchTab(tab) {
    if (currentTab === tab) return;

    currentTab = tab;

    // URL ì—…ë°ì´íŠ¸
    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);

    // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn:nth-child(${tab === 'fan' ? 1 : 2})`).classList.add('active');

    // ì½˜í…ì¸  ë¡œë“œ
    loadTabContent(tab);
}

async function loadTabContent(tab, params = '') {
    const tabContent = document.getElementById('tabContent');
    tabContent.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>ë¡œë”© ì¤‘...</span>
        </div>
    `;

    try {
        const url = tab === 'fan'
            ? `/admin/fan-challenge/content${params ? '?' + params : ''}`
            : `/admin/genre-challenge/content${params ? '?' + params : ''}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load content');

        const html = await response.text();
        tabContent.innerHTML = html;

        // ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™”
        initTabScripts();
    } catch (error) {
        tabContent.innerHTML = `
            <div class="error-message">
                <p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="loadTabContent('${tab}')">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    }
}

function initTabScripts() {
    // ê²€ìƒ‰ í¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const searchForm = document.querySelector('.tab-content .search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(searchForm);
            const params = new URLSearchParams(formData).toString();
            loadTabContent(currentTab, params);
        });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    const resetBtn = document.querySelector('.tab-content .btn-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadTabContent(currentTab);
        });
    }
}

function toggleRowExpand(row) {
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}

function sortBy(column, baseUrl) {
    const params = new URLSearchParams(window.location.search);
    const currentSort = params.get('sort');
    const currentDirection = params.get('direction') || 'desc';

    if (currentSort === column) {
        params.set('direction', currentDirection === 'asc' ? 'desc' : 'asc');
    } else {
        params.set('sort', column);
        params.set('direction', 'desc');
    }
    params.set('page', '0');
    params.delete('tab');

    loadTabContent(currentTab, params.toString());
}

function goToPage(page) {
    const params = new URLSearchParams();
    const form = document.querySelector('.tab-content .search-form');
    if (form) {
        new FormData(form).forEach((value, key) => {
            if (value) params.set(key, value);
        });
    }
    params.set('page', page);
    loadTabContent(currentTab, params.toString());
}

async function viewDetail(id, type) {
    try {
        const url = type === 'fan'
            ? `/admin/fan-challenge/detail/${id}`
            : `/admin/genre-challenge/detail/${id}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const data = await response.json();

        document.getElementById('detailModalTitle').textContent =
            type === 'fan' ? 'íŒ¬ ì±Œë¦°ì§€ ê¸°ë¡ ìƒì„¸' : 'ì¥ë¥´ ì±Œë¦°ì§€ ê¸°ë¡ ìƒì„¸';

        renderDetailContent(data, type);
        openModal('detailModal');
    } catch (error) {
        showToast('ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function renderDetailContent(data, type) {
    const detailContent = document.getElementById('detailContent');
    detailContent.textContent = '';

    const grid = document.createElement('div');
    grid.className = 'detail-grid';

    function createDetailItem(label, value) {
        const item = document.createElement('div');
        item.className = 'detail-item';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'detail-label';
        labelDiv.textContent = label;

        const valueDiv = document.createElement('div');
        valueDiv.className = 'detail-value';
        valueDiv.textContent = value;

        item.appendChild(labelDiv);
        item.appendChild(valueDiv);
        return item;
    }

    const bestTime = data.bestTimeMs ? `${(data.bestTimeMs / 1000).toFixed(1)}ì´ˆ` : '-';
    const achievedAt = data.achievedAt ? new Date(data.achievedAt).toLocaleString('ko-KR') : '-';

    grid.appendChild(createDetailItem('íšŒì›', data.memberNickname));
    grid.appendChild(createDetailItem('ì´ë©”ì¼', data.memberEmail));

    if (type === 'fan') {
        grid.appendChild(createDetailItem('ì•„í‹°ìŠ¤íŠ¸', data.artist));
    } else {
        grid.appendChild(createDetailItem('ì¥ë¥´', data.genreName));
    }

    grid.appendChild(createDetailItem('ë‚œì´ë„', data.difficultyDisplayName));
    grid.appendChild(createDetailItem('ë‹¬ì„± ì‹œì  ì •ë‹µ/ì „ì²´', `${data.correctCount}/${data.totalSongs} (${data.clearRate}%)`));
    grid.appendChild(createDetailItem('í˜„ì¬ ì‹œì  ì •ë‹µ/ì „ì²´', `${data.correctCount}/${data.currentSongCount} (${data.currentClearRate}%)`));

    if (type === 'fan') {
        // í¼í™íŠ¸ ìƒíƒœ
        const perfectItem = document.createElement('div');
        perfectItem.className = 'detail-item';

        const perfectLabel = document.createElement('div');
        perfectLabel.className = 'detail-label';
        perfectLabel.textContent = 'í¼í™íŠ¸ ìƒíƒœ';

        const perfectValue = document.createElement('div');
        perfectValue.className = 'detail-value';

        if (data.isPerfectClear) {
            if (data.isCurrentPerfect) {
                perfectValue.innerHTML = '<span class="perfect-badge achieved">âœ… í˜„ì¬ ìœ íš¨</span>';
            } else {
                perfectValue.innerHTML = '<span class="perfect-badge invalid">â­ ê³¡ ì¶”ê°€ë¡œ ë¬´íš¨í™”</span>';
            }
        } else {
            perfectValue.textContent = 'ë¯¸ë‹¬ì„±';
        }

        perfectItem.appendChild(perfectLabel);
        perfectItem.appendChild(perfectValue);
        grid.appendChild(perfectItem);
    } else {
        grid.appendChild(createDetailItem('ìµœëŒ€ ì½¤ë³´', data.maxCombo));
    }

    grid.appendChild(createDetailItem('ìµœê³  í´ë¦¬ì–´ ì‹œê°„', bestTime));
    grid.appendChild(createDetailItem('ë‹¬ì„±ì¼', achievedAt));

    detailContent.appendChild(grid);
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
}
</script>

<style>
/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
.tab-navigation {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-elevated);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 600;
}

.tab-icon {
    font-size: 1.1rem;
}

.tab-badge {
    background: var(--bg-elevated);
    padding: 0.15rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.tab-btn.active .tab-badge {
    background: var(--primary-color);
    color: white;
}

/* íƒ­ ì½˜í…ì¸  */
.tab-content {
    min-height: 400px;
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    gap: 1rem;
    color: var(--text-secondary);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ì—ëŸ¬ ë©”ì‹œì§€ */
.error-message {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.error-message p {
    margin-bottom: 1rem;
}

/* í†µê³„ ì¹´ë“œ ìƒ‰ìƒ */
.stat-card.fan {
    border-left: 3px solid #ec4899;
}

.stat-card.genre {
    border-left: 3px solid #8b5cf6;
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .tab-navigation {
        flex-wrap: wrap;
    }

    .tab-btn {
        flex: 1;
        justify-content: center;
        min-width: 120px;
    }

    .tab-text {
        display: none;
    }

    .tab-icon {
        font-size: 1.3rem;
    }
}

@media (max-width: 480px) {
    .tab-btn {
        padding: 0.6rem 0.8rem;
    }
}
</style>
</body>
</html>
