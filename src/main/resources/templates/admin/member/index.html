<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('íšŒì› ê´€ë¦¬')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>íšŒì› ê´€ë¦¬</h1>
        </header>

        <!-- í†µí•© í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" th:text="${totalCount}">0</div>
                <div class="stat-label">ì „ì²´ íšŒì›</div>
            </div>
            <div class="stat-card active">
                <div class="stat-value" th:text="${activeCount}">0</div>
                <div class="stat-label">í™œì„± íšŒì›</div>
            </div>
            <div class="stat-card banned">
                <div class="stat-value" th:text="${bannedCount}">0</div>
                <div class="stat-label">ì •ì§€ íšŒì›</div>
            </div>
            <div class="stat-card admin">
                <div class="stat-value" th:text="${adminCount}">0</div>
                <div class="stat-label">ê´€ë¦¬ì</div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation">
            <button class="tab-btn" th:classappend="${activeTab == 'member'} ? 'active'"
                    onclick="switchTab('member')">
                <span class="tab-icon">ğŸ‘¥</span>
                <span class="tab-text">íšŒì› ëª©ë¡</span>
            </button>
            <button class="tab-btn" th:classappend="${activeTab == 'login'} ? 'active'"
                    onclick="switchTab('login')">
                <span class="tab-icon">ğŸ”</span>
                <span class="tab-text">ë¡œê·¸ì¸ ì´ë ¥</span>
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tabContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>ë¡œë”© ì¤‘...</span>
            </div>
        </div>
    </main>
</div>

<!-- íšŒì› ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="modal">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h2>íšŒì› ìƒì„¸ ì •ë³´</h2>
            <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-warning" onclick="resetPassword()">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
            <button type="button" class="btn btn-danger" onclick="kickSession()">ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ</button>
            <button type="button" class="btn btn-cancel" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
<div id="statusModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>íšŒì› ìƒíƒœ ë³€ê²½</h2>
            <button class="close-btn" onclick="closeModal('statusModal')">&times;</button>
        </div>
        <form id="statusForm" class="modal-form">
            <input type="hidden" id="statusMemberId" name="id">
            <div class="form-group">
                <label>ìƒíƒœ ì„ íƒ</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="status" value="ACTIVE"> í™œì„±</label>
                    <label class="radio-label"><input type="radio" name="status" value="INACTIVE"> ë¹„í™œì„±</label>
                    <label class="radio-label"><input type="radio" name="status" value="BANNED"> ì •ì§€</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal('statusModal')">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ë³€ê²½</button>
            </div>
        </form>
    </div>
</div>

<!-- ê¶Œí•œ ë³€ê²½ ëª¨ë‹¬ -->
<div id="roleModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>íšŒì› ê¶Œí•œ ë³€ê²½</h2>
            <button class="close-btn" onclick="closeModal('roleModal')">&times;</button>
        </div>
        <form id="roleForm" class="modal-form">
            <input type="hidden" id="roleMemberId" name="id">
            <div class="form-group">
                <label>ê¶Œí•œ ì„ íƒ</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="role" value="USER"> ì¼ë°˜ ì‚¬ìš©ì</label>
                    <label class="radio-label"><input type="radio" name="role" value="ADMIN"> ê´€ë¦¬ì</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal('roleModal')">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ë³€ê²½</button>
            </div>
        </form>
    </div>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:src="@{/js/admin/admin-member.js}"></script>
<script th:inline="javascript">
const activeTab = [[${activeTab}]];
let currentTab = activeTab;
let currentMemberId = null;

document.addEventListener('DOMContentLoaded', () => {
    loadTabContent(currentTab);
    initForms();
});

function switchTab(tab) {
    if (currentTab === tab) return;
    currentTab = tab;

    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);

    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn:nth-child(${tab === 'member' ? 1 : 2})`).classList.add('active');

    loadTabContent(tab);
}

async function loadTabContent(tab, params = '') {
    const tabContent = document.getElementById('tabContent');
    tabContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>ë¡œë”© ì¤‘...</span></div>';

    try {
        const url = tab === 'member'
            ? `/admin/member/content${params ? '?' + params : ''}`
            : `/admin/login-history/content${params ? '?' + params : ''}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load content');

        tabContent.innerHTML = await response.text();
        initTabScripts();
    } catch (error) {
        tabContent.innerHTML = `<div class="error-message"><p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button class="btn btn-primary" onclick="loadTabContent('${tab}')">ë‹¤ì‹œ ì‹œë„</button></div>`;
    }
}

function initTabScripts() {
    const searchForm = document.querySelector('.tab-content .search-form, .tab-content .filter-form');
    if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(searchForm)).toString();
            loadTabContent(currentTab, params);
        });
    }

    const resetBtn = document.querySelector('.tab-content .btn-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadTabContent(currentTab);
        });
    }
}

function initForms() {
    document.getElementById('statusForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('statusMemberId').value;
        const status = document.querySelector('input[name="status"]:checked')?.value;
        if (!status) { showToast('ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }

        try {
            const response = await fetch(`/admin/member/update-status/${id}?status=${status}`, { method: 'POST' });
            const result = await response.json();
            showToast(result.message, result.success ? 'success' : 'error');
            if (result.success) { closeModal('statusModal'); loadTabContent('member'); }
        } catch (error) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
    });

    document.getElementById('roleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('roleMemberId').value;
        const role = document.querySelector('input[name="role"]:checked')?.value;
        if (!role) { showToast('ê¶Œí•œì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }

        try {
            const response = await fetch(`/admin/member/update-role/${id}?role=${role}`, { method: 'POST' });
            const result = await response.json();
            showToast(result.message, result.success ? 'success' : 'error');
            if (result.success) { closeModal('roleModal'); loadTabContent('member'); }
        } catch (error) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
    });
}

function toggleRowExpand(row) { if (window.innerWidth <= 768) row.classList.toggle('expanded'); }

function goToPage(page) {
    const form = document.querySelector('.tab-content .search-form, .tab-content .filter-form');
    const params = new URLSearchParams();
    if (form) new FormData(form).forEach((v, k) => { if (v) params.set(k, v); });
    params.set('page', page);
    loadTabContent(currentTab, params.toString());
}

function sortBy(column) {
    const params = new URLSearchParams();
    const form = document.querySelector('.tab-content .search-form');
    if (form) new FormData(form).forEach((v, k) => { if (v) params.set(k, v); });

    const currentSort = params.get('sort');
    const currentDir = params.get('direction') || 'desc';
    params.set('sort', column);
    params.set('direction', currentSort === column && currentDir === 'desc' ? 'asc' : 'desc');
    params.set('page', '0');
    loadTabContent(currentTab, params.toString());
}

async function viewDetail(id) {
    currentMemberId = id;
    try {
        const response = await fetch(`/admin/member/detail/${id}`);
        const data = await response.json();

        const content = document.getElementById('detailContent');
        content.innerHTML = `
            <div class="detail-grid">
                <div class="detail-item"><div class="detail-label">ID</div><div class="detail-value">${data.id}</div></div>
                <div class="detail-item"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">${data.email}</div></div>
                <div class="detail-item"><div class="detail-label">ë‹‰ë„¤ì„</div><div class="detail-value">${data.nickname}</div></div>
                <div class="detail-item"><div class="detail-label">ê¶Œí•œ</div><div class="detail-value">${data.role === 'ADMIN' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì'}</div></div>
                <div class="detail-item"><div class="detail-label">ìƒíƒœ</div><div class="detail-value">${data.status}</div></div>
                <div class="detail-item"><div class="detail-label">í‹°ì–´</div><div class="detail-value"><span class="tier-badge" style="background-color:${data.multiTierColor}">${data.multiTierDisplayName}</span> (LP: ${data.multiLp})</div></div>
                <div class="detail-item"><div class="detail-label">ì´ ê²Œì„</div><div class="detail-value">${data.totalGames}íšŒ</div></div>
                <div class="detail-item"><div class="detail-label">ì´ ì ìˆ˜</div><div class="detail-value">${data.totalScore}ì </div></div>
                <div class="detail-item"><div class="detail-label">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</div><div class="detail-value">${data.lastLoginAt ? new Date(data.lastLoginAt).toLocaleString('ko-KR') : '-'}</div></div>
                <div class="detail-item"><div class="detail-label">ê°€ì…ì¼</div><div class="detail-value">${new Date(data.createdAt).toLocaleString('ko-KR')}</div></div>
            </div>
            ${data.badges && data.badges.length > 0 ? `
                <div class="badges-section">
                    <h4>ë³´ìœ  ë±ƒì§€ (${data.badgeCount}ê°œ)</h4>
                    <div class="badges-list">${data.badges.map(b => `<span class="badge-item" style="border-color:${b.rarityColor}" title="${b.description}">${b.emoji} ${b.name}</span>`).join('')}</div>
                </div>
            ` : ''}
        `;
        openModal('detailModal');
    } catch (error) { showToast('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'); }
}

function openStatusModal(id) { currentMemberId = id; document.getElementById('statusMemberId').value = id; openModal('statusModal'); }
function openRoleModal(id) { currentMemberId = id; document.getElementById('roleMemberId').value = id; openModal('roleModal'); }

async function resetPassword() {
    if (!confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const response = await fetch(`/admin/member/reset-password/${currentMemberId}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
    } catch (error) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
}

async function kickSession() {
    if (!confirm('ì„¸ì…˜ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const response = await fetch(`/admin/member/kick-session/${currentMemberId}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
    } catch (error) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
}

function openModal(id) { document.getElementById(id).classList.add('active'); document.body.style.overflow = 'hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('active'); document.body.style.overflow = ''; }
</script>

<style>
.tab-navigation { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); }
.tab-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; cursor: pointer; font-size: 0.95rem; color: var(--text-secondary); transition: all 0.2s; }
.tab-btn:hover { color: var(--text-primary); background: var(--bg-elevated); }
.tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
.tab-content { min-height: 400px; }
.loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; gap: 1rem; color: var(--text-secondary); }
.spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.stat-card.active { border-left: 3px solid #10b981; }
.stat-card.banned { border-left: 3px solid #ef4444; }
.stat-card.admin { border-left: 3px solid #8b5cf6; }
.badges-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
.badges-section h4 { margin-bottom: 0.75rem; font-size: 0.95rem; }
.badges-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.badge-item { padding: 0.25rem 0.5rem; border: 2px solid; border-radius: 0.5rem; font-size: 0.85rem; }
@media (max-width: 768px) { .tab-btn { flex: 1; justify-content: center; } .tab-text { display: none; } }
</style>
</body>
</html>
