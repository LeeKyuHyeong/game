<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('팬 챌린지 관리')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>팬 챌린지 관리</h1>
        </header>

        <!-- 통계 카드 -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" th:text="${totalCount}">0</div>
                <div class="stat-label">총 기록</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${perfectCount}">0</div>
                <div class="stat-label">퍼펙트 클리어</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${artistCount}">0</div>
                <div class="stat-label">활성 아티스트</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${todayCount}">0</div>
                <div class="stat-label">오늘 도전</div>
            </div>
        </div>

        <div class="search-bar">
            <form action="/admin/fan-challenge" method="get" class="search-form">
                <input type="text" name="keyword" th:value="${keyword}" placeholder="아티스트 검색">
                <select name="difficulty" class="form-select">
                    <option value="">전체 난이도</option>
                    <option value="NORMAL" th:selected="${difficulty == 'NORMAL'}">노말</option>
                    <option value="HARDCORE" th:selected="${difficulty == 'HARDCORE'}">하드코어</option>
                </select>
                <select name="perfect" class="form-select">
                    <option value="">전체 상태</option>
                    <option value="true" th:selected="${perfect == 'true'}">퍼펙트만</option>
                    <option value="false" th:selected="${perfect == 'false'}">미클리어</option>
                </select>
                <button type="submit" class="btn btn-search">검색</button>
                <a th:if="${keyword != null or difficulty != null or perfect != null}" href="/admin/fan-challenge" class="btn btn-reset">초기화</a>
            </form>
        </div>

        <div class="table-container">
            <table class="data-table sortable-table">
                <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="sortable" th:classappend="${sort == 'member.nickname'} ? ('sorted-' + ${direction})"
                        onclick="sortBy('member.nickname')">회원 <span class="sort-icon"></span></th>
                    <th class="sortable" th:classappend="${sort == 'artist'} ? ('sorted-' + ${direction})"
                        onclick="sortBy('artist')">아티스트 <span class="sort-icon"></span></th>
                    <th>난이도</th>
                    <th class="sortable" th:classappend="${sort == 'correctCount'} ? ('sorted-' + ${direction})"
                        onclick="sortBy('correctCount')">정답/전체 <span class="sort-icon"></span></th>
                    <th>퍼펙트</th>
                    <th class="sortable" th:classappend="${sort == 'bestTimeMs'} ? ('sorted-' + ${direction})"
                        onclick="sortBy('bestTimeMs')">최고 시간 <span class="sort-icon"></span></th>
                    <th class="sortable" th:classappend="${sort == 'achievedAt'} ? ('sorted-' + ${direction})"
                        onclick="sortBy('achievedAt')">달성일 <span class="sort-icon"></span></th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="record, iterStat : ${records}" onclick="toggleRowExpand(this)">
                    <td data-label="No" th:text="${currentPage * size + iterStat.index + 1}"></td>
                    <td data-label="회원" th:text="${record.member.nickname}"></td>
                    <td data-label="아티스트" th:text="${record.artist}"></td>
                    <td data-label="난이도">
                        <span class="difficulty-badge" th:classappend="${record.difficulty.name()}"
                              th:text="${record.difficulty.displayName}"></span>
                    </td>
                    <td data-label="정답/전체">
                        <span th:text="${record.correctCount} + '/' + ${record.totalSongs}"></span>
                        <span class="clear-rate" th:text="'(' + ${#numbers.formatDecimal(record.clearRate, 1, 1)} + '%)'"></span>
                    </td>
                    <td data-label="퍼펙트">
                        <span th:if="${record.isPerfectClear}" class="perfect-badge achieved">
                            <span th:if="${record.isCurrentPerfect}" title="현재 시점에서도 유효">✅</span>
                            <span th:unless="${record.isCurrentPerfect}" title="곡 추가로 무효화됨">⭐</span>
                        </span>
                        <span th:unless="${record.isPerfectClear}" class="perfect-badge not-achieved">-</span>
                    </td>
                    <td data-label="최고 시간">
                        <span th:if="${record.bestTimeMs != null}" th:text="${#numbers.formatDecimal(record.bestTimeMs / 1000.0, 1, 1)} + 's'"></span>
                        <span th:unless="${record.bestTimeMs != null}">-</span>
                    </td>
                    <td data-label="달성일" th:text="${record.achievedAt != null} ? ${#temporals.format(record.achievedAt, 'yyyy-MM-dd HH:mm')} : '-'"></td>
                    <td class="action-buttons" data-label="" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-info" th:data-id="${record.id}" onclick="viewDetail(this.dataset.id)">상세</button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(records)}">
                    <td colspan="9" class="empty-row">등록된 기록이 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" th:if="${totalPages > 0}">
            <a th:href="@{/admin/fan-challenge(page=0, keyword=${keyword}, difficulty=${difficulty}, perfect=${perfect}, sort=${sort}, direction=${direction})}"
               th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">«</a>
            <a th:href="@{/admin/fan-challenge(page=${currentPage - 1}, keyword=${keyword}, difficulty=${difficulty}, perfect=${perfect}, sort=${sort}, direction=${direction})}"
               th:classappend="${currentPage == 0} ? 'disabled'" class="page-link">‹</a>

            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${i >= currentPage - 2 and i <= currentPage + 2}"
                   th:href="@{/admin/fan-challenge(page=${i}, keyword=${keyword}, difficulty=${difficulty}, perfect=${perfect}, sort=${sort}, direction=${direction})}"
                   th:text="${i + 1}"
                   th:classappend="${i == currentPage} ? 'active'" class="page-link"></a>
            </th:block>

            <a th:href="@{/admin/fan-challenge(page=${currentPage + 1}, keyword=${keyword}, difficulty=${difficulty}, perfect=${perfect}, sort=${sort}, direction=${direction})}"
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">›</a>
            <a th:href="@{/admin/fan-challenge(page=${totalPages - 1}, keyword=${keyword}, difficulty=${difficulty}, perfect=${perfect}, sort=${sort}, direction=${direction})}"
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link">»</a>
        </div>
    </main>
</div>

<!-- 기록 상세 모달 -->
<div id="detailModal" class="modal">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h2>팬 챌린지 기록 상세</h2>
            <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailContent">
            <!-- 동적으로 채워짐 -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('detailModal')">닫기</button>
        </div>
    </div>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:inline="javascript">
const currentSort = [[${sort}]];
const currentDirection = [[${direction}]];

function toggleRowExpand(row) {
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}

function sortBy(column) {
    const params = new URLSearchParams(window.location.search);
    if (currentSort === column) {
        params.set('direction', currentDirection === 'asc' ? 'desc' : 'asc');
    } else {
        params.set('sort', column);
        params.set('direction', 'desc');
    }
    params.set('page', '0');
    window.location.href = '/admin/fan-challenge?' + params.toString();
}

async function viewDetail(id) {
    try {
        const response = await fetch(`/admin/fan-challenge/detail/${id}`);
        if (!response.ok) {
            throw new Error('기록을 찾을 수 없습니다.');
        }
        const data = await response.json();

        const bestTime = data.bestTimeMs
            ? `${(data.bestTimeMs / 1000).toFixed(1)}초`
            : '-';

        const achievedAt = data.achievedAt
            ? new Date(data.achievedAt).toLocaleString('ko-KR')
            : '-';

        const lastCheckedAt = data.lastCheckedAt
            ? new Date(data.lastCheckedAt).toLocaleString('ko-KR')
            : '-';

        // DOM API를 사용하여 안전하게 요소 생성 (XSS 방지)
        const detailContent = document.getElementById('detailContent');
        detailContent.textContent = '';

        const grid = document.createElement('div');
        grid.className = 'detail-grid';

        // 상세 항목 생성 헬퍼 함수
        function createDetailItem(label, value) {
            const item = document.createElement('div');
            item.className = 'detail-item';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'detail-label';
            labelDiv.textContent = label;

            const valueDiv = document.createElement('div');
            valueDiv.className = 'detail-value';
            valueDiv.textContent = value;

            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            return item;
        }

        // 퍼펙트 상태 항목 생성 (HTML 구조 필요)
        function createPerfectStatusItem() {
            const item = document.createElement('div');
            item.className = 'detail-item';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'detail-label';
            labelDiv.textContent = '퍼펙트 상태';

            const valueDiv = document.createElement('div');
            valueDiv.className = 'detail-value';

            const statusSpan = document.createElement('span');
            statusSpan.className = 'perfect-status';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'perfect-icon';

            const textSpan = document.createElement('span');
            textSpan.className = 'perfect-text';

            if (data.isPerfectClear) {
                if (data.isCurrentPerfect) {
                    iconSpan.textContent = '✅';
                    textSpan.classList.add('valid');
                    textSpan.textContent = '현재 유효한 퍼펙트';
                } else {
                    iconSpan.textContent = '⭐';
                    textSpan.classList.add('invalid');
                    textSpan.textContent = '곡 추가로 무효화됨';
                }
            } else {
                iconSpan.textContent = '-';
                textSpan.textContent = '미달성';
            }

            statusSpan.appendChild(iconSpan);
            statusSpan.appendChild(textSpan);
            valueDiv.appendChild(statusSpan);

            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            return item;
        }

        // 각 항목 추가
        grid.appendChild(createDetailItem('회원', data.memberNickname));
        grid.appendChild(createDetailItem('이메일', data.memberEmail));
        grid.appendChild(createDetailItem('아티스트', data.artist));
        grid.appendChild(createDetailItem('난이도', data.difficultyDisplayName));
        grid.appendChild(createDetailItem('달성 시점 정답/전체', `${data.correctCount}/${data.totalSongs} (${data.clearRate}%)`));
        grid.appendChild(createDetailItem('현재 시점 정답/전체', `${data.correctCount}/${data.currentSongCount} (${data.currentClearRate}%)`));
        grid.appendChild(createPerfectStatusItem());
        grid.appendChild(createDetailItem('최고 클리어 시간', bestTime));
        grid.appendChild(createDetailItem('달성일', achievedAt));
        grid.appendChild(createDetailItem('마지막 검사일', lastCheckedAt));

        detailContent.appendChild(grid);

        openModal('detailModal');
    } catch (error) {
        showToast('기록을 불러오는데 실패했습니다.', 'error');
    }
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
}
</script>
</body>
</html>
