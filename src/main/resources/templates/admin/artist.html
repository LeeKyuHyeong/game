<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('ì•„í‹°ìŠ¤íŠ¸ ê´€ë¦¬')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<link rel="stylesheet" th:href="@{/css/admin/form.css}">
<style>
    .merge-section {
        background: var(--bg-surface);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }
    .merge-section h3 {
        margin-bottom: 1rem;
        color: var(--text-primary);
    }
    .merge-form {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    .merge-form .form-group {
        flex: 1;
        min-width: 200px;
    }
    .merge-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
    }
    .merge-form input, .merge-form select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--bg-base);
        color: var(--text-primary);
    }
    .merge-form input:focus, .merge-form select:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    .merge-arrow {
        font-size: 1.5rem;
        color: var(--text-muted);
        padding-bottom: 0.5rem;
    }
    .merge-btn {
        padding: 0.75rem 1.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        white-space: nowrap;
    }
    .merge-btn:hover {
        background: var(--primary-hover);
    }
    .merge-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .duplicate-section {
        background: var(--bg-surface);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--warning-color);
    }
    .duplicate-section h3 {
        color: var(--warning-color);
        margin-bottom: 1rem;
    }
    .duplicate-group {
        background: var(--bg-elevated);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    .duplicate-group-header {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    .duplicate-item {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--bg-surface);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        margin: 0.25rem;
        font-size: 0.875rem;
    }
    .duplicate-item .count {
        color: var(--text-muted);
        font-size: 0.75rem;
    }
    .quick-merge-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .artist-table {
        width: 100%;
        border-collapse: collapse;
    }
    .artist-table th, .artist-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    .artist-table th {
        background: var(--bg-elevated);
        font-weight: 600;
        color: var(--text-secondary);
    }
    .artist-table tr:hover {
        background: var(--bg-elevated);
    }
    .artist-name {
        font-weight: 500;
        color: var(--text-primary);
    }
    .song-count {
        color: var(--text-secondary);
    }
    .select-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
        cursor: pointer;
        color: var(--text-primary);
    }
    .select-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .search-box {
        margin-bottom: 1rem;
    }
    .search-box input {
        width: 100%;
        max-width: 400px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--bg-base);
        color: var(--text-primary);
    }

    .result-message {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    .result-message.success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid var(--success-color);
        color: var(--success-color);
    }
    .result-message.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--error-color);
        color: var(--error-color);
    }
    .result-details {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        opacity: 0.9;
    }

    @media (max-width: 768px) {
        .merge-form {
            flex-direction: column;
        }
        .merge-arrow {
            transform: rotate(90deg);
            padding: 0;
        }
    }
</style>
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>ì•„í‹°ìŠ¤íŠ¸ ê´€ë¦¬</h1>
        </header>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" th:text="${totalArtists}">0</div>
                <div class="stat-label">ì „ì²´ ì•„í‹°ìŠ¤íŠ¸</div>
            </div>
        </div>

        <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
        <div id="resultMessage" class="result-message" style="display: none;"></div>

        <!-- ë³‘í•© ì„¹ì…˜ -->
        <div class="merge-section">
            <h3>ğŸ”€ ì•„í‹°ìŠ¤íŠ¸ ë³‘í•©</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                ì¤‘ë³µëœ ì•„í‹°ìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤. ë³€ê²½ ì „ ì•„í‹°ìŠ¤íŠ¸ì˜ ëª¨ë“  ê³¡, íŒ¬ì±Œë¦°ì§€ ê¸°ë¡, ë±ƒì§€ê°€ ìƒˆ ì•„í‹°ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
            </p>
            <form class="merge-form" onsubmit="mergeArtist(event)">
                <div class="form-group">
                    <label for="fromArtist">ë³€ê²½í•  ì•„í‹°ìŠ¤íŠ¸ (ì‚¬ë¼ì§ˆ ì´ë¦„)</label>
                    <input type="text" id="fromArtist" name="fromArtist" placeholder="ì˜ˆ: MC THE MAX" required list="artistListFrom">
                    <datalist id="artistListFrom">
                        <option th:each="artist : ${artists}" th:value="${artist.name}">
                    </datalist>
                </div>
                <div class="merge-arrow">â†’</div>
                <div class="form-group">
                    <label for="toArtist">ìƒˆ ì•„í‹°ìŠ¤íŠ¸ (ëŒ€í‘œëª…)</label>
                    <input type="text" id="toArtist" name="toArtist" placeholder="ì˜ˆ: ì— ì”¨ë”ë§¥ìŠ¤" required list="artistListTo">
                    <datalist id="artistListTo">
                        <option th:each="artist : ${artists}" th:value="${artist.name}">
                    </datalist>
                </div>
                <button type="submit" class="merge-btn" id="mergeBtn">ë³‘í•© ì‹¤í–‰</button>
            </form>
        </div>

        <!-- ì¤‘ë³µ ì˜ì‹¬ ì•„í‹°ìŠ¤íŠ¸ -->
        <div class="duplicate-section" id="duplicateSection">
            <h3>âš ï¸ ì¤‘ë³µ ì˜ì‹¬ ì•„í‹°ìŠ¤íŠ¸</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                ì´ë¦„ì´ ë¹„ìŠ·í•œ ì•„í‹°ìŠ¤íŠ¸ë“¤ì…ë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ë³‘í•© í¼ì— ìë™ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="duplicateList">ë¡œë”© ì¤‘...</div>
        </div>

        <!-- ì•„í‹°ìŠ¤íŠ¸ ëª©ë¡ -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ“‹ ì „ì²´ ì•„í‹°ìŠ¤íŠ¸ ëª©ë¡</h3>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." oninput="filterArtists()">
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table class="artist-table" id="artistTable">
                    <thead>
                        <tr>
                            <th>ì•„í‹°ìŠ¤íŠ¸ëª…</th>
                            <th>ê³¡ ìˆ˜</th>
                            <th>ì„ íƒ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="artist : ${artists}">
                            <td class="artist-name" th:text="${artist.name}">ì•„í‹°ìŠ¤íŠ¸ëª…</td>
                            <td class="song-count" th:text="${artist.count} + 'ê³¡'">0ê³¡</td>
                            <td>
                                <button class="select-btn" th:data-name="${artist.name}"
                                        onclick="selectAsFrom(this.dataset.name)">From</button>
                                <button class="select-btn" th:data-name="${artist.name}"
                                        onclick="selectAsTo(this.dataset.name)">To</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script th:inline="javascript">
    // ì¤‘ë³µ ì˜ì‹¬ ì•„í‹°ìŠ¤íŠ¸ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
        loadDuplicates();
    });

    function loadDuplicates() {
        fetch('/admin/artist/duplicates')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('duplicateList');
                if (data.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">ì¤‘ë³µ ì˜ì‹¬ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '';
                data.forEach(group => {
                    html += '<div class="duplicate-group">';
                    html += '<div class="duplicate-group-header">ê·¸ë£¹ (' + group.count + 'ê°œ)</div>';
                    group.artists.forEach(artist => {
                        html += '<span class="duplicate-item">';
                        html += '<span>' + escapeHtml(artist.name) + '</span>';
                        html += '<span class="count">(' + artist.count + 'ê³¡)</span>';
                        html += '<button class="quick-merge-btn" onclick="selectAsFrom(\'' + escapeJs(artist.name) + '\')">From</button>';
                        html += '</span>';
                    });
                    html += '</div>';
                });
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading duplicates:', error);
                document.getElementById('duplicateList').innerHTML = '<p style="color: var(--error-color);">ë¡œë“œ ì‹¤íŒ¨</p>';
            });
    }

    function selectAsFrom(name) {
        document.getElementById('fromArtist').value = name;
    }

    function selectAsTo(name) {
        document.getElementById('toArtist').value = name;
    }

    function filterArtists() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#artistTable tbody tr');

        rows.forEach(row => {
            const name = row.querySelector('.artist-name').textContent.toLowerCase();
            row.style.display = name.includes(keyword) ? '' : 'none';
        });
    }

    function mergeArtist(event) {
        event.preventDefault();

        const fromArtist = document.getElementById('fromArtist').value.trim();
        const toArtist = document.getElementById('toArtist').value.trim();
        const mergeBtn = document.getElementById('mergeBtn');

        if (!fromArtist || !toArtist) {
            showResult(false, 'ì•„í‹°ìŠ¤íŠ¸ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (fromArtist === toArtist) {
            showResult(false, 'ë™ì¼í•œ ì•„í‹°ìŠ¤íŠ¸ëª…ìœ¼ë¡œëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (!confirm(`'${fromArtist}' â†’ '${toArtist}'ë¡œ ë³‘í•©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            return;
        }

        mergeBtn.disabled = true;
        mergeBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';

        const formData = new FormData();
        formData.append('fromArtist', fromArtist);
        formData.append('toArtist', toArtist);

        fetch('/admin/artist/merge', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let details = `Song: ${data.songCount}ê±´, FanChallenge: ${data.fanChallengeCount}ê±´, Badge: ${data.badgeCount}ê±´`;
                showResult(true, data.message, details);

                // í¼ ì´ˆê¸°í™”
                document.getElementById('fromArtist').value = '';
                document.getElementById('toArtist').value = '';

                // ì¤‘ë³µ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadDuplicates();

                // 3ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => location.reload(), 3000);
            } else {
                showResult(false, data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showResult(false, 'ë³‘í•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            mergeBtn.disabled = false;
            mergeBtn.textContent = 'ë³‘í•© ì‹¤í–‰';
        });
    }

    function showResult(success, message, details) {
        const el = document.getElementById('resultMessage');
        el.className = 'result-message ' + (success ? 'success' : 'error');
        el.innerHTML = '<strong>' + (success ? 'âœ… ' : 'âŒ ') + message + '</strong>';
        if (details) {
            el.innerHTML += '<div class="result-details">' + details + '</div>';
        }
        el.style.display = 'block';

        // ìŠ¤í¬ë¡¤ ì´ë™
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJs(text) {
        return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
</script>
</body>
</html>
