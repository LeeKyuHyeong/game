<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/fragments/head :: adminHead('ë©€í‹°ê²Œì„ ê´€ë¦¬')}"></head>
<body class="admin-page">
<link rel="stylesheet" th:href="@{/css/admin/table-mobile-collapse.css}">
<div class="admin-container">
    <th:block th:replace="~{admin/layout/sidebar :: sidebar}"></th:block>

    <main class="main-content">
        <header class="content-header">
            <h1>ë©€í‹°ê²Œì„ ê´€ë¦¬</h1>
        </header>

        <!-- í†µí•© í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" th:text="${totalRooms}">0</div>
                <div class="stat-label">ì „ì²´ ë°©</div>
            </div>
            <div class="stat-card waiting">
                <div class="stat-value" th:text="${waitingCount}">0</div>
                <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="stat-card playing">
                <div class="stat-value" th:text="${playingCount}">0</div>
                <div class="stat-label">ê²Œì„ ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${totalChats}">0</div>
                <div class="stat-label">ì „ì²´ ì±„íŒ…</div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation">
            <button class="tab-btn" th:classappend="${activeTab == 'room'} ? 'active'"
                    onclick="switchTab('room')">
                <span class="tab-icon">ğŸšª</span>
                <span class="tab-text">ë°© ê´€ë¦¬</span>
                <span class="tab-badge" th:text="${totalRooms}">0</span>
            </button>
            <button class="tab-btn" th:classappend="${activeTab == 'chat'} ? 'active'"
                    onclick="switchTab('chat')">
                <span class="tab-icon">ğŸ’¬</span>
                <span class="tab-text">ì±„íŒ… ë‚´ì—­</span>
                <span class="tab-badge" th:text="${totalChats}">0</span>
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tabContent">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>ë¡œë”© ì¤‘...</span>
            </div>
        </div>
    </main>
</div>

<!-- ë°© ìƒì„¸ ëª¨ë‹¬ -->
<div id="roomDetailModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>ë°© ìƒì„¸ ì •ë³´</h2>
            <button class="close-btn" onclick="closeModal('roomDetailModal')">&times;</button>
        </div>
        <div class="modal-body" id="roomDetailContent">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('roomDetailModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ì±„íŒ… ë‚´ì—­ ëª¨ë‹¬ -->
<div id="chatModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 id="chatModalTitle">ì±„íŒ… ë‚´ì—­</h2>
            <button class="close-btn" onclick="closeModal('chatModal')">&times;</button>
        </div>
        <div class="modal-body" id="chatContent">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="deleteAllChatsBtn" style="display: none;">ì „ì²´ ì‚­ì œ</button>
            <button type="button" class="btn btn-cancel" onclick="closeModal('chatModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script th:src="@{/js/common/common.js}"></script>
<script th:inline="javascript">
const activeTab = [[${activeTab}]];
let currentTab = activeTab;
let currentRoomId = null;

// ì´ˆê¸° ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    loadTabContent(currentTab);
});

function switchTab(tab) {
    if (currentTab === tab) return;

    currentTab = tab;

    // URL ì—…ë°ì´íŠ¸
    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);

    // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn:nth-child(${tab === 'room' ? 1 : 2})`).classList.add('active');

    // ì½˜í…ì¸  ë¡œë“œ
    loadTabContent(tab);
}

async function loadTabContent(tab, params = '') {
    const tabContent = document.getElementById('tabContent');
    tabContent.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>ë¡œë”© ì¤‘...</span>
        </div>
    `;

    try {
        const url = tab === 'room'
            ? `/admin/room/content${params ? '?' + params : ''}`
            : `/admin/chat/content${params ? '?' + params : ''}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load content');

        const html = await response.text();
        tabContent.innerHTML = html;

        // ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™”
        initTabScripts();
    } catch (error) {
        tabContent.innerHTML = `
            <div class="error-message">
                <p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="loadTabContent('${tab}')">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    }
}

function initTabScripts() {
    // ê²€ìƒ‰ í¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const searchForm = document.querySelector('.tab-content .search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(searchForm);
            const params = new URLSearchParams(formData).toString();
            loadTabContent(currentTab, params);
        });
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    const resetBtn = document.querySelector('.tab-content .btn-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadTabContent(currentTab);
        });
    }
}

function toggleRowExpand(row) {
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}

function goToPage(page) {
    const params = new URLSearchParams();
    const form = document.querySelector('.tab-content .search-form');
    if (form) {
        new FormData(form).forEach((value, key) => {
            if (value) params.set(key, value);
        });
    }
    params.set('page', page);
    loadTabContent(currentTab, params.toString());
}

// ë°© ê´€ë ¨ í•¨ìˆ˜
async function viewRoomDetail(id) {
    try {
        const response = await fetch(`/admin/room/detail/${id}`);
        if (!response.ok) throw new Error('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const data = await response.json();
        currentRoomId = id;

        const content = document.getElementById('roomDetailContent');
        content.innerHTML = '';

        const grid = document.createElement('div');
        grid.className = 'detail-grid';

        function createItem(label, value) {
            const item = document.createElement('div');
            item.className = 'detail-item';
            item.innerHTML = `<div class="detail-label">${label}</div><div class="detail-value">${value}</div>`;
            return item;
        }

        grid.appendChild(createItem('ë°© ì½”ë“œ', data.roomCode));
        grid.appendChild(createItem('ë°© ì´ë¦„', data.roomName));
        grid.appendChild(createItem('ë°©ì¥', data.hostNickname));
        grid.appendChild(createItem('ìƒíƒœ', getStatusBadge(data.status)));
        grid.appendChild(createItem('ì¸ì›', `${data.currentPlayers}/${data.maxPlayers}`));
        grid.appendChild(createItem('ë¼ìš´ë“œ', `${data.currentRound}/${data.totalRounds}`));
        grid.appendChild(createItem('ë¹„ê³µê°œ', data.isPrivate ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'));
        grid.appendChild(createItem('ìƒì„±ì¼', new Date(data.createdAt).toLocaleString('ko-KR')));

        // ì°¸ê°€ì ëª©ë¡
        if (data.participants && data.participants.length > 0) {
            const participantsDiv = document.createElement('div');
            participantsDiv.className = 'detail-item full-width';
            participantsDiv.innerHTML = '<div class="detail-label">ì°¸ê°€ì</div>';

            const participantsList = document.createElement('div');
            participantsList.className = 'participants-list';

            data.participants.forEach(p => {
                const pItem = document.createElement('div');
                pItem.className = 'participant-item';
                pItem.innerHTML = `
                    <span class="participant-name">${escapeHtml(p.nickname)}</span>
                    <span class="participant-score">${p.score}ì </span>
                    <span class="participant-status ${p.isReady ? 'ready' : ''}">${p.isReady ? 'ì¤€ë¹„ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘'}</span>
                `;
                participantsList.appendChild(pItem);
            });

            participantsDiv.appendChild(participantsList);
            grid.appendChild(participantsDiv);
        }

        content.appendChild(grid);

        // ì•¡ì…˜ ë²„íŠ¼
        const actions = document.createElement('div');
        actions.className = 'detail-actions';
        actions.innerHTML = `
            <button class="btn btn-info" onclick="viewRoomChats(${id})">ì±„íŒ… ë³´ê¸°</button>
            ${data.status !== 'FINISHED' ? `<button class="btn btn-warning" onclick="closeRoom(${id})">ë°© ì¢…ë£Œ</button>` : ''}
            <button class="btn btn-danger" onclick="deleteRoom(${id})">ë°© ì‚­ì œ</button>
        `;
        content.appendChild(actions);

        openModal('roomDetailModal');
    } catch (error) {
        showToast('ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function getStatusBadge(status) {
    const badges = {
        'WAITING': '<span class="status-badge waiting">ëŒ€ê¸°ì¤‘</span>',
        'PLAYING': '<span class="status-badge playing">ê²Œì„ì¤‘</span>',
        'FINISHED': '<span class="status-badge finished">ì¢…ë£Œ</span>'
    };
    return badges[status] || status;
}

async function closeRoom(id) {
    if (!confirm('ì´ ë°©ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch(`/admin/room/close/${id}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal('roomDetailModal');
            loadTabContent('room');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ë°© ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function deleteRoom(id) {
    if (!confirm('ì´ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì±„íŒ… ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

    try {
        const response = await fetch(`/admin/room/delete/${id}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal('roomDetailModal');
            loadTabContent('room');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function viewRoomChats(id) {
    try {
        const response = await fetch(`/admin/room/chat/${id}`);
        const result = await response.json();

        if (!result.success) throw new Error(result.message);

        currentRoomId = id;
        document.getElementById('chatModalTitle').textContent = `ì±„íŒ… ë‚´ì—­ - ${result.roomName} (${result.roomCode})`;

        const content = document.getElementById('chatContent');
        content.innerHTML = '';

        if (result.chats.length === 0) {
            content.innerHTML = '<div class="empty-message">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            const chatList = document.createElement('div');
            chatList.className = 'chat-list';

            result.chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.messageType.toLowerCase()}`;
                chatItem.innerHTML = `
                    <div class="chat-header">
                        <span class="chat-nickname">${escapeHtml(chat.nickname)}</span>
                        <span class="chat-time">${new Date(chat.createdAt).toLocaleString('ko-KR')}</span>
                        <button class="btn btn-sm btn-danger" onclick="deleteChat(${chat.id}, event)">ì‚­ì œ</button>
                    </div>
                    <div class="chat-message">${escapeHtml(chat.message)}</div>
                `;
                chatList.appendChild(chatItem);
            });

            content.appendChild(chatList);

            // ì „ì²´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            document.getElementById('deleteAllChatsBtn').style.display = 'inline-block';
            document.getElementById('deleteAllChatsBtn').onclick = () => deleteAllChats(id);
        }

        closeModal('roomDetailModal');
        openModal('chatModal');
    } catch (error) {
        showToast('ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function deleteChat(chatId, event) {
    event.stopPropagation();
    if (!confirm('ì´ ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch(`/admin/room/chat/delete/${chatId}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast('ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            if (currentRoomId) viewRoomChats(currentRoomId);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì±„íŒ… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function deleteAllChats(roomId) {
    if (!confirm('ì´ ë°©ì˜ ëª¨ë“  ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch(`/admin/room/chat/delete-all/${roomId}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast('ëª¨ë“  ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal('chatModal');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì±„íŒ… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ì±„íŒ… ì‚­ì œ (ì±„íŒ… íƒ­ì—ì„œ)
async function deleteChatFromList(chatId) {
    if (!confirm('ì´ ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch(`/admin/chat/delete/${chatId}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast('ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            loadTabContent('chat');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('ì±„íŒ… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
    if (modalId === 'chatModal') {
        document.getElementById('deleteAllChatsBtn').style.display = 'none';
    }
}
</script>

<style>
/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
.tab-navigation {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-elevated);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 600;
}

.tab-icon {
    font-size: 1.1rem;
}

.tab-badge {
    background: var(--bg-elevated);
    padding: 0.15rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.tab-btn.active .tab-badge {
    background: var(--primary-color);
    color: white;
}

/* íƒ­ ì½˜í…ì¸  */
.tab-content {
    min-height: 400px;
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    gap: 1rem;
    color: var(--text-secondary);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* í†µê³„ ì¹´ë“œ ìƒ‰ìƒ */
.stat-card.waiting {
    border-left: 3px solid #f59e0b;
}

.stat-card.playing {
    border-left: 3px solid #10b981;
}

/* ìƒíƒœ ë°°ì§€ */
.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-badge.waiting {
    background: #fef3c7;
    color: #92400e;
}

.status-badge.playing {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.finished {
    background: #e5e7eb;
    color: #374151;
}

/* ì°¸ê°€ì ëª©ë¡ */
.participants-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.participant-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    background: var(--bg-elevated);
    border-radius: 0.25rem;
}

.participant-name {
    font-weight: 500;
    flex: 1;
}

.participant-score {
    color: var(--primary-color);
    font-weight: 600;
}

.participant-status {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.participant-status.ready {
    color: #10b981;
}

/* ìƒì„¸ ì•¡ì…˜ */
.detail-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

/* ì±„íŒ… ëª©ë¡ */
.chat-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 60vh;
    overflow-y: auto;
}

.chat-item {
    padding: 0.75rem;
    background: var(--bg-elevated);
    border-radius: 0.5rem;
    border-left: 3px solid var(--border-color);
}

.chat-item.answer {
    border-left-color: #10b981;
}

.chat-item.correct {
    border-left-color: #f59e0b;
    background: #fef3c7;
}

.chat-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.chat-nickname {
    font-weight: 600;
}

.chat-time {
    font-size: 0.8rem;
    color: var(--text-secondary);
    flex: 1;
}

.chat-message {
    color: var(--text-primary);
}

.empty-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .tab-navigation {
        flex-wrap: wrap;
    }

    .tab-btn {
        flex: 1;
        justify-content: center;
        min-width: 120px;
    }

    .tab-text {
        display: none;
    }

    .tab-icon {
        font-size: 1.3rem;
    }

    .detail-actions {
        flex-wrap: wrap;
    }

    .detail-actions .btn {
        flex: 1;
        min-width: calc(50% - 0.25rem);
    }
}
</style>
</body>
</html>
