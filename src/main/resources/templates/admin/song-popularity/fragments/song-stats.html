<!-- 곡별 통계 탭 콘텐츠 (프래그먼트) -->
<div class="popularity-tab-content" xmlns:th="http://www.thymeleaf.org">
    <!-- 서브 통계 -->
    <div class="sub-stats">
        <div class="sub-stat">
            <span class="sub-stat-value" th:text="${totalItems}">0</span>
            <span class="sub-stat-label">곡 수</span>
        </div>
    </div>

    <!-- 검색 -->
    <div class="search-bar">
        <form class="search-form">
            <input type="text" name="keyword" th:value="${keyword}" placeholder="곡명/아티스트 검색">
            <button type="submit" class="btn btn-search">검색</button>
            <a th:if="${keyword != null}" href="#" class="btn btn-reset" onclick="resetSearch()">초기화</a>
        </form>
    </div>

    <!-- 테이블 -->
    <div class="table-container">
        <table class="data-table sortable-table">
            <thead>
            <tr>
                <th class="col-no">No</th>
                <th class="sortable" th:classappend="${sort == 'title'} ? ('sorted-' + ${direction})"
                    data-sort="title">곡명 <span class="sort-icon"></span></th>
                <th class="sortable" th:classappend="${sort == 'artist'} ? ('sorted-' + ${direction})"
                    data-sort="artist">아티스트 <span class="sort-icon"></span></th>
                <th class="sortable" th:classappend="${sort == 'avgRating'} ? ('sorted-' + ${direction})"
                    data-sort="avgRating">평균 평점 <span class="sort-icon"></span></th>
                <th class="sortable" th:classappend="${sort == 'voteCount'} ? ('sorted-' + ${direction})"
                    data-sort="voteCount">투표 수 <span class="sort-icon"></span></th>
                <th>분포</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="stat, iterStat : ${songStats}" onclick="toggleRowExpand(this)">
                <td data-label="No" th:text="${currentPage * size + iterStat.index + 1}"></td>
                <td data-label="곡명" th:text="${stat.title}"></td>
                <td data-label="아티스트" th:text="${stat.artist}"></td>
                <td data-label="평균 평점">
                    <div class="rating-display">
                        <span class="rating-stars" th:attr="data-rating=${stat.avgRating}">
                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                  th:classappend="${i <= stat.avgRating} ? 'filled' : 'empty'"
                                  class="star">★</span>
                        </span>
                        <span class="rating-value" th:text="${#numbers.formatDecimal(stat.avgRating, 1, 1)}"></span>
                    </div>
                </td>
                <td data-label="투표 수" th:text="${stat.voteCount}"></td>
                <td data-label="분포" class="distribution-cell">
                    <div class="rating-distribution">
                        <span class="dist-bar r1" th:style="'width:' + ${stat.voteCount > 0 ? (stat.rating1 * 100 / stat.voteCount) : 0} + '%'"
                              th:title="'매우 대중적: ' + ${stat.rating1}"></span>
                        <span class="dist-bar r2" th:style="'width:' + ${stat.voteCount > 0 ? (stat.rating2 * 100 / stat.voteCount) : 0} + '%'"
                              th:title="'대중적: ' + ${stat.rating2}"></span>
                        <span class="dist-bar r3" th:style="'width:' + ${stat.voteCount > 0 ? (stat.rating3 * 100 / stat.voteCount) : 0} + '%'"
                              th:title="'보통: ' + ${stat.rating3}"></span>
                        <span class="dist-bar r4" th:style="'width:' + ${stat.voteCount > 0 ? (stat.rating4 * 100 / stat.voteCount) : 0} + '%'"
                              th:title="'매니악: ' + ${stat.rating4}"></span>
                        <span class="dist-bar r5" th:style="'width:' + ${stat.voteCount > 0 ? (stat.rating5 * 100 / stat.voteCount) : 0} + '%'"
                              th:title="'매우 매니악: ' + ${stat.rating5}"></span>
                    </div>
                </td>
                <td class="action-buttons" data-label="" onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-info"
                            th:data-song-id="${stat.songId}"
                            th:data-title="${stat.title}"
                            th:data-artist="${stat.artist}"
                            onclick="viewSongDetail(this)">상세</button>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(songStats)}">
                <td colspan="7" class="empty-row">투표 데이터가 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <div class="pagination" th:if="${totalPages > 0}">
        <a href="#" th:classappend="${currentPage == 0} ? 'disabled'" class="page-link"
           th:onclick="'goToPage(0); return false;'">«</a>
        <a href="#" th:classappend="${currentPage == 0} ? 'disabled'" class="page-link"
           th:onclick="'goToPage(' + ${currentPage - 1} + '); return false;'">‹</a>

        <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
            <a th:if="${i >= currentPage - 2 and i <= currentPage + 2}"
               href="#" th:text="${i + 1}"
               th:classappend="${i == currentPage} ? 'active'" class="page-link"
               th:onclick="'goToPage(' + ${i} + '); return false;'"></a>
        </th:block>

        <a href="#" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link"
           th:onclick="'goToPage(' + ${currentPage + 1} + '); return false;'">›</a>
        <a href="#" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'" class="page-link"
           th:onclick="'goToPage(' + ${totalPages - 1} + '); return false;'">»</a>
    </div>
</div>
