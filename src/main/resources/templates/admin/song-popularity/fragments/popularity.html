<!-- 대중성 투표 탭 콘텐츠 (AJAX 로딩용) -->
<!-- CSS는 부모 페이지(content/index.html)에서 로드됨 -->
<div class="tab-panel popularity-panel" xmlns:th="http://www.thymeleaf.org">
    <!-- 서브탭 네비게이션 -->
    <div class="sub-tab-navigation">
        <button class="sub-tab-btn" th:classappend="${activeSubTab == 'songs'} ? 'active'"
                data-subtab="songs" onclick="loadPopularitySubTab('songs')">
            곡별 통계
        </button>
        <button class="sub-tab-btn" th:classappend="${activeSubTab == 'artists'} ? 'active'"
                data-subtab="artists" onclick="loadPopularitySubTab('artists')">
            아티스트별 통계
        </button>
        <button class="sub-tab-btn" th:classappend="${activeSubTab == 'votes'} ? 'active'"
                data-subtab="votes" onclick="loadPopularitySubTab('votes')">
            투표 내역
        </button>
    </div>

    <!-- 서브탭 콘텐츠 -->
    <div class="sub-tab-content" id="popularitySubTabContent">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>로딩 중...</span>
        </div>
    </div>

    <script th:inline="javascript">
    var popularityActiveSubTab = /*[[${activeSubTab}]]*/ 'songs';

    function loadPopularitySubTab(subTab, params) {
        popularityActiveSubTab = subTab;

        // 서브탭 버튼 활성화 상태 변경 (null 체크 포함)
        document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector('[data-subtab="' + subTab + '"]');
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        const container = document.getElementById('popularitySubTabContent');
        if (!container) {
            // 컨테이너가 없으면 (탭 전환 중 호출된 경우) 무시
            return;
        }
        container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>로딩 중...</span></div>';

        let url = '/admin/song-popularity/' + subTab + '/content';
        if (params) {
            url += '?' + params;
        }

        fetch(url)
            .then(response => response.text())
            .then(html => {
                // 비동기 완료 시점에 컨테이너가 여전히 존재하는지 확인
                const targetContainer = document.getElementById('popularitySubTabContent');
                if (targetContainer) {
                    targetContainer.innerHTML = html;
                    initPopularitySearchForm();
                }
            })
            .catch(error => {
                const targetContainer = document.getElementById('popularitySubTabContent');
                if (targetContainer) {
                    targetContainer.innerHTML = '<div class="error-message">콘텐츠를 불러오는데 실패했습니다.</div>';
                }
                console.error('Error loading sub tab:', error);
            });
    }

    // 검색 폼 이벤트 초기화
    function initPopularitySearchForm() {
        const searchForm = document.querySelector('#popularitySubTabContent .search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(searchForm);
                const params = new URLSearchParams(formData).toString();
                loadPopularitySubTab(popularityActiveSubTab, params);
            });
        }

        // 초기화 버튼
        const resetBtn = document.querySelector('#popularitySubTabContent .btn-reset');
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                loadPopularitySubTab(popularityActiveSubTab);
            });
        }
    }

    // 초기 로드 - AJAX 동적 로드이므로 바로 실행
    loadPopularitySubTab(popularityActiveSubTab);
    </script>
</div>
